---
title: "Body size trends in fossil tortoises"
output:
  pdf_document: default
  html_notebook: default
  html_document: default
always_allow_html: yes
---

```{r "setup", include=FALSE}
require("knitr")
#opts_knit$set(root.dir = "//naturkundemuseum-berlin.de/MuseumDFSRoot/Benutzer/Julia.Joos/Eigene Dateien/MA")
## on laptop: 
opts_knit$set(root.dir = "C:/Users/Jule/Documents/Uni/MA")
library(dplyr)
library(ggplot2)
```

```{r "Zotero references", include=FALSE}
#require(RefManageR)
#biblio <- ReadZotero(user = '4138123', .params = list(collection = 'NPV27KD5'))
#Zotero ID 4138123
#collection ID NPV27KD5
```


```{r "import data set", echo=FALSE}
#### Data basis - import data set from Excel ####
#setwd("//naturkundemuseum-berlin.de/MuseumDFSRoot/Benutzer/Julia.Joos/Eigene Dateien/MA")
setwd("C:/Users/Jule/Documents/Uni/MA")
tidyCL<-read.csv("tortoises_tidy.csv", sep=";", header=TRUE)

#####prepare for analysis (fix column names in .csv-file after converting table from excel####
colnames(tidyCL)[6] <- "MAmin"
colnames(tidyCL)[7] <- "Mamax"
colnames(tidyCL)[17] <- "CL"
colnames(tidyCL)[18] <- "PL"
colnames(tidyCL)[21] <- "estimated"

tidyCL <-  tidyCL %>%
  mutate(Age= ((as.numeric(as.character(MAmin)))+(as.numeric(as.character(Mamax))))/2) %>%
  mutate(PL=as.numeric(as.character(PL)))

####### import extant data ####
extant <- read.csv("MFN_testudinidae.csv", sep=";", header=TRUE, dec=".", na.strings = "NA", stringsAsFactors=FALSE)  # file: MFN_testudinidae.csv

colnames(extant)[4] <- "SCL"
colnames(extant)[10] <- "PL"
colnames(extant)[11] <- "PLmid"


Extant <- extant %>%
  mutate(CL = SCL * 10, PL=PL*10, PLmid=PLmid*10) 
```



## paleoTS Plot with the following bins (for fossil taxa):

```{r echo=FALSE, results='asis'}
CLPLtidy <- tidyCL %>%
  filter(!is.na(CL) & !is.na(PL)) %>%
  dplyr::select(Taxon, CL, PL, size, Age, Island, Continent) %>%
  mutate(ratio=CL/PL) %>%
  group_by(Taxon) %>% #to show ratios per Taxon, leave out to get a total ratio
  summarise(meanRatio=round(mean(ratio),2), sdRatio=round(sd(ratio),2), n=n(), min=min(ratio), max=max(ratio))

CLPLextant <- Extant %>%
  filter(!is.na(CL) & !is.na(PL)) %>%
  dplyr::select(Taxon=Species, CL, PL, PLmid, Island, Continent) %>%
  mutate(ratio=CL/PL, ratioMid=CL/PLmid)
  #group_by(Taxon) %>% #to show ratios per Taxon, leave out to get a total ratio
  #  summarise(meanRatio=round(mean(ratio),2), sdRatio=round(sd(ratio),2), n=n(), min=min(ratio), max=max(ratio))

Ratio <- CLPLextant %>%
  summarise(meanRatio=round(mean(ratio),2), sdRatio=round(sd(ratio),2), n=n(), min=min(ratio), max=max(ratio))

RatioSpecies <- CLPLextant %>%
  group_by(Taxon) %>% #to show ratios per Taxon, leave out to get a total ratio
  summarise(meanRatio=round(mean(ratio),2), sdRatio=round(sd(ratio),2), n=n(), min=min(ratio), max=max(ratio))


fossil <- tidyCL %>%
  dplyr::select(Taxon, CL, PL, size, estimated, Age, Island, Continent)
  
modern <- Extant %>%
  dplyr::select(Taxon=Species, CL, PL, estimated, Age, Island, Continent)

All <- bind_rows(modern, fossil)

testRatio <- All %>% #tidyCL
  dplyr::select(Taxon, CL, PL, size, estimated, Age, Island, Continent) %>%
  mutate(extraCL = PL*Ratio$meanRatio) %>%
  dplyr::select(Taxon, CL, extraCL, PL, size, estimated, Age, Island, Continent)

testRatio$CL[is.na(testRatio$CL)] <- testRatio$extraCL[is.na(testRatio$CL)]

######

PleiPlio <- testRatio %>% #testRatio or tidyCL 
  filter(Age < 11.000)

PleiPlio$bin <- cut(PleiPlio$Age, c(0, 0.000001, 0.0117, 0.126, 0.781, 2.588, 3.6, 5.332, 11.608))

EpochBins <- as.vector(c("Modern", "Holocene", "Upper Pleistocene", "Middle Pleistocene", "Lower Pleistocene", "Upper Pliocene", "Lower Pliocene", "Upper Miocene"))

MeanBins <- as.vector(c((0+0.000001)/2, (0+0.0117)/2, (0.0117+0.126)/2, (0.126+0.781)/2, (0.781+2.588)/2,
              (2.588+3.6)/2, (3.6+5.332)/2, (5.332+11.608)/2))

Bins <- PleiPlio %>%
  select(bin) %>%
  group_by(bin) %>%
  summarise(n=n())

bin <- as.vector(unique(Bins$bin))

BINS <- data.frame(bin, EpochBins, MeanBins) #

kable(Bins)
kable(BINS)

PleiPlioCL <- PleiPlio %>%
  merge(BINS)

#length(PleiPlioCL$CL)


PPCL <- PleiPlioCL %>%
  dplyr::select(CL, MeanBins) %>%
  dplyr::filter(CL != "NA") %>%
  mutate(tt= MeanBins) %>% # create mean age
  group_by(tt) %>% #create time bins
  summarise(mm=mean(CL), vv=var(CL), nn=n()) #create means etc. for each time bin 

PPCL[is.na(PPCL)]<-0 #subset NAs with O for n=1


# ExTort <- extant %>%
#   mutate(CL = SCL * 10) %>%
#   dplyr::select(CL) %>%
#   summarise(mm=mean(CL), nn=n(), vv=var(CL), tt=0) %>%
#   dplyr::select(mm, nn, vv, tt)
# 
# ExTort[is.na(ExTort)] <- 0 #subset NAs with O for n=1

sumTort <- read.csv("tortoises_summary.csv", sep=";", header=TRUE)

SumTort <- sumTort %>%
  mutate(tt=(Mamin+Mamax)/2, vv=sdCLmm^2, nn=n, mm=meanCLmm) %>%
  dplyr::select(mm, nn, vv, tt)
 
PPESCL <- bind_rows(SumTort,PPCL) #ExTort, 

combiCL <- PPESCL %>%
  dplyr::filter(tt==0.0000005) %>%   #maybe find a way to automatically filter double tt values...
  mutate(nx = nn*mm) %>%
  mutate(mmall=sum(nx)/sum(nn)) %>%
  mutate(SD=sqrt(nx), d=mm-mmall) %>%
  mutate(nsd=((nx^2+d^2)*nn)) %>%
  mutate(varall=sum(nsd)/sum(nn), n=sum(nn)) %>%
  dplyr::select(mm=mmall, vv=varall, nn=n, tt) %>%
  unique() %>%
  dplyr::select(mm, nn, vv, tt)


PPCL <- PPESCL %>%
  filter(tt !=0.0000005) %>%
  bind_rows(combiCL)%>%
  arrange(tt)

```


## including Island species  (n=`r sum(PPCL$nn)`)


paleoTS object (mm= mean CL, nn = sample size, vv = variance (CL), tt = Age):
```{r echo=FALSE}

kable(PPCL)
```


```{r echo=FALSE}
library(paleoTS)
paleoPPCL <-as.paleoTS(PPCL$mm, PPCL$vv, PPCL$nn, PPCL$tt, MM = NULL, genpars = NULL, label = "Testudinidae body size evolution mode, Holocene-Upper Miocene, CL, including Island species")
#paleoPPCL
plot(paleoPPCL)


```

```{r echo=FALSE}

kable(fit3models(paleoPPCL, silent=FALSE, method="AD", pool=FALSE))
```




```{r echo=FALSE}
PPCL2 <- PleiPlioCL %>%
  dplyr::filter(CL != "NA") %>% 
  dplyr::filter(Island == "n") %>%
  dplyr::select(CL, MeanBins) %>%
  mutate(tt= MeanBins) %>% # create mean age
  group_by(tt) %>% #create time bins
  summarise(mm=mean(CL), vv=var(CL), nn=n()) #create means etc. for each time bin 

PPCL2[is.na(PPCL2)]<-0 #subset NAs with O for n=1

# ExTortIs <- extant %>%
#   mutate(CL = SCL * 10) %>%
#   dplyr::filter(Island != "y") %>%
#   dplyr::select(CL) %>%
#   summarise(mm=mean(CL), nn=n(), vv=var(CL), tt=0.0000005) %>%
#   dplyr::select(mm, nn, vv, tt)
# 
# ExTortIs[is.na(ExTortIs)] <- 0 #subset NAs with O for n=1

sumTort <- read.csv("tortoises_summary.csv", sep=";", header=TRUE)

SumTort <- sumTort %>%
  filter(Island == "n") %>%
  mutate(tt=(Mamin+Mamax)/2, vv=sdCLmm^2, nn=n, mm=meanCLmm) %>%
  dplyr::select(mm, nn, vv, tt)
 
PPECL <- bind_rows(SumTort,PPCL2) #ExTort, 

#PPECL <- bind_rows(ExTortIs, PPCL)

# PPECL <- PPECL %>%
#   arrange(tt)

combiCL <- PPECL %>%
  dplyr::filter(tt==0.0000005) %>%   #maybe find a way to automatically filter double tt values...
  mutate(nx = nn*mm) %>%
  mutate(mmall=sum(nx)/sum(nn)) %>%
  mutate(SD=sqrt(nx), d=mm-mmall) %>%
  mutate(nsd=((nx^2+d^2)*nn)) %>%
  mutate(varall=sum(nsd)/sum(nn), n=sum(nn)) %>%
  dplyr::select(mm=mmall, vv=varall, nn=n, tt) %>%
  unique() %>%
  dplyr::select(mm, nn, vv, tt)


PPECL <- PPECL %>%
  filter(tt !=0.0000005) %>%
  bind_rows(combiCL)%>%
#  select(tt, mm, vv, nn) %>%
  arrange(tt)


```

## Excluding Island species (n= `r sum(PPECL$nn)`)

```{r echo=FALSE}
kable(PPECL)
```


```{r echo=FALSE}
paleoPPECL <-as.paleoTS(PPECL$mm, PPECL$vv, PPECL$nn, PPECL$tt, MM = NULL, genpars = NULL, label = "Testudinidae body size evolution mode, Holocene-Upper Miocene, CL, without Island species", reset.time=TRUE)
#paleoPPECL
plot(paleoPPECL)

```

```{r echo=FALSE}

kable(fit3models(paleoPPECL, silent=FALSE, method="AD", pool=FALSE))

```

# Only Island species

```{r echo=FALSE}
PPCL <- PleiPlioCL %>%
  dplyr::filter(CL != "NA") %>% 
  dplyr::filter(Island != "n") %>%
  dplyr::select(CL, MeanBins) %>%
  mutate(tt= MeanBins) %>% # create mean age
  group_by(tt) %>% #create time bins
  summarise(mm=mean(CL), vv=var(CL), nn=n()) #create means etc. for each time bin 

PPCL[is.na(PPCL)]<-0 #subset NAs with O for n=1

# ExTortIs <- extant %>%
#   mutate(CL = SCL * 10) %>%
#   dplyr::filter(Island != "y") %>%
#   dplyr::select(CL) %>%
#   summarise(mm=mean(CL), nn=n(), vv=var(CL), tt=0.0000005) %>%
#   dplyr::select(mm, nn, vv, tt)
# 
# ExTortIs[is.na(ExTortIs)] <- 0 #subset NAs with O for n=1

sumTort <- read.csv("tortoises_summary.csv", sep=";", header=TRUE)

SumTort <- sumTort %>%
  filter(Island == "n") %>%
  mutate(tt=(Mamin+Mamax)/2, vv=sdCLmm^2, nn=n, mm=meanCLmm) %>%
  dplyr::select(mm, nn, vv, tt)
 
PPECL <- bind_rows(SumTort,PPCL) #ExTort, 

#PPECL <- bind_rows(ExTortIs, PPCL)

# PPECL <- PPECL %>%
#   arrange(tt)

combiCL <- PPECL %>%
  dplyr::filter(tt==0.0000005) %>%   #maybe find a way to automatically filter double tt values...
  mutate(nx = nn*mm) %>%
  mutate(mmall=sum(nx)/sum(nn)) %>%
  mutate(SD=sqrt(nx), d=mm-mmall) %>%
  mutate(nsd=((nx^2+d^2)*nn)) %>%
  mutate(varall=sum(nsd)/sum(nn), n=sum(nn)) %>%
  dplyr::select(mm=mmall, vv=varall, nn=n, tt) %>%
  unique() %>%
  dplyr::select(mm, nn, vv, tt)


PPECL <- PPECL %>%
  filter(tt !=0.0000005) %>%
  bind_rows(combiCL)%>%
  arrange(tt)


```

```{r echo=FALSE}
kable(PPECL)
```

```{r echo=FALSE}
paleoPPECL <-as.paleoTS(PPECL$mm, PPECL$vv, PPECL$nn, PPECL$tt, MM = NULL, genpars = NULL, label = "Testudinidae body size evolution mode, Holocene-Upper Miocene, CL, without Island species")
#paleoPPECL
plot(paleoPPECL)

```

```{r echo=FALSE}

#kable(fit3models(paleoPPECL, silent=FALSE, method="AD", pool=FALSE))

```



## Histograms

Frequency of body size data and distribution over time

```{r echo=FALSE}
Fossil <- PleiPlioCL %>%
  filter(EpochBins != "Modern")

hist(Fossil$CL, breaks=20)
hist(Fossil$Age, breaks=seq(0,12,by=0.5))
```

# CL histogram per bin

```{r echo=FALSE}
# Modern <- PleiPlioCL %>%
#   filter(EpochBins == "Modern")
# 
# Holocene <- PleiPlioCL %>%
#   filter(EpochBins == "Holocene")
# 
# UpperPlei <- PleiPlioCL %>%
#   filter(EpochBins == "Upper Pleistocene")
# 
# MiddlePlei <- PleiPlioCL %>%
#   filter(EpochBins == "Middle Pleistocene ")
# 
# LowerPlei <- PleiPlioCL %>%
#   filter(EpochBins == "Lower Pleistocene")
# 
# UpperPlio <- PleiPlioCL %>%
#   filter(EpochBins == "Upper Pliocene")
# 
# LowerPlio <- PleiPlioCL %>%
#   filter(EpochBins == "Lower Pliocene")
# 
# UpperMio <- PleiPlioCL %>%
#   filter(EpochBins == "Upper Miocene")
# 
# 
# par(mfcol=c(2,4))
# hist(Modern$CL, breaks=20)
# hist(Holocene$CL, breaks=20)
# hist(UpperPlei$CL, breaks=20)
# #hist(MiddlePlei$CL, breaks=20)
# hist(LowerPlei$CL, breaks=20)
# hist(UpperPlio$CL, breaks=20)
# hist(LowerPlio$CL, breaks=20)
# hist(UpperMio$CL, breaks=20)

HistCLModern <- PleiPlioCL %>%
  filter( !is.na(CL)) %>%
  filter(EpochBins == "Modern") %>%
  ggplot(aes(CL)) + geom_histogram(binwidth=10, col="black", fill="gray") + facet_wrap(~EpochBins, scales="free_x")+
  theme_classic()+ 
  #theme_gray() +
  theme(panel.border = element_rect(colour = "black", fill=NA))

HistCL <- PleiPlioCL %>%
  filter( !is.na(CL)) %>%
  filter(EpochBins != "Modern") %>%
  ggplot(aes(CL)) + geom_histogram(binwidth=10, col="black", fill="gray") + facet_wrap(~EpochBins, scales="free_x")+
  theme_classic()+ 
  #theme_gray() +
  theme(panel.border = element_rect(colour = "black", fill=NA))

HistCLModern
HistCL  

```


## Boxplots (continental (n) vs. Island (y) species)

```{r echo=FALSE, warning=FALSE}
# TR <- PleiPlioCL
# 
# TRI <- TR %>%
#   dplyr::select(Taxon, CL, PL, Age, Island, Continent)

# IslandEx <- extant %>%
#   dplyr::select(Taxon=Species, SCL, PL,  Island, Continent) %>% # Age=0,  , n=1
#   mutate(CL=SCL*10, PL=PL*10, Age=0) %>%#, n=1
#   dplyr::select(Taxon, CL, PL,  Island, Continent, Age)
# 
# Island <- bind_rows(TRI, IslandEx)

Epoch <- as.vector(c("Modern", "Pleistocene", "Pleistocene", "Pleistocene", "Holocene",
                      "Pliocene", "Pliocene", "Miocene"))
EpochBins <- as.vector(unique(PleiPlioCL$EpochBins))
Epochs <- data.frame(Epoch,EpochBins )

Continent <- as.vector(unique(PleiPlioCL$Continent))
Con <- as.vector(c("Asia", "Africa", "Europe", "America", "America", "America", "Europe"))
Continents <- data.frame(Continent, Con)

Island <- PleiPlioCL %>%
  dplyr::select(Taxon, CL, PL, Age, Island, Continent, EpochBins) %>%
  merge(Epochs) %>%
  merge(Continents) %>%
  dplyr::select(CL, Island, Con, Epoch, Age)
  
colnames(Island)[3] <- "Continent"

IslandBox <- Island %>%
  dplyr::select(CL, Island, Continent, Epoch, Age) %>%
  ggplot(aes(Island, CL)) + geom_boxplot() + geom_jitter(aes(colour=Continent, shape=Epoch)) +
#  facet_grid(.~Continent) +
  theme_classic() + # for white background 
#  stat_summary(fun.data = give.n, geom = "text") +
 # xlab("Sex") + ylab("Carapace length [mm]") + 
  theme(legend.background = element_rect(colour = 'black'),
        panel.border = element_rect(colour = "black", fill=NA)) +
  scale_colour_brewer(palette="Set1")

IslandBox

```


```{r echo=FALSE, warning=FALSE}
IslandBoxAge <- Island %>%
  ggplot(aes(Island, CL)) + geom_boxplot() + geom_jitter(aes(colour=Age)) +
  facet_grid(.~Continent) +
  theme_classic() + # for white background 
#  stat_summary(fun.data = give.n, geom = "text") +
 # xlab("Sex") + ylab("Carapace length [mm]") + 
  theme(legend.background = element_rect(colour = 'black'),
        panel.border = element_rect(colour = "black", fill=NA)) +
  scale_colour_gradientn(colors=c("orange", "red", "purple", "blue", "green")) #

IslandBoxAge
```

# Map


```{r echo=FALSE, include=FALSE}
Map <- tidyCL %>%
  filter(Age < 11.000) %>%
  filter(Latitude != "-") %>%
  dplyr::select(Genus, Taxon, Latitude, Longitude, Country, CL, PL) %>%
  group_by(Latitude) %>%
  mutate(count= n())


mapWorld <- borders("world", colour="azure3", fill="azure3") # create a layer of borders, run line at the beginning (before loading plotly)


mapCL <- Map %>%
  ggplot(aes(Longitude, Latitude)) +# borders("world", ylim = c(-60, 90)) +
  mapWorld +
  theme_classic() +
  geom_point(aes(Longitude, Latitude,colour=CL, size=count)) +
  scale_colour_gradientn(colors=c("orange", "red", "purple", "blue", "green"))



mapCL
```

# Species Accumulation Curve

## Fossil species (per Locality)

```{r "Species Accumulation Curve", echo=FALSE, message=FALSE}

vegan <- tidyCL %>%
  dplyr::select(Locality, Taxon) %>%
  group_by(Locality, Taxon) %>%
  summarise(n=n()) %>%
  tidyr::spread(Taxon, n, fill=0)

library(vegan)

vegan=vegan[,-1]
vegansp=specaccum(vegan,method="rarefaction", permutations=1000)
plot(vegansp,xlab="Ind",ylab="Richness", xvar="individuals", ci.type="line", ci.lty=2, ci.col="grey", col="deepskyblue4", lwd=2, main="Fossil species, CL, per Locality" )


```

## Fossil species (per Reference)

```{r echo=FALSE, message=FALSE}

vegan <- tidyCL %>%
  dplyr::select(Reference, Taxon) %>%
  group_by(Reference, Taxon) %>%
  summarise(n=n()) %>%
  tidyr::spread(Taxon, n, fill=0)

library(vegan)

vegan=vegan[,-1]
vegansp=specaccum(vegan,method="rarefaction", permutations=1000)
plot(vegansp,xlab="Ind",ylab="Richness", xvar="individuals", ci.type="line", ci.lty=2, ci.col="grey", col="deepskyblue4", lwd=2, main="Fossil species, CL, per Reference" )


```

## Fossil genera (per Locality)

```{r  echo=FALSE, message=FALSE}

vegan <- tidyCL %>%
  dplyr::select(Locality, Genus) %>%
  group_by(Locality, Genus) %>%
  summarise(n=n()) %>%
  tidyr::spread(Genus, n, fill=0)

library(vegan)

vegan=vegan[,-1]
vegansp=specaccum(vegan,method="rarefaction", permutations=1000)
plot(vegansp,xlab="Ind",ylab="Richness", xvar="individuals", ci.type="line", ci.lty=2, ci.col="grey", col="deepskyblue4", lwd=2, main="Fossil genera, CL, per Locality" )


```

## Fossil genera (per Reference)

```{r echo=FALSE, message=FALSE}

vegan <- tidyCL %>%
  dplyr::select(Reference, Genus) %>%
  group_by(Reference, Genus) %>%
  summarise(n=n()) %>%
  tidyr::spread(Genus, n, fill=0)

library(vegan)

vegan=vegan[,-1]
vegansp=specaccum(vegan,method="rarefaction", permutations=1000)
plot(vegansp,xlab="Ind",ylab="Richness", xvar="individuals", ci.type="line", ci.lty=2, ci.col="grey", col="deepskyblue4", lwd=2, main="Fossil genera, CL, per Reference")


```

## Fossil and extant species (per Reference)


```{r echo=FALSE, message=FALSE}

fossilSp <- tidyCL %>%
  dplyr::select(Reference, Taxon) %>%
  rename(Species=Taxon)

extantSp <- extant %>%
  dplyr::select(Reference, Species)
  


veganSp <- fossilSp %>%
  bind_rows(extantSp) %>%
  group_by(Reference, Species) %>%
  summarise(n=n()) %>%
  tidyr::spread(Species, n, fill=0)


veganSp=veganSp[,-1]
vegansp=specaccum(veganSp,method="rarefaction", permutations=1000)
plot(vegansp,xlab="Ind",ylab="Richness", xvar="individuals", ci.type="line", ci.lty=2, ci.col="grey", col="deepskyblue4", lwd=2, main="Fossil and extant species, CL, per Reference")


```

## Occurences from FosFarBase per Reference (all known occurences, disregarding availability of CL-data)


```{r echo=FALSE}
All<-read.csv("tortoises13-04.csv", sep=";", header=TRUE)


allGen <- tidyCL %>%  #All or tidyCL
  filter(Age < 11.000)


veganGenera <- allGen %>%
  group_by(Reference, Genus) %>%
  summarise(n=n()) %>%
  tidyr::spread(Genus, n, fill=0)


veganGenera=veganGenera[,-1]
veganG=specaccum(veganGenera,method="rarefaction", permutations=1000)

plot(veganG,xlab="Ind",ylab="Richness", xvar="individuals", ci.type="line", ci.lty=2, ci.col="grey", col="deepskyblue4", lwd=2, main="All fossil genera, per Reference")

```

## Occurences from FosFarBase per Locality (all known occurences, disregarding availability of CL-data)

```{r echo=FALSE}
All<-read.csv("tortoises13-04.csv", sep=";", header=TRUE)


allGen <- tidyCL %>%  #All or tidyCL
  filter(Age < 11.000)


veganGenera <- allGen %>%
  group_by(Locality, Genus) %>%
  summarise(n=n()) %>%
  tidyr::spread(Genus, n, fill=0)


veganGenera=veganGenera[,-1]
veganG=specaccum(veganGenera,method="rarefaction", permutations=1000)

plot(veganG,xlab="Ind",ylab="Richness", xvar="individuals", ci.type="line", ci.lty=2, ci.col="grey", col="deepskyblue4", lwd=2, main="All fossil genera, per Locality")

```

