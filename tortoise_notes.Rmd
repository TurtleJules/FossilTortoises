---
title: "Body size trends in Neogene tortoises"
output:
  pdf_document: default
  html_notebook: default
  html_document: default
always_allow_html: yes
---

```{r "setup", include=FALSE}
require("knitr")
opts_knit$set(root.dir = "//naturkundemuseum-berlin.de/MuseumDFSRoot/Benutzer/Julia.Joos/Eigene Dateien/MA")
library(dplyr)
library(ggplot2)
```

# 30.05.2017
Test paleoTS with Fossil Checklist data (but is probably of no use, because they report average body sizes (means, median, something else? what are the respective sample size? maybe ask the authors!?), so this is just for playing around).

Raw data:
```{r "Checklist data"}
library(paleoTS)
#setwd("//naturkundemuseum-berlin.de/MuseumDFSRoot/Benutzer/Julia.Joos/Eigene Dateien/MA")
test<-read.csv("test26.5.csv", sep=";", header=TRUE)
test
```


The first plot shows mean Cl size for each taxon as a single data point, so each data point is one species (in this case this equals one individual, since I don't have sample sizes), even within time bins.

```{r "Test paleoTS with Checklist data"}
Test1 <- test %>%
  mutate(mm = CL_mean, vv=0, nn= n, tt=Age_mean) %>%
  dplyr::select(mm, vv, nn, tt)

paleoTest1 <-as.paleoTS(Test1$mm, Test1$vv, Test1$nn, Test1$tt, MM = NULL,
                        genpars = NULL, label = "Testudinidae body size evolution mode")
paleoTest1
plot(paleoTest1)
```

This is the underlying data for Test1:

```{r "Converted data for paleoTS"}
Test1
```

For the second plot, I averaged CL means across taxa for each time bin, which leaves one data point per time bin, comprising all taxa within the respective bin:

```{r "Checklist data disregarding taxa"}
Test2 <- test %>%
  group_by(Age_mean) %>%
  summarise(mm = mean(CL_mean), nn=n(), vv=var(CL_mean)) %>%
  mutate(tt=Age_mean) %>%
  dplyr::select(mm, vv, nn, tt)

# NA: column 2, rows 3, 10, 13, 14, 15
Test2[3,2] <- 0
Test2[10,2] <- 0
Test2[13,2] <- 0
Test2[14,2] <- 0
Test2[15,2] <- 0

paleoTest2 <-as.paleoTS(Test2$mm, Test2$vv, Test2$nn, Test2$tt, MM = NULL,
                        genpars = NULL, label = "Testudinidae body size evolution mode")
paleoTest2
plot(paleoTest2)
```
Since "real" variances and sample sizes are available when pooling all taxa, you can even fit models (as you should be able to in the end).
(when I remember correctly, the model with the highest Akaike.wt is the best supported one, in this case this would be URW = random walk)
```{r}
a=fit3models(paleoTest2, silent=FALSE, method="AD", pool=FALSE)   #not working with Test1, because no variances/sample sizes available, I guess
str(a)
a$AICc[1] # not sure what this tells me...
```




This is the underlying data for Test2:
```{r "Converted data2 for paleoTS"}
Test2
```


## TO DO:
\begin{itemize}
\item figure out if Checklist data is of any use (means? medians? sample size?) or see if authors can provide necessary data
\item do paleoTS analyses with FFB data set
\item read Hunt papers (see citations in Catalina's paper 2006, 2008, 2008, 2010; also 2015)
\item figure out how to implement phylogeny... well, figure out how to do paleoTS analyses with more than one taxon without pooling everything together (as in Test2)
\end{itemize}


# 06.06.2017
Try paleoTS with some first real data.
Here is the underlying data:

```{r "Get actual data"}
tidyCL<-read.csv("tortoises_tidy.csv", sep=";", header=TRUE)
tidyCL

```

Prepare data for conversion to paleoTS-object:

```{r "Data preparation for analyses with paleoTS"}
TidyCL <- tidyCL %>%
  select(MAmin, Mamax, CL) %>%
  filter(CL != "NA") %>%
  mutate(tt= (MAmin+Mamax)/2) %>% # create mean age
  group_by(tt) %>% #create time bins
  summarise(mm=mean(CL), vv=var(CL), nn=n()) #create means etc. for each time bin 

TidyCL[is.na(TidyCL)]<-0 #subset NAs with O for 

TidyCL

bins <- tidyCL %>%
#  select(MAmin, Mamax, CL) %>%
  filter(CL != "NA") %>%
  mutate(tt= (MAmin+Mamax)/2) %>% # create mean age
  group_by(tt)

bins

```



```{r "Try paleoTS with actual data"}
library(paleoTS)
paleoTidyCL <-as.paleoTS(TidyCL$mm, TidyCL$vv, TidyCL$nn, TidyCL$tt, MM = NULL, genpars = NULL, label = "Testudinidae body size evolution mode")
paleoTidyCL
plot(paleoTidyCL)

fit3models(paleoTidyCL, silent=FALSE, method="AD", pool=FALSE)   #not working with Test1, because no variances/sample sizes available, I guess

```


```{r "Map fossil records with CL information available"}
Map <- tidyCL %>%
  select(Genus, Taxon, Latitude, Longitude, Country, CL, PL) %>%
  group_by(Latitude) %>%
  mutate(count= n())

mapWorld <- borders("world", colour="azure3", fill="azure3") # create a layer of borders


mp <- Map %>%
  ggplot(aes(Longitude, Latitude)) + mapWorld +
#  geom_point(fill="red", colour="red", size=0.5) +
  geom_point(aes(Longitude, Latitude,colour=CL, size=count))

mp

library(plotly)


ggplotly(mp)

```


## TO DO:
* map localities with differing colors for: CL available, CL extrapolated (from PL or figures), CL missing
* complete data set! 
  + get missing refences/make list of missing references


# 08.06.17

Map all localities with sample size and age indicated (regardless of whether CL information is available):
```{r "Map all records indicating age and sample size, disregarding availability of CL"}
test<-read.csv("tortoises13-04.csv", sep=";", header=TRUE)

colnames(test)[6] <- "Mamin"
colnames(test)[7] <- "Mamax"

Test <- test %>%
  select(Locality, Country, Latitude, Longitude, Mamin, Mamax, Epoch, Genus, Species, Taxon, CL) %>%
  mutate(Age= (Mamin+Mamax)/2) %>%   # create mean age
  group_by(Latitude) %>%
  mutate(count= n())

mapWorld <- borders("world", colour="azure3", fill="azure3") # create a layer of borders  
  
map <- Test %>%
  ggplot(aes(Longitude, Latitude)) + mapWorld +
  #geom_point(fill="red", colour="red", size=0.5) +
  geom_point(aes(Longitude, Latitude,colour=Age, size=count))

map

ggplotly(map)
```




#######################################################################################################

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).
