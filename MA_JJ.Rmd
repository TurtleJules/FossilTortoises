---
title: "MAthesis"
author: "Julia Joos"
date: "14 August 2017"
output: 
  pdf_document:
    toc: true
    toc_depth: 2
    number_sections: true
    fig_caption: true
    df_print: kable
   # fontsize: 12pt
   # geometry: margin=1in
   # documentclass: scrartcl
   # mainfont: Helvetica
    citation_package: natbib
    keep_tex: true

header-includes:
    - \usepackage{setspace}
    - \doublespacing
    
# includes:
#       before_body: titlepage.tex
    
---

```{r "setup", include=FALSE}
require("knitr")
#opts_knit$set(root.dir = "//naturkundemuseum-berlin.de/MuseumDFSRoot/Benutzer/Julia.Joos/Eigene Dateien/MA")
## on laptop: 
opts_knit$set(root.dir = "C:/Users/Jule/Documents/Uni/MA")
library(dplyr)
library(ggplot2)
```




```{r "import data set", echo=FALSE}
#### Data basis - import data set from Excel ####
setwd("C:/Users/Jule/Documents/Uni/MA")
tidyCL<-read.csv("tortoises_tidy.csv", sep=";", header=TRUE)

#####prepare for analysis (fix column names in .csv-file after converting table from excel####
colnames(tidyCL)[6] <- "MAmin"
colnames(tidyCL)[7] <- "Mamax"
colnames(tidyCL)[17] <- "CL"
colnames(tidyCL)[18] <- "PL"
colnames(tidyCL)[21] <- "estimated"

tidyCL <-  tidyCL %>%
  mutate(Age= ((MAmin)+(as.numeric(Mamax)))/2)

####### import extant data ####
extant <- read.csv("MFN_testudinidae.csv", sep=";", header=TRUE, dec=".", na.strings = "NA", stringsAsFactors=FALSE)  # file: MFN_testudinidae.csv

colnames(extant)[4] <- "SCL"
colnames(extant)[10] <- "PL"
colnames(extant)[11] <- "PLmid"



Extant <- extant %>%
  mutate(CL = SCL * 10, PL=PL*10, PLmid=PLmid*10) 
```


```{r "estimating CL from PL", echo=FALSE, results='asis'}
CLPLtidy <- tidyCL %>%
  filter(!is.na(CL) & !is.na(PL)) %>%
  dplyr::select(Taxon, CL, PL, size, Age, Island, Continent) %>%
  mutate(ratio=CL/PL) %>%
  group_by(Taxon) %>% #to show ratios per Taxon, leave out to get a total ratio
  summarise(meanRatio=round(mean(ratio),2), sdRatio=round(sd(ratio),2), n=n(), min=min(ratio), max=max(ratio))

CLPLextant <- Extant %>%
  filter(!is.na(CL) & !is.na(PL)) %>%
  dplyr::select(Taxon=Species, CL, PL, PLmid, Island, Continent) %>%
  mutate(ratio=CL/PL, ratioMid=CL/PLmid)
  #group_by(Taxon) %>% #to show ratios per Taxon, leave out to get a total ratio
  #  summarise(meanRatio=round(mean(ratio),2), sdRatio=round(sd(ratio),2), n=n(), min=min(ratio), max=max(ratio))

Ratio <- CLPLextant %>%
  summarise(meanRatio=round(mean(ratio),2), sdRatio=round(sd(ratio),2), n=n(), min=min(ratio), max=max(ratio))

RatioSpecies <- CLPLextant %>%
  group_by(Taxon) %>% #to show ratios per Taxon, leave out to get a total ratio
  summarise(meanRatio=round(mean(ratio),2), sdRatio=round(sd(ratio),2), n=n(), min=min(ratio), max=max(ratio))


fossil <- tidyCL %>%
  mutate(Taxon=as.character(Taxon), Island=as.character(Island), Continent=as.character(Continent), estimated=as.character(estimated)) %>%
  dplyr::select(Taxon, CL, PL, size, estimated, Age, Island, Continent)
  
modern <- Extant %>%
  dplyr::select(Taxon=Species, CL, PL, estimated, Age, Island, Continent)

All <- bind_rows(modern, fossil)

testRatio <- All %>% #tidyCL
  dplyr::select(Taxon, CL, PL, size, estimated, Age, Island, Continent) %>%
  mutate(extraCL = PL*Ratio$meanRatio) %>%
  dplyr::select(Taxon, CL, extraCL, PL, size, estimated, Age, Island, Continent)

testRatio$CL[is.na(testRatio$CL)] <- testRatio$extraCL[is.na(testRatio$CL)]
```


```{r "Bin data", echo=FALSE}

PleiPlio <- testRatio %>% #testRatio or tidyCL 
  filter(Age < 11.000)

PleiPlio$bin <- cut(PleiPlio$Age, c(0, 0.000001, 0.0117, 0.126, 0.781, 2.588, 3.6, 5.332, 11.608))

EpochBins <- as.vector(c("Modern", "Holocene", "Upper Pleistocene", "Middle Pleistocene", "Lower Pleistocene", "Upper Pliocene", "Lower Pliocene", "Upper Miocene"))

MeanBins <- as.vector(c((0+0.000001)/2, (0+0.0117)/2, (0.0117+0.126)/2, (0.126+0.781)/2, (0.781+2.588)/2,(2.588+3.6)/2, (3.6+5.332)/2, (5.332+11.608)/2))

Bins <- PleiPlio %>%
  select(bin) %>%
  group_by(bin) %>%
  summarise(n=n())

bin <- as.vector(unique(Bins$bin))

#BINS <- data.frame(bin, EpochBins, MeanBins) #
BINS <- read.table("timebins.txt", sep="\t", header=TRUE)

kable(Bins)
kable(BINS)

PleiPlioCL <- PleiPlio %>%
  merge(BINS)

SUM <- PleiPlioCL %>%
  group_by(MeanBins) %>%
  summarise(n=n())
```


```{r "Map fossil occurrences", echo=FALSE}

CL <- tidyCL %>%
#  filter(Age < 11.000) %>%
  dplyr::select(Locality, Genus, Taxon, Latitude, Longitude, Country, Age) %>%
  group_by(Locality) %>%
  mutate(count= n())


FossilOccurrences<-read.csv("tortoises_occurrences.csv", sep=";", header=TRUE)

FossOcc <- FossilOccurrences %>%
  mutate(Age= (as.numeric(as.character(MA.min)) + as.numeric(as.character(Ma.max)))/2) %>%
  select(Locality, Country, Latitude, Longitude, Age, Genus, Taxon, CL) %>%
#  merge(tidyCL) %>%
  group_by(Locality) %>%
  mutate(count= n(), Longitude=as.numeric(as.character(Longitude)))


#na <- FossOcc[!complete.cases(FossOcc),]

#OccMap <-  merge(Map, FossOcc, by="Locality", incomparables=TRUE) %>%
#  distinct()
  



mapWorld <- borders("world", colour="azure3", fill="azure3") # create a layer of borders, run line at the beginning (before loading plotly)

cbbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")


mapOc <- FossOcc %>%
  ggplot(aes(Longitude, Latitude)) +# borders("world", ylim = c(-60, 90)) +
  mapWorld +
  theme_classic() +
  geom_point(data=FossOcc, (aes(as.numeric(Longitude), Latitude, colour=FossOcc$CL))) +
  geom_point(data=CL,(aes(Longitude, Latitude, colour="yes"))) +
  scale_colour_manual(values=cbbPalette)

#unique(FossOcc$CL)

mapOc

# require(plotly)
# ggplotly(mapOc)



```


```{r "Map body size data set", echo=FALSE}


tidyCL$bin <- cut(tidyCL$Age, c(0, 0.000001, 0.0117, 0.126, 0.781, 2.588, 3.6, 5.332, 11.608,33.9, 56.000))


Bins <- tidyCL %>%
  select(bin) %>%
  group_by(bin) %>%
  summarise(n=n())


bin <- as.vector(unique(Bins$bin))
EpochBins <- as.vector(c("Holocene", "Upper Pleistocene", "Middle Pleistocene", "Lower Pleistocene", "Upper Pliocene", "Lower Pliocene", "Upper Miocene", "Oligocene", "Eocene"))

MeanBins <- as.vector(c((0+0.0117)/2, (0.0117+0.126)/2, (0.126+0.781)/2, (0.781+2.588)/2,(2.588+3.6)/2, (3.6+5.332)/2, (5.332+11.608)/2, (11.608+33.9)/2, (33.9+56.0)/2 ))


bin <- as.vector(unique(Bins$bin))

BINS <- data.frame(bin, EpochBins, MeanBins) #


#BINS <- data.frame(bin, EpochBins, MeanBins) #
#BINS <- read.table("timebins.txt", sep="\t", header=TRUE)


MapCL <- tidyCL %>%
  merge(BINS) %>%
#  filter(Age < 11.000) %>%
#  filter(Latitude != "-") %>%
  dplyr::select(Genus, Taxon, Latitude, Longitude, Country, CL, PL, MeanBins, size) %>%
  group_by(Latitude) %>%
  mutate(count= n()) 


mapWorld <- borders("world", colour="azure3", fill="azure3") # create a layer of borders, run line at the beginning (before loading plotly)


mapCL <- MapCL %>%
  ggplot(aes(Longitude, Latitude)) +# borders("world", ylim = c(-60, 90)) +
  mapWorld +
  theme_classic() +
  geom_point(aes(Longitude, Latitude,size=count, colour=MeanBins)) +  #colour=size, 
  scale_colour_gradientn(colors=c("orange", "red", "purple", "blue", "green"))



mapCL


```




```{r "Get overview over sample sizes", echo=FALSE, include=FALSE}
Overview <- PleiPlioCL %>%
  group_by(EpochBins, Taxon) %>%
  summarise(n=n())

#write.table(Overview,file="OverviewSpeciesSampleSize.txt", sep="\t", row.names = FALSE) 
```

