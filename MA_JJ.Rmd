---
title: "MAthesis"
#author: "Julia Joos"
#date: "14 August 2017"
output: 
  pdf_document:
   # classoption: landscape
    toc: true
   # toc_depth: 2
   # number_sections: true
    fig_caption: true
    df_print: kable
   # fontsize: 12pt
   # geometry: margin=1in
   # documentclass: scrartcl
   # mainfont: Helvetica
    citation_package: natbib
    keep_tex: true

header-includes:
    - \usepackage{setspace}
    - \doublespacing
    
# includes:
#       before_body: titlepage.tex
    
---

```{r "setup", include=FALSE}
require("knitr")
#opts_knit$set(root.dir = "//naturkundemuseum-berlin.de/MuseumDFSRoot/Benutzer/Julia.Joos/Eigene Dateien/MA")
## on laptop: 
opts_knit$set(root.dir = "C:/Users/Jule/Documents/Uni/MA")
library(dplyr)
library(ggplot2)
library(paleoTS)
```




```{r "import data set", echo=FALSE}
#### Data basis - import data set from Excel ####
setwd("C:/Users/Jule/Documents/Uni/MA")
tidyCL<-read.csv("tortoises_tidy.csv", sep=";", header=TRUE)

#####prepare for analysis (fix column names in .csv-file after converting table from excel####
colnames(tidyCL)[6] <- "MAmin"
colnames(tidyCL)[7] <- "Mamax"
colnames(tidyCL)[17] <- "CL"
colnames(tidyCL)[18] <- "PL"
colnames(tidyCL)[21] <- "estimated"

tidyCL <-  tidyCL %>%
  mutate(Age= ((MAmin)+(as.numeric(Mamax)))/2) # %>%
  # filter(estimated=="m") %>%
  # filter(!is.na(CL))

####### import extant data ####
extant <- read.csv("MFN_testudinidae.csv", sep=";", header=TRUE, dec=".", na.strings = "NA", stringsAsFactors=FALSE)  # file: MFN_testudinidae.csv

colnames(extant)[5] <- "SCL"
colnames(extant)[11] <- "PL"
colnames(extant)[12] <- "PLmid"



Extant <- extant %>%
  mutate(CL = SCL * 10, PL=PL*10, PLmid=PLmid*10) 
```


```{r "estimating CL from PL", echo=FALSE, results='asis'}
CLPLtidy <- tidyCL %>%
  filter(!is.na(CL) & !is.na(PL)) %>%
  dplyr::select(Taxon, CL, PL, size, Age, Island, Continent, Genus) %>%
  mutate(ratio=CL/PL) %>%
  group_by(Taxon) %>% #to show ratios per Taxon, leave out to get a total ratio
  summarise(meanRatio=round(mean(ratio),2), sdRatio=round(sd(ratio),2), n=n(), min=min(ratio), max=max(ratio))

CLPLextant <- Extant %>%
  filter(!is.na(CL) & !is.na(PL)) %>%
  dplyr::select(Taxon=Species, CL, PL, PLmid, Island, Continent, Genus) %>%
  mutate(ratio=CL/PL, ratioMid=CL/PLmid)
  #group_by(Taxon) %>% #to show ratios per Taxon, leave out to get a total ratio
  #  summarise(meanRatio=round(mean(ratio),2), sdRatio=round(sd(ratio),2), n=n(), min=min(ratio), max=max(ratio))

Ratio <- CLPLextant %>%
  summarise(meanRatio=round(mean(ratio),2), sdRatio=round(sd(ratio),2), n=n(), min=min(ratio), max=max(ratio))

RatioSpecies <- CLPLextant %>%
  group_by(Taxon) %>% #to show ratios per Taxon, leave out to get a total ratio
  summarise(meanRatio=round(mean(ratio),2), sdRatio=round(sd(ratio),2), n=n(), min=min(ratio), max=max(ratio))


fossil <- tidyCL %>%
  mutate(Taxon=as.character(Taxon), Island=as.character(Island), Continent=as.character(Continent), estimated=as.character(estimated), Genus=as.character(Genus)) %>%
  dplyr::select(Taxon, CL, PL, size, estimated, Age, Island, Continent, Genus)
  
modern <- Extant %>%
  dplyr::select(Taxon=Species, CL, PL, estimated, Age, Island, Continent, Genus)

All <- bind_rows(modern, fossil)

testRatio <- All %>% #tidyCL
  dplyr::select(Taxon, CL, PL, size, estimated, Age, Island, Continent, Genus) %>%
  mutate(extraCL = PL*Ratio$meanRatio) %>%
  dplyr::select(Taxon, CL, extraCL, PL, size, estimated, Age, Island, Continent, Genus)

testRatio$CL[is.na(testRatio$CL)] <- testRatio$extraCL[is.na(testRatio$CL)]
```





# Time Bins with sample sizes

```{r "Bin data", echo=FALSE}

PleiPlio <- testRatio #%>% #testRatio or tidyCL 
#  filter(Age < 11.000)

# PleiPlio$bin <- cut(PleiPlio$Age, c(0, 0.000001, 0.0117, 0.126, 0.781, 2.588, 3.6, 5.332, 11.608))
# 
# EpochBins <- as.vector(c("Modern", "Modern", "Upper Pleistocene", "Middle Pleistocene", "Lower Pleistocene", "Upper Pliocene", "Lower Pliocene", "Upper Miocene"))
# 
# 
# MeanBins <- as.vector(c((0+0.000001)/2, (0+0.0117)/2, (0.0117+0.126)/2, (0.126+0.781)/2, (0.781+2.588)/2,(2.588+3.6)/2, (3.6+5.332)/2, (5.332+11.608)/2))


PleiPlio$bin <- cut(PleiPlio$Age, c(0, 0.0117, 0.126, 0.781, 2.588, 3.6, 5.332, 11.608, 15.97, 23.03, 50.000))

EpochBins <- as.vector(c("Modern", "Upper Pleistocene", "Middle Pleistocene", "Lower Pleistocene", "Upper Pliocene", "Lower Pliocene", "Upper Miocene", "Middle Miocene", "Lower Miocene", "Oligocene and Eocene"))


MeanBins <- as.vector(c((0+0.0117)/2, (0.0117+0.126)/2, (0.126+0.781)/2, (0.781+2.588)/2,(2.588+3.6)/2, (3.6+5.332)/2, (5.332+11.608)/2, (11.608+15.97)/2, (15.97+23.03)/2, (23.03+50.000)/2))




Bins <- PleiPlio %>%
  select(bin) %>%
  group_by(bin) %>%
  summarise(nIndividuals=n())

BinsSpecies <- PleiPlio %>%
  select(bin, Taxon) %>%
  group_by(bin, Taxon) %>%
  summarise(nSpecies=n()) %>%
  summarise(nSpecies=n())


BinsGenera <- PleiPlio %>%
  select(bin, Genus) %>%
  group_by(bin, Genus) %>%
  summarise(nGenera=n()) %>%
  summarise(nGenera=n())

bin <- as.vector(unique(Bins$bin))



BINS <- data.frame(bin, EpochBins, MeanBins) %>%
  merge(Bins) %>%
  merge(BinsSpecies) %>%
  merge(BinsGenera) %>%
  arrange(MeanBins)

BINS$EpochBins = factor(BINS$EpochBins, levels=c("Modern", "Upper Pleistocene",
                                                             "Middle Pleistocene", "Lower Pleistocene",
                                                             "Upper Pliocene", "Lower Pliocene",
                                                             "Upper Miocene", "Middle Miocene", 
                                                              "Lower Miocene", "Oligocene and Eocene"))

#BINS <- read.table("timebins.txt", sep="\t", header=TRUE)

#kable(Bins, caption="Time bins with corresponding sample sizes (individuals)")

kable(BINS, caption="Time bins with age range, epoch name, mean age and corresponding sample sizes (on individual, species and genus level)")

PleiPlioCL <- PleiPlio %>%
  merge(BINS) %>%
  filter(EpochBins != "Oligocene and Eocene")

# SUM <- PleiPlioCL %>%
#   group_by(MeanBins) %>%
#   summarise(n=n())


  
```

```{r "Get overview over data set", echo=FALSE, fig.cap="Scatterplot of CL over time, indicating insular (triangle) and continental (circles) and colour indicating continents."}
scatter <- testRatio %>%
  filter(!is.na(CL)) %>%
  filter(Age < 23.000) %>%
  select(CL, Age, Island, Continent, estimated) %>%
  ggplot(aes(Age, CL)) + geom_jitter(aes(shape=Island, colour= Continent)) +
  theme_classic() +
  geom_vline(xintercept= c(0, 0.0117, 0.126, 0.781, 2.588, 3.6, 5.332, 11.608, 15.97, 23.03)) +
  geom_vline(xintercept= c(1.806, 4.466, 7.424, 9.516, 13.789, 18), linetype="dashed")


scatter

length(scatter$CL)


```


# Smaller time bins

```{r "Bin data", echo=FALSE}
Miocene <- testRatio %>% #testRatio or tidyCL 
  filter(Age < 23.000)

# PleiPlio$bin <- cut(PleiPlio$Age, c(0, 0.000001, 0.0117, 0.126, 0.781, 2.588, 3.6, 5.332, 11.608))
# 
# EpochBins <- as.vector(c("Modern", "Modern", "Upper Pleistocene", "Middle Pleistocene", "Lower Pleistocene", "Upper Pliocene", "Lower Pliocene", "Upper Miocene"))
# 
# 
# MeanBins <- as.vector(c((0+0.000001)/2, (0+0.0117)/2, (0.0117+0.126)/2, (0.126+0.781)/2, (0.781+2.588)/2,(2.588+3.6)/2, (3.6+5.332)/2, (5.332+11.608)/2))


# new cuts: 1.806, 4.466, 7.424, 9.516, 13.789, 18

Miocene$bin <- cut(Miocene$Age, c(0, 0.0117, 0.126, 0.781, 1.806, 2.588, 3.6, 4.466,
                                  5.332,7.424, 9.516, 11.608, 13.789, 15.97, 18, 23.03))




EpochBinsMio <- as.vector(c("Modern", "Upper Pleistocene", "Middle Pleistocene", "Lower Pleistocene", "Gelasian(LowPleio2)", "Upper Pliocene", "Lower Pliocene 1", "Lower Pliocene 2","Upper Miocene 1", 
                         "Upper Miocene 2","Upper Miocene 3","Middle Miocene 1","Middle Miocene 2",
                         "Lower Miocene 1", "Lower Miocene 2"))


MeanBinsMio <- as.vector(c((0+0.0117)/2, (0.0117+0.126)/2, (0.126+0.781)/2, (0.781+1.806)/2, (1.806+2.588)/2,(2.588+3.6)/2, (3.6+4.446)/2, (4.446+5.332)/2, (5.332+7.424)/2, (7.424+9.516)/2,
                        (9.516+11.608)/2, (11.608+13.789)/2, (13.789+15.97)/2, (15.97+18)/2, 
                        (18+23.03)/2))

#1.806, 4.466, 7.424, 9.516, 13.789, 18


BinsMio <- Miocene %>%
  select(bin) %>%
  group_by(bin) %>%
  summarise(nIndividuals=n())

BinsSpeciesMio <- Miocene %>%
  select(bin, Taxon) %>%
  group_by(bin, Taxon) %>%
  summarise(nSpecies=n()) %>%
  summarise(nSpecies=n())


BinsGeneraMio <- Miocene %>%
  select(bin, Genus) %>%
  group_by(bin, Genus) %>%
  summarise(nGenera=n()) %>%
  summarise(nGenera=n())

bin <- as.vector(unique(BinsMio$bin))



BINSMio <- data.frame(bin, EpochBinsMio, MeanBinsMio) %>%
  merge(BinsMio) %>%
  merge(BinsSpeciesMio) %>%
  merge(BinsGeneraMio) %>%
  arrange(MeanBinsMio)

BINSMio$EpochBinsMio = factor(BINSMio$EpochBinsMio, levels=c("Modern", "Upper Pleistocene",
                                                             "Middle Pleistocene", "Lower Pleistocene",
                                                       "Gelasian(LowPleio2)", 
                                                             "Upper Pliocene", "Lower Pliocene 1",
                                                       "Lower Pliocene 2","Upper Miocene 1",
                                                       "Upper Miocene 2", "Upper Miocene3",
                                                       "Middle Miocene 1", "Middle Miocene 2", 
                                                              "Lower Miocene 1", "Lower Miocene 2"))

#BINS <- read.table("timebins.txt", sep="\t", header=TRUE)

#kable(Bins, caption="Time bins with corresponding sample sizes (individuals)")

kable(BINSMio, caption="Smaller time bins with age range, epoch name, mean age and corresponding sample sizes (on individual, species and genus level)")

MioceneCL <- Miocene %>%
  merge(BINSMio) 

# SUM <- PleiPlioCL %>%
#   group_by(MeanBins) %>%
#   summarise(n=n())


  
```


\newpage

# Maps
## fossil occurences of testudinidae

```{r "Map fossil occurrences", echo=FALSE, fig.cap="Map displaying all fossil occurrences of testudinids, with color indicating whether relevant literature was available (black if not) and if it was, whether body size data was available or not (yes and no, respectively)."}

CL <- tidyCL %>%
#  filter(Age < 11.000) %>%
  dplyr::select(Locality, Genus, Taxon, Latitude, Longitude, Country, Age) %>%
  group_by(Locality) %>%
  mutate(count= n())


FossilOccurrences<-read.csv("tortoises_occurrences.csv", sep=";", header=TRUE)

FossOcc <- FossilOccurrences %>%
  mutate(Age= (as.numeric(as.character(MA.min)) + as.numeric(as.character(Ma.max)))/2) %>%
  select(Locality, Country, Latitude, Longitude, Age, Genus, Taxon, Clavailability) %>%
#  merge(tidyCL) %>%
  group_by(Locality) %>%
  mutate(count= n(), Longitude=as.numeric(as.character(Longitude)))


#na <- FossOcc[!complete.cases(FossOcc),]

# OccMap <-  merge(Map, FossOcc, by="Locality", incomparables=TRUE) %>%
#  distinct()
  
# unique(CL$Locality) #wie viele localities
#length(unique(FossOcc$Locality[which(FossOcc$Clavailability == "yes")]))


mapWorld <- borders("world", colour="azure3", fill="azure3") # create a layer of borders, run line at the beginning (before loading plotly)

cbbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")


mapOc <- FossOcc %>%
  ggplot(aes(Longitude, Latitude)) +# borders("world", ylim = c(-60, 90)) +
  mapWorld +
  theme_classic() +
  geom_point(data=FossOcc, (aes(as.numeric(Longitude), Latitude, colour=FossOcc$Clavailability))) +
  geom_point(data=CL,(aes(Longitude, Latitude, colour="yes"))) +
  scale_colour_manual(values=cbbPalette)

#unique(FossOcc$CL)

mapOc

# require(plotly)
# ggplotly(mapOc)


######

# length(CL$Locality)
# length(unique(CL$Locality)) #wie viele localities
# length(unique(FossOcc$Locality[which(FossOcc$Clavailability == "yes")]))



```

\newpage
## body size of testudinidae

```{r "Map body size data set", echo=FALSE, fig.cap="Map displaying all localities for which body size data for testudinids was available in the literature. Size of points denotes sample size, color denotes approximate age."}


tidyCL$bin <- cut(tidyCL$Age, c(0, 0.000001, 0.0117, 0.126, 0.781, 2.588, 3.6, 5.332, 11.608, 15.97, 23.03, 50.000))



MapCL <- tidyCL %>%
  merge(BINS) %>%
#  filter(Age < 23.000) %>%
#  filter(Latitude != "-") %>%
  dplyr::select(Genus, Taxon, Latitude, Longitude, Country, CL, PL, MeanBins, size) %>%
  group_by(Latitude) %>%
  mutate(count= n()) 


mapWorld <- borders("world", colour="azure3", fill="azure3") # create a layer of borders, run line at the beginning (before loading plotly)


mapCL <- MapCL %>%
  ggplot(aes(Longitude, Latitude)) +# borders("world", ylim = c(-60, 90)) +
  mapWorld +
  theme_classic() +
  geom_point(aes(Longitude, Latitude,size=count, colour=MeanBins)) +  #colour=size, 
  scale_colour_gradientn(colors=c("orange", "red", "purple", "blue", "green"))



mapCL


```




```{r "Get overview over sample sizes", echo=FALSE, include=FALSE}
OverviewSpecies <- PleiPlioCL %>%
  filter(EpochBins != "Modern") %>%
  group_by(EpochBins, Taxon) %>%
  summarise(n=n())

OverviewSpeciesFossil <- PleiPlioCL %>%
  filter(EpochBins != "Modern") %>%
  group_by(Taxon) %>%
  summarise(n=n())

#write.table(OverviewSpecies,file="OverviewSpeciesSampleSize.txt", sep="\t", row.names = FALSE) 


OverviewGeneraTime <- PleiPlioCL %>%
  group_by(EpochBins, Genus) %>%
  summarise(n=n())

OverviewGenera <- PleiPlioCL %>%
  group_by(Genus) %>%
  summarise(n=n())

```

\newpage

# Sampling Accumulation Curve

```{r "Species Accumulation Curve", echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Species Accumulation Curve of fossil species per Locality and reference", include=FALSE}

vegan <- tidyCL %>%
  dplyr::select(Locality, Taxon) %>%
  group_by(Locality, Taxon) %>%
  summarise(n=n()) %>%
  tidyr::spread(Taxon, n, fill=0)

library(vegan)

#par(mfrow = c(2, 1))

vegan=vegan[,-1]
vegansp=specaccum(vegan,method="rarefaction", permutations=1000)
plot(vegansp,xlab="Localities",ylab="Richness", xvar="individuals", ci.type="line", ci.lty=2, ci.col="grey", col="deepskyblue4", lwd=2, main="Fossil species, CL, per Locality" )



vegan <- tidyCL %>%
  dplyr::select(Reference, Taxon) %>%
  group_by(Reference, Taxon) %>%
  summarise(n=n()) %>%
  tidyr::spread(Taxon, n, fill=0)

library(vegan)

vegan=vegan[,-1]
vegansp=specaccum(vegan,method="rarefaction", permutations=1000)
plot(vegansp,xlab="References",ylab="Richness", xvar="individuals", ci.type="line", ci.lty=2, ci.col="grey", col="deepskyblue4", lwd=2, main="Fossil species, CL, per Reference" )


```



```{r "Species Accumulation Curve with Genera", echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Sampling Accumulation Curve of fossil genera per reference"}

vegan <- tidyCL %>%
  dplyr::select(Locality, Genus) %>%
  group_by(Locality, Genus) %>%
  summarise(n=n()) %>%
  tidyr::spread(Genus, n, fill=0)




#par(mfrow = c(2, 1))


vegan=vegan[,-1]
vegansp=specaccum(vegan,method="rarefaction", permutations=1000)
# plot(vegansp,xlab="Localities",ylab="Richness", xvar="individuals", ci.type="line", ci.lty=2, ci.col="grey", col="deepskyblue4", lwd=2, main="Fossil genera, CL, per Locality" )
# --> appendix!


vegan <- tidyCL %>%
  dplyr::select(Reference, Genus) %>%
  group_by(Reference, Genus) %>%
  summarise(n=n()) %>%
  tidyr::spread(Genus, n, fill=0)

library(vegan)

vegan=vegan[,-1]
vegansp=specaccum(vegan,method="rarefaction", permutations=1000)
plot(vegansp,xlab="References",ylab="Richness", xvar="individuals", ci.type="line", ci.lty=2, ci.col="grey", col="deepskyblue4", lwd=2, main="Fossil genera, CL, per Reference")


```

```{r "Species Accumulation Curve with Genera, Africa", echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Sampling Accumulation Curve of fossil genera per reference, Africa"}

Continent <- as.vector(unique(PleiPlioCL$Continent))
Con <- as.vector(c("Asia", "Africa", "Europe", "America", "America", "America", "Europe"))#
Continents <- data.frame(Continent, Con)

overviewVegan <- PleiPlioCL %>%
  merge(Continents) %>%
  filter(EpochBins != "Modern") %>%
  group_by( Con) %>%  #Continent,
 # filter(Con=="Europe" | Con=="Asia" )%>%
  filter(!is.na(CL)) %>%
  summarise(meanCL=mean(CL), sdCL= sd(CL), n=n(), meanAge=mean(Age))


# OverviewCon <- Miocene %>%
#   select(Con) %>%
#   group_by(Con) %>%
#   summarise(nIndividuals=n())
# 
# BinsSpecies <- PleiPlio %>%
#   select(bin, Taxon) %>%
#   group_by(bin, Taxon) %>%
#   summarise(nSpecies=n()) %>%
#   summarise(nSpecies=n())
# 
# 
# BinsGenera <- PleiPlio %>%
#   select(bin, Genus) %>%
#   group_by(bin, Genus) %>%
#   summarise(nGenera=n()) %>%
#   summarise(nGenera=n())
# 
# bin <- as.vector(unique(Bins$bin))
# 
# 
# 
# BINS <- data.frame(bin, EpochBins, MeanBins) %>%
#   merge(Bins) %>%
#   merge(BinsSpecies) %>%
#   merge(BinsGenera) %>%
#   arrange(MeanBins)



vegan <- tidyCL %>%
  merge(Continents) %>%
  filter(Con=="Europe" | Con=="Asia") %>%
  dplyr::select(Reference, Genus) %>%
  group_by(Reference, Genus) %>%
  summarise(n=n()) %>%
  tidyr::spread(Genus, n, fill=0)

#library(vegan)

vegan=vegan[,-1]
vegansp=specaccum(vegan,method="rarefaction", permutations=1000)
plot(vegansp,xlab="References",ylab="Richness", xvar="individuals", ci.type="line", ci.lty=2, ci.col="grey", col="deepskyblue4", lwd=2, main="Fossil genera, CL, per Reference")


```



\newpage

# Histograms
## all

```{r "Histograms of body size data, all", echo=FALSE, fig.cap="Distribution of body size data, logtransformed, all data."}


# HistCLModern <- PleiPlioCL %>%
#   filter( !is.na(CL)) %>%
#   filter(EpochBins == "Modern") %>%
#   ggplot(aes(CL)) + geom_histogram(binwidth=10, col="black", fill="gray") + facet_wrap(~EpochBins, scales="free_x")+
#   theme_classic()+ 
#   #theme_gray() +
#   theme(panel.border = element_rect(colour = "black", fill=NA))

HistCL <- PleiPlioCL %>%
  filter( !is.na(CL)) %>%
  mutate(CL=log(CL)) %>%
#  filter(EpochBins != "Modern") %>%
  ggplot(aes(CL)) + geom_histogram( col="black", fill="gray") + 
  #facet_wrap(~EpochBins, scales="free_x")+   #binwidth=10,
  theme_classic()+ 
  #theme_gray() +
  theme(panel.border = element_rect(colour = "black", fill=NA))

#HistCLModern
HistCL  




library(stats)
library(moments)

StatsAll <- PleiPlioCL %>%
  filter(!is.na(CL)) %>%
#  group_by(Island) %>%
  summarise(nCL=length(CL), #range=range(CL),
            min=min(CL), max=max(CL), 
            var=var(CL), mean=round(mean(CL),1), logm=round(mean(log10(CL)),1),
            med=round(median(CL),1), logmed=round(median(log10(CL)),1), #CLmode=mode(CL), CLlogmode=mode(log10(CL)),
            skew=round(skewness(CL),2), logsk=round(skewness(log10(CL)),2),
            kurt=round(kurtosis(CL),2), logku=round(kurtosis(log10(CL)),2) ) %>%
  unique()


```

\newpage

## per time bin

```{r "Histograms of body size data, per time bin", echo=FALSE, fig.cap="Distribution of body size data per time bin, logtransformed."}



HistCLBins <- PleiPlioCL %>%
 # merge(BINS) %>%
  filter( !is.na(CL)) %>%
  mutate(CL=log(CL)) %>%
#  filter(EpochBins != "Modern") %>%
  ggplot(aes(CL)) + geom_histogram( col="black", fill="gray") + 
  facet_wrap(~EpochBins, scales="free_x")+   #binwidth=10,
  theme_classic()+ 
  #theme_gray() +
  theme(panel.border = element_rect(colour = "black", fill=NA))


HistCLBins


StatsBins <- PleiPlioCL %>%
  filter(!is.na(CL)) %>%
  group_by(EpochBins) %>%
  summarise(nCL=length(CL), min=min(CL), max=max(CL), var=var(CL), mean=round(mean(CL),1), logm=round(mean(log10(CL)),1),
            med=round(median(CL),1), logmed=round(median(log10(CL)),1), #CLmode=mode(CL), CLlogmode=mode(log10(CL)),
            skew=round(skewness(CL),2), logsk=round(skewness(log10(CL)),2),
            kurt=round(kurtosis(CL),2), logku=round(kurtosis(log10(CL)),2) ) %>%
  unique()

#kable(StatsBins)


```





\newpage

## modern vs. fossil

```{r "Histograms of body size data, modern vs. fossil", echo=FALSE, fig.cap="Distribution of body size data modern vs. fossil, logtransformed."}


Epoch <- as.vector(c("Modern", "Pleistocene", "Pleistocene", "Pleistocene", 
                      "Pliocene", "Pliocene", "Miocene", "Miocene", "Miocene", "Oligocene and Eocene"))
EPOCH <- as.vector(c("Modern", "Fossil", "Fossil", "Fossil"
                     , "Fossil", "Fossil", "Fossil", "Fossil", "Fossil", "Fossil"))
EpochBins <- as.vector(unique(PleiPlioCL$EpochBins))
Epochs <- data.frame(Epoch,EpochBins, EPOCH)


HistCLFossil <- PleiPlioCL %>%
  merge(Epochs) %>%
  filter( !is.na(CL)) %>%
  mutate(CL=log(CL)) %>%
#  filter(EpochBins != "Modern") %>%
  ggplot(aes(CL)) + geom_histogram( col="black", fill="gray") + 
  facet_wrap(~EPOCH, scales="free_x")+   #binwidth=10,
  theme_classic()+ 
  #theme_gray() +
  theme(panel.border = element_rect(colour = "black", fill=NA))


HistCLFossil


StatsFossil <- PleiPlioCL %>%
  merge(Epochs) %>%
  filter(!is.na(CL)) %>%
  group_by(EPOCH) %>%
  summarise(nCL=length(CL), min=min(CL), max=max(CL), var=var(CL), mean=round(mean(CL),1), logm=round(mean(log10(CL)),1),
            med=round(median(CL),1), logmed=round(median(log10(CL)),1), #CLmode=mode(CL), CLlogmode=mode(log10(CL)),
            skew=round(skewness(CL),2), logsk=round(skewness(log10(CL)),2),
            kurt=round(kurtosis(CL),2), logku=round(kurtosis(log10(CL)),2) ) %>%
  unique()

#kable(StatsFossil)


```


\newpage

## modern vs. fossil, continental vs. insular


```{r "Histograms of body size data, modern vs. fossil, continental vs. insular", echo=FALSE, fig.cap="Distribution of body size data modern vs. fossil, continental vs. insular logtransformed."}


Epoch <- as.vector(c("Modern", "Pleistocene", "Pleistocene", "Pleistocene", 
                      "Pliocene", "Pliocene", "Miocene", "Miocene", "Miocene", "Oligocene and Eocene"))
EPOCH <- as.vector(c("Modern", "Fossil", "Fossil", "Fossil"
                     , "Fossil", "Fossil", "Fossil", "Fossil", "Fossil", "Fossil"))
EpochBins <- as.vector(unique(PleiPlioCL$EpochBins))
Epochs <- data.frame(Epoch,EpochBins, EPOCH)


HistCLFossilIsland <- PleiPlioCL %>%
  merge(Epochs) %>%
  filter( !is.na(CL)) %>%
  mutate(CL=log(CL)) %>%
#  filter(EpochBins != "Modern") %>%
  ggplot(aes(CL)) + geom_histogram(col="black", fill="gray") + 
  facet_wrap(EPOCH~Island, scales="free_x")+   #binwidth=10,
  theme_classic()+ 
  #theme_gray() +
  theme(panel.border = element_rect(colour = "black", fill=NA))


HistCLFossilIsland


StatsFossilIsland <- PleiPlioCL %>%
  merge(Epochs) %>%
  filter(!is.na(CL)) %>%
  group_by(EPOCH, Island) %>%
  summarise(nCL=length(CL), min=min(CL), max=max(CL), var=var(CL), mean=round(mean(CL),1), logm=round(mean(log10(CL)),1),
            med=round(median(CL),1), logmed=round(median(log10(CL)),1), #CLmode=mode(CL), CLlogmode=mode(log10(CL)),
            skew=round(skewness(CL),2), logsk=round(skewness(log10(CL)),2),
            kurt=round(kurtosis(CL),2), logku=round(kurtosis(log10(CL)),2) ) %>%
  unique()

#kable(StatsFossilIsland)


```

\newpage
## continental vs. insular

```{r "Histograms of body size data, continental vs. insular", echo=FALSE, fig.cap="Distribution of body site data of continental (n) and insular(y) species, logtransformed."}


HistCLIsland <- PleiPlioCL %>%
  filter( !is.na(CL)) %>%
  mutate(CL=log(CL)) %>%
#  filter(EpochBins != "Modern") %>%
  ggplot(aes(CL)) + geom_histogram( col="black", fill="gray") + 
  facet_wrap(~Island, scales="free_x")+   #binwidth=10,
  theme_classic()+ 
  #theme_gray() +
  theme(panel.border = element_rect(colour = "black", fill=NA))

#HistCLModern
HistCLIsland


StatsIsland <- PleiPlioCL %>%
  filter(!is.na(CL)) %>%
  group_by(Island) %>%
  summarise(nCL=length(CL), min=min(CL), max=max(CL), var=var(CL), mean=round(mean(CL),1), logm=round(mean(log10(CL)),1),
            med=round(median(CL),1), logmed=round(median(log10(CL)),1), #CLmode=mode(CL), CLlogmode=mode(log10(CL)),
            skew=round(skewness(CL),2), logsk=round(skewness(log10(CL)),2),
            kurt=round(kurtosis(CL),2), logku=round(kurtosis(log10(CL)),2) ) %>%
  unique()

#kable(StatsIsland)
```

\newpage
## continents

```{r "Histograms of body size data, split by continents", echo=FALSE, fig.cap="Distribution of body site data per continent, logtransformed."}

Continent <- as.vector(unique(PleiPlioCL$Continent))
Con <- as.vector(c("Asia", "Africa", "Europe", "America", "America", "America", "Europe"))#
Continents <- data.frame(Continent, Con)

HistCLContinents <- PleiPlioCL %>%
  filter( !is.na(CL)) %>%
  mutate(CL=log(CL)) %>%
  merge(Continents) %>%
#  filter(EpochBins != "Modern") %>%
  ggplot(aes(CL)) + geom_histogram( col="black", fill="gray") + 
  facet_wrap(~Con, scales="free_x")+   #binwidth=10,
  theme_classic()+ 
  #theme_gray() +
  theme(panel.border = element_rect(colour = "black", fill=NA))


HistCLContinents


StatsContinents <- PleiPlioCL %>%
  merge(Continents) %>%
  filter(!is.na(CL)) %>%
  group_by(Con) %>%
  summarise(nCL=length(CL), min=min(CL), max=max(CL), var=var(CL), mean=round(mean(CL),1), logm=round(mean(log10(CL)),1),
            med=round(median(CL),1), logmed=round(median(log10(CL)),1), #CLmode=mode(CL), CLlogmode=mode(log10(CL)),
            skew=round(skewness(CL),2), logsk=round(skewness(log10(CL)),2),
            kurt=round(kurtosis(CL),2), logku=round(kurtosis(log10(CL)),2) ) %>%
  unique()

#kable(StatsContinents)
```

\newpage
## Genera

```{r "Histograms of body size data, genera", echo=FALSE, fig.cap="Distribution of body size, genera, logtransformed."}

Continent <- as.vector(unique(PleiPlioCL$Continent))
Con <- as.vector(c("Asia", "Africa", "Europe", "America", "America", "America", "Europe"))#
Continents <- data.frame(Continent, Con)

HistCLGenera <- PleiPlioCL %>%
  filter( !is.na(CL)) %>%
  mutate(CL=log(CL)) %>%
  merge(Continents) %>%
#  filter(EpochBins != "Modern") %>%
  ggplot(aes(CL)) + geom_histogram( col="black", fill="gray") + 
  facet_wrap(~Genus, scales="free_x")+   #binwidth=10,
  theme_classic()+ 
  #theme_gray() +
  theme(panel.border = element_rect(colour = "black", fill=NA))


HistCLGenera


StatsGenera <- PleiPlioCL %>%
  merge(Continents) %>%
  filter(!is.na(CL)) %>%
  group_by(Genus) %>%
  summarise(nCL=length(CL), min=min(CL), max=max(CL), var=var(CL), mean=round(mean(CL),1), logm=round(mean(log10(CL)),1),
            med=round(median(CL),1), logmed=round(median(log10(CL)),1), #CLmode=mode(CL), CLlogmode=mode(log10(CL)),
            skew=round(skewness(CL),2), logsk=round(skewness(log10(CL)),2),
            kurt=round(kurtosis(CL),2), logku=round(kurtosis(log10(CL)),2) ) %>%
  unique()

kable(StatsGenera)
```


\newpage
## General statistics

```{r "Tabel Stats Distribution CL", echo=FALSE}
Stats <- bind_rows(StatsAll, StatsBins, StatsFossil, StatsIsland, 
                   StatsFossilIsland, StatsContinents) %>%
  select(-EpochBins, -Island, -Con, -EPOCH)
#names(Stats) <- c("nCL", "min", "max", "var", "mean", "logm", "med", "logmed", "skew", "logsk", "kurt", "logku", "Variable")
#Stats[1, 13] <- 0
#Stats[is.na(Stats)] <-0# c("all", "continental", "insular")

Stats$Variable <- c("all", "Modern", "Upper Pleistocene", "Middle Pleistocene", "Lower Pleistocene", "Upper Pliocene", "Lower Pliocene", "Upper Miocene", "Middle Miocene", "Lower Miocene", "Oligocene and Eocene","Fossil", "Modern", "continental", "insular", "fossil-con", "fossil-ins", "modern-con", 
                    "modern-ins", "Africa", "America", "Asia", "Europe")

kable(Stats, caption="General statistics of body size data: all, per time bin, insular and continental, per continent (all referring to CL: min, max, variance, mean, logmean, median, logmedian, skewness, logskewness, kurosis, logkurtosis")

```

\newpage
# Boxplots
## genera per time bins

```{r "Boxplots of each genus per time bin", echo=FALSE, warning=FALSE, fig.cap="Boxplots of mean CL per time bin, including mean and sd CL for each genus (as pointrange)."}
PleiPlioCL$EpochBins = factor(PleiPlioCL$EpochBins, levels=c("Modern", "Upper Pleistocene",
                                                             "Middle Pleistocene", "Lower Pleistocene",
                                                             "Upper Pliocene", "Lower Pliocene",
                                                             "Upper Miocene", "Middle Miocene",
                                                             "Lower Miocene", "Oligocene and Eocene"))


Epoch <- as.vector(c("Modern", "Pleistocene", "Pleistocene", "Pleistocene", 
                      "Pliocene", "Pliocene", "Miocene", "Miocene", "Miocene", "Oligocene and Eocene"))
EpochBins <- as.vector(unique(PleiPlioCL$EpochBins))
Epochs <- data.frame(Epoch,EpochBins )

Continent <- as.vector(unique(PleiPlioCL$Continent))
Con <- as.vector(c("Asia", "Africa", "Europe", "America", "America", "America", "Europe")) #
Continents <- data.frame(Continent, Con)





IndGenera <- PleiPlioCL %>%
  group_by(EpochBins, Genus) %>%
  filter(!is.na(CL)) %>%
  summarise(GenusMean=mean(CL), GenusSD=sd(CL), n=n()) 

IndGenera[is.na(IndGenera)] <-0


give.n <- function(x){
  return(c(y = 0, label = length(x)))
}



BinGenera <- PleiPlioCL %>%
  group_by(EpochBins, Genus) %>%
  filter(!is.na(CL)) %>%
  summarise(GenusMean=mean(CL), GenusSD=sd(CL), n=n()) %>%
#  summarise(TimeBinMean=mean(GenusMean), TimeBinSD=sd(GenusMean), n=n()) %>%
  ungroup() %>%#, CL=CL
  ggplot(aes(EpochBins, GenusMean)) + #, colour=Genus
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  stat_boxplot(geom ='errorbar', width = 0.2) +
  geom_boxplot() +
  geom_pointrange(data=IndGenera, position="jitter", aes(x=EpochBins, y=GenusMean, colour=EpochBins, ymin = GenusMean-GenusSD, ymax = GenusMean+GenusSD)) +
  stat_summary(fun.data = give.n, geom = "text") +
  theme(legend.background = element_rect(colour = 'black'),
        panel.border = element_rect(colour = "black", fill=NA)) +
  scale_colour_manual(values=c("#808080", "#848484", "#878787", "#8B8B8B", "#8F8F8F", "#929292",
                               "#969696", "#999999", "#969696", "#999999")) +
  theme(legend.position="none")

BinGenera

```

\newpage
## continental vs. insular per time bin

```{r "Boxplots of each genus per time bin, continental vs. insular", echo=FALSE, warning=FALSE, fig.cap="Boxplots of each genus per time bin, continental vs. insular species."}
PleiPlioCL$EpochBins = factor(PleiPlioCL$EpochBins, levels=c("Modern", "Upper Pleistocene",
                                                             "Middle Pleistocene", "Lower Pleistocene",
                                                             "Upper Pliocene", "Lower Pliocene",
                                                             "Upper Miocene", "Middle Miocene",
                                                             "Lower Miocene", "Oligocene and Eocene"))


Epoch <- as.vector(c("Modern", "Pleistocene", "Pleistocene", "Pleistocene", 
                      "Pliocene", "Pliocene", "Miocene", "Miocene", "Miocene", "Oligocene and Eocene"))
EpochBins <- as.vector(unique(PleiPlioCL$EpochBins))
Epochs <- data.frame(Epoch,EpochBins )

Continent <- as.vector(unique(PleiPlioCL$Continent))
Con <- as.vector(c("Asia", "Africa", "Europe", "America", "America", "America", "Europe"))#
Continents <- data.frame(Continent, Con)





IndGenera <- PleiPlioCL %>%
  group_by(EpochBins, Genus, Island) %>%
  filter(!is.na(CL)) %>%
  summarise(GenusMean=mean(CL), GenusSD=sd(CL), n=n()) 

IndGenera[is.na(IndGenera)] <- 0


give.n <- function(x){
  return(c(y = 0, label = length(x)))
}



BinGenera <- PleiPlioCL %>%
  group_by(EpochBins, Genus, Island) %>%
  filter(!is.na(CL)) %>%
  summarise(GenusMean=mean(CL), GenusSD=sd(CL), n=n()) %>%
#  summarise(TimeBinMean=mean(GenusMean), TimeBinSD=sd(GenusMean), n=n()) %>%
  ungroup() %>%#, CL=CL
  ggplot(aes(EpochBins, GenusMean)) + #, colour=Genus
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  stat_boxplot(geom ='errorbar', width = 0.2) +
  geom_boxplot() +
  geom_pointrange(data=IndGenera, position="jitter", aes(x=EpochBins, y=GenusMean, colour=EpochBins, ymin = GenusMean-GenusSD, ymax = GenusMean+GenusSD)) +
  facet_wrap(~Island)+
  stat_summary(fun.data = give.n, geom = "text") +
  theme(legend.background = element_rect(colour = 'black'),
        panel.border = element_rect(colour = "black", fill=NA)) +
  scale_colour_manual(values=c("#808080", "#848484", "#878787", "#8B8B8B", "#8F8F8F", "#929292",
                               "#969696", "#999999", "#969696", "#999999")) +
  theme(legend.position="none")

BinGenera

```

\newpage
## fossil vs. modern

```{r "Boxplots modern vs. fossil", echo=FALSE, warning=FALSE, fig.cap="Boxplots fossil vs. modern."}
PleiPlioCL$EpochBins = factor(PleiPlioCL$EpochBins, levels=c("Modern", "Upper Pleistocene",
                                                             "Middle Pleistocene", "Lower Pleistocene",
                                                             "Upper Pliocene", "Lower Pliocene",
                                                             "Upper Miocene", "Middle Miocene",
                                                             "Lower Miocene", "Oligocene and Eocene"))


Epoch <- as.vector(c("Modern", "Pleistocene", "Pleistocene", "Pleistocene", 
                      "Pliocene", "Pliocene", "Miocene", "Miocene", "Miocene", "Oligocene and Eocene"))
EPOCH <- as.vector(c("Modern", "Fossil", "Fossil", "Fossil"
                     , "Fossil", "Fossil", "Fossil", "Fossil", "Fossil", "Fossil"))
EpochBins <- as.vector(unique(PleiPlioCL$EpochBins))
Epochs <- data.frame(Epoch,EpochBins, EPOCH)

Continent <- as.vector(unique(PleiPlioCL$Continent))
Con <- as.vector(c("Asia", "Africa", "Europe", "America", "America", "America", "Europe"))#
Continents <- data.frame(Continent, Con)





IndGenera <- PleiPlioCL %>%
  merge(Epochs) %>%
  group_by(EPOCH, Genus, Island) %>%
  filter(!is.na(CL)) %>%
  summarise(GenusMean=mean(CL), GenusSD=sd(CL), n=n()) 

IndGenera[is.na(IndGenera)] <- 0


give.n <- function(x){
  return(c(y = 0, label = length(x)))
}



BinGenera <- PleiPlioCL %>%
  merge(Epochs) %>%
  group_by(EPOCH, Genus, Island) %>%
  filter(!is.na(CL)) %>%
  summarise(GenusMean=mean(CL), GenusSD=sd(CL), n=n()) %>%
#  summarise(TimeBinMean=mean(GenusMean), TimeBinSD=sd(GenusMean), n=n()) %>%
  ungroup() %>%#, CL=CL
  ggplot(aes(EPOCH, GenusMean)) + #, colour=Genus
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  stat_boxplot(geom ='errorbar', width = 0.2) +
  geom_boxplot() +
  geom_pointrange(data=IndGenera, position="jitter", aes(x=EPOCH, y=GenusMean, colour=EPOCH, ymin = GenusMean-GenusSD, ymax = GenusMean+GenusSD)) +
#  facet_wrap(~Island)+
  stat_summary(fun.data = give.n, geom = "text") +
  theme(legend.background = element_rect(colour = 'black'),
        panel.border = element_rect(colour = "black", fill=NA)) +
  scale_colour_manual(values=c("#808080", "#848484", "#878787", "#8B8B8B", "#8F8F8F", "#929292",
                               "#969696", "#999999", "#969696", "#999999")) +
  theme(legend.position="none")

BinGenera

```

\newpage
## fossil vs. modern, continental vs. insular


```{r "Boxplots fossil vs. modern, continental vs. insular", echo=FALSE, warning=FALSE, fig.cap="Boxplots fossil vs. modern, continental vs. insular species."}
PleiPlioCL$EpochBins = factor(PleiPlioCL$EpochBins, levels=c("Modern", "Upper Pleistocene",
                                                             "Middle Pleistocene", "Lower Pleistocene",
                                                             "Upper Pliocene", "Lower Pliocene",
                                                             "Upper Miocene", "Middle Miocene",
                                                             "Lower Miocene", "Oligocene and Eocene"))


Epoch <- as.vector(c("Modern", "Pleistocene", "Pleistocene", "Pleistocene", 
                      "Pliocene", "Pliocene", "Miocene", "Miocene", "Miocene", "Oligocene and Eocene"))
EPOCH <- as.vector(c("Modern", "Fossil", "Fossil", "Fossil"
                     , "Fossil", "Fossil", "Fossil", "Fossil", "Fossil", "Fossil"))
EpochBins <- as.vector(unique(PleiPlioCL$EpochBins))
Epochs <- data.frame(Epoch,EpochBins, EPOCH)

Continent <- as.vector(unique(PleiPlioCL$Continent))
Con <- as.vector(c("Asia", "Africa", "Europe", "America", "America", "America", "Europe"))#
Continents <- data.frame(Continent, Con)





IndGenera <- PleiPlioCL %>%
  merge(Epochs) %>%
  group_by(EPOCH, Genus, Island) %>%
  filter(!is.na(CL)) %>%
  summarise(GenusMean=mean(CL), GenusSD=sd(CL), n=n()) 

IndGenera[is.na(IndGenera)] <- 0


give.n <- function(x){
  return(c(y = 0, label = length(x)))
}



BinGenera <- PleiPlioCL %>%
  merge(Epochs) %>%
  group_by(EPOCH, Genus, Island) %>%
  filter(!is.na(CL)) %>%
  summarise(GenusMean=mean(CL), GenusSD=sd(CL), n=n()) %>%
#  summarise(TimeBinMean=mean(GenusMean), TimeBinSD=sd(GenusMean), n=n()) %>%
  ungroup() %>%#, CL=CL
  ggplot(aes(EPOCH, GenusMean)) + #, colour=Genus
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  stat_boxplot(geom ='errorbar', width = 0.2) +
  geom_boxplot() +
  geom_pointrange(data=IndGenera, position="jitter", aes(x=EPOCH, y=GenusMean, colour=EPOCH, ymin = GenusMean-GenusSD, ymax = GenusMean+GenusSD)) +
  facet_wrap(~Island)+
  stat_summary(fun.data = give.n, geom = "text") +
  theme(legend.background = element_rect(colour = 'black'),
        panel.border = element_rect(colour = "black", fill=NA)) +
  scale_colour_manual(values=c("#808080", "#848484", "#878787", "#8B8B8B", "#8F8F8F", "#929292",
                               "#969696", "#999999", "#969696", "#999999")) +
  theme(legend.position="none")

BinGenera

```



```{r "Boxplot continental vs. insular, individuals", echo=FALSE, warning=FALSE, fig.cap="Boxplot continental vs. insular, individuals", include=FALSE}

Epoch <- as.vector(c("Modern", "Pleistocene", "Pleistocene", "Pleistocene",
                      "Pliocene", "Pliocene", "Miocene", "Miocene", "Miocene", "Oligocene and Eocene"))
EpochBins <- as.vector(unique(PleiPlioCL$EpochBins))
Epochs <- data.frame(Epoch,EpochBins )


Epochs$EpochBins = factor(Epochs$EpochBins, levels=c("Modern", "Pleistocene",
                                                             "Pliocene",
                                                             "Miocene", "Oligocene and Eocene"))


Continent <- as.vector(unique(PleiPlioCL$Continent))
Con <- as.vector(c("Asia", "Africa", "Europe", "America", "America", "America", "Europe"))#
Continents <- data.frame(Continent, Con)

Island <- PleiPlioCL %>%
  dplyr::select(Taxon, CL, PL, Age, Island, Continent, EpochBins) %>%
  merge(Epochs) %>%
  merge(Continents) %>%
  dplyr::select(CL, Island, Con, Epoch, Age)
  

Island$Epoch = factor(Island$Epoch, levels=c("Modern", "Pleistocene",
                                                             "Pliocene",
                                                             "Miocene", "Oligocene and Eocene"))

colnames(Island)[3] <- "Continent"

give.n <- function(x){
  return(c(y = 0, label = length(x)))
}


IslandBox <- Island %>%
  dplyr::select(CL, Island, Continent, Epoch, Age) %>%
  ggplot(aes(Island, CL)) + geom_boxplot() + geom_jitter(aes(colour=Continent, shape=Epoch)) +
#  facet_grid(.~Continent) +
  theme_classic() + # for white background 
#  stat_summary(fun.data = give.n, geom = "text") +
 # xlab("Sex") + ylab("Carapace length [mm]") + 
  theme(legend.background = element_rect(colour = 'black'),
        panel.border = element_rect(colour = "black", fill=NA)) +
  stat_summary(fun.data = give.n, geom = "text") +
  scale_colour_brewer(palette="Set1")

IslandBox




```



```{r "Boxplots, species summarised", echo=FALSE, fig.cap="Boxplots continental vs. insular, species summarised", include=FALSE}
Island <- PleiPlioCL %>%
  dplyr::select(Taxon, CL, PL, Age, Island, Continent, EpochBins) %>%
  merge(Epochs) %>%
  merge(Continents) %>%
  dplyr::select(CL, Island, Con, Epoch, Age, Taxon)
  
colnames(Island)[3] <- "Continent"

give.n <- function(x){
  return(c(y = 0, label = length(x)))
}


IslandBoxSpecies <- Island %>%
  dplyr::select(CL, Island, Continent, Epoch, Age, Taxon) %>%
  group_by(Taxon, Island, Continent, Epoch) %>%
  dplyr::filter(!is.na(CL)) %>%
  summarise(meanCL=mean(CL)) %>%
  ggplot(aes(Island, meanCL)) + geom_boxplot() + geom_jitter(aes(colour=Continent, shape=Epoch)) +
#  facet_grid(.~Continent) +
  theme_classic() + # for white background 
#  stat_summary(fun.data = give.n, geom = "text") +
 # xlab("Sex") + ylab("Carapace length [mm]") + 
  theme(legend.background = element_rect(colour = 'black'),
        panel.border = element_rect(colour = "black", fill=NA)) +
  stat_summary(fun.data = give.n, geom = "text") +
  scale_colour_brewer(palette="Set1")

IslandBoxSpecies
```


\newpage
## continental vs. insular

```{r "Boxplot continental vs. insular", echo=FALSE, fig.cap="Boxplot continental vs. insular, genera summarised"}


give.n <- function(x){
  return(c(y = 0, label = length(x)))
}


IslandGenus <- testRatio %>%
  filter(!is.na(CL)) %>%
  select(CL, Island, Genus) %>%
  filter(!is.na(CL)) %>%
  group_by(Genus, Island) %>%
  summarise(meanCL=mean(CL), sdCL=sd(CL))

IslandGenus[is.na(IslandGenus)] <- 0


IslandAll <- testRatio %>%
  select(CL, Island, Genus) %>%
  filter(!is.na(CL)) %>%
  ggplot(aes(Island, CL)) + geom_boxplot() + 
  geom_pointrange(data=IslandGenus, position="jitter", aes(x=Island, y=meanCL,  colour= Island , ymin = meanCL-sdCL, ymax = meanCL+sdCL)) +   #colour=Genus,
  theme_classic() + # for white background 
  stat_summary(fun.data = give.n, geom = "text") +
  theme(legend.background = element_rect(colour = 'black'),
        panel.border = element_rect(colour = "black", fill=NA)) +
  scale_colour_manual(values=c("#808080", "#848484", "#878787", "#8B8B8B", "#8F8F8F", "#929292",
                               "#969696", "#999999")) +
  theme(legend.position="none")

IslandAll

```

\newpage
## continental vs. insular per time bin

```{r "Boxplot continental vs. insular, split into time bins", echo=FALSE, fig.cap="Boxplot continental vs. insular, genera summarised"}


give.n <- function(x){
  return(c(y = 0, label = length(x)))
}


IslandGenus <- PleiPlioCL %>%
  select(CL, Island, Genus, EpochBins) %>%
  filter(!is.na(CL)) %>%
  group_by(Genus, Island, EpochBins) %>%
  summarise(meanCL=mean(CL), sdCL=sd(CL))

IslandGenus[is.na(IslandGenus)] <- 0


IslandAll <- PleiPlioCL %>%
  select(CL, Island, Genus, EpochBins) %>%
  filter(!is.na(CL)) %>%
  ggplot(aes(Island, CL)) + geom_boxplot() + 
  geom_pointrange(data=IslandGenus, position="jitter", aes(x=Island, y=meanCL,  colour= Island , ymin = meanCL-sdCL, ymax = meanCL+sdCL)) +   #colour=Genus,
  theme_classic() + # for white background 
  stat_summary(fun.data = give.n, geom = "text") +
  theme(legend.background = element_rect(colour = 'black'),
        panel.border = element_rect(colour = "black", fill=NA)) +
  facet_wrap(~EpochBins) +
  scale_colour_manual(values=c("#808080", "#848484", "#878787", "#8B8B8B", "#8F8F8F", "#929292",
                               "#969696", "#999999")) +
  theme(legend.position="none")

IslandAll

```

\newpage
## continents

```{r "Boxplot body size split into continents", echo=FALSE, fig.cap="Boxplot: body size on different continents, genera summarised"}


give.n <- function(x){
  return(c(y = 0, label = length(x)))
}


ContinentGenus <- testRatio %>%
  merge(Continents) %>%
  select(CL, Con, Genus) %>%
  filter(!is.na(CL)) %>%
  group_by(Genus, Con) %>%
  summarise(meanCL=mean(CL), sdCL=sd(CL))


ContinentGenus[is.na(ContinentGenus)] <- 0


ContinentAll <- testRatio %>%
  merge(Continents) %>%
  select(CL, Con, Genus) %>%
  filter(!is.na(CL)) %>%
  ggplot(aes(Con, CL)) + geom_boxplot() + 
  geom_pointrange(data=ContinentGenus, position="jitter", aes(x=Con, y=meanCL,  colour= Con , ymin = meanCL-sdCL, ymax = meanCL+sdCL)) +   #colour=Genus,
  theme_classic() + # for white background 
  stat_summary(fun.data = give.n, geom = "text") +
  theme(legend.background = element_rect(colour = 'black'),
        panel.border = element_rect(colour = "black", fill=NA)) +
  scale_colour_manual(values=c("#808080", "#848484", "#878787", "#8B8B8B", "#8F8F8F", "#929292",
                               "#969696", "#999999")) +
  theme(legend.position="none")

ContinentAll

```

```{r "Boxplot body size split into continents, continental vs. insular", echo=FALSE, fig.cap="Boxplot: body size on different continents, genera summarised"}


give.n <- function(x){
  return(c(y = 0, label = length(x)))
}


ContinentsGenus <- testRatio %>%
  merge(Continents) %>%
  select(CL, Con, Genus, Island) %>%
  filter(!is.na(CL)) %>%
  group_by(Genus, Con, Island) %>%
  summarise(meanCL=mean(CL), sdCL=sd(CL))


ContinentsGenus[is.na(ContinentsGenus)] <- 0


ContinentsAll <- testRatio %>%
  merge(Continents) %>%
  select(CL, Con, Genus, Island) %>%
  filter(!is.na(CL)) %>%
  ggplot(aes(Island, CL)) + geom_boxplot() + 
  geom_pointrange(data=ContinentsGenus, position="jitter", aes(x=Island, y=meanCL,  colour= Con , ymin = meanCL-sdCL, ymax = meanCL+sdCL)) +   #colour=Genus,
  theme_classic() + # for white background 
  facet_wrap(~Con) +
  stat_summary(fun.data = give.n, geom = "text") +
  theme(legend.background = element_rect(colour = 'black'),
        panel.border = element_rect(colour = "black", fill=NA)) +
  scale_colour_manual(values=c("#808080", "#848484", "#878787", "#8B8B8B", "#8F8F8F", "#929292",
                               "#969696", "#999999")) +
  theme(legend.position="none")

ContinentsAll

```


```{r "Boxplots continents, insular vs. continent with age indicated",  echo=FALSE, warning=FALSE, fig.cap="Boxplots of body size (individuals) on different continents, insular vs. continent with age indicated", include=FALSE}

Island <- PleiPlioCL %>%
  dplyr::select(Genus, CL, PL, Age, Island, Continent, EpochBins) %>%
  merge(Epochs) %>%
  merge(Continents) %>%
  dplyr::select(CL, Island, Continent, Epoch, Age, Genus) %>%
  filter(!is.na(CL)) #%>%
  
  
  
IslandJitter <- Island %>%
  group_by(Genus, Island, Continent) %>%
  summarise(GenusMean=mean(CL), GenusSD=sd(CL), n=n(), Age=mean(Age)) 

#colnames(Island)[3] <- "Continent"
Island[is.na(Island)]<-0




IslandBoxAge <- Island %>%
  ggplot(aes(Island, CL)) + geom_boxplot() +
#  geom_jitter(data=IslandJitter,aes(colour=Age)) +
  facet_grid(.~Continent) +
  theme_classic() + # for white background 
#  stat_summary(fun.data = give.n, geom = "text") +
 # xlab("Sex") + ylab("Carapace length [mm]") + 
  theme(legend.background = element_rect(colour = 'black'),
        panel.border = element_rect(colour = "black", fill=NA))# +
#  scale_colour_gradientn(colors=c("orange", "red", "purple", "blue", "green")) #

IslandBoxAge
```


```{r "Separate genera per time bin", echo=FALSE, warning=FALSE,  fig.cap="Mean body size and standard deviation per genus in each time bin", include=FALSE}
BinGeneraFacet <- PleiPlioCL %>%
  group_by(EpochBins, Genus) %>%
  filter(!is.na(CL)) %>%
  summarise(GenusMean=mean(CL), GenusSD=sd(CL), n=n()) %>%
#  summarise(TimeBinMean=mean(GenusMean), TimeBinSD=sd(GenusMean), n=n()) %>%
  ungroup() %>%#, CL=CL
  ggplot(aes(EpochBins, GenusMean)) + #, colour=Genus
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
#  stat_boxplot(geom ='errorbar', width = 0.2) +
#  geom_boxplot() +
  geom_point(data=IndGenera,  aes(x=Genus, y=GenusMean, colour=Genus)) +
  geom_pointrange(data=IndGenera, aes(x=Genus, y=GenusMean, colour=Genus, ymin = GenusMean-GenusSD, ymax = GenusMean+GenusSD)) +
#  geom_boxplot(data=IndGenera,  aes(x=Genus, y=GenusMean, colour=Genus))+
#  geom_text(data=IndGenera,aes(label=Genus, x=EpochBins, y=GenusMean)) +
  facet_wrap(~EpochBins, scales="free_x") +
  guides(colour="none")#+
#  stat_boxplot(data=BinGenera, geom ='errorbar', width = 0.2) +
#  geom_boxplot(data=BinGenera) 
#  geom_errorbar(data=IndGenera, position="jitter",aes(ymin = GenusMean-GenusSD, ymax = GenusMean+GenusSD, width=0.2, colour=Genus))#+
  #scale_color_brewer(palette="Set1")
  #scale_colour_gradientn(colours=rainbow(4))

BinGeneraFacet
```


\newpage

# paleoTS analysis

## all (continental and insular)

### individuals (all)

```{r "paleoTS, individuals, inluding island species", echo=FALSE}
PPCL <- PleiPlioCL %>%
  dplyr::select(CL, MeanBins) %>%
  dplyr::filter(CL != "NA") %>%
  mutate(tt= MeanBins) %>% # create mean age
  group_by(tt) %>% #create time bins
  summarise(mm=mean(CL), vv=var(CL), nn=n()) #create means etc. for each time bin 

PPCL[is.na(PPCL)]<-0 #subset NAs with O for n=1


sumTort <- read.csv("tortoises_summary.csv", sep=";", header=TRUE)

SumTort <- sumTort %>%
  mutate(tt=(Mamin+Mamax)/2, vv=sdCLmm^2, nn=n, mm=meanCLmm) %>%
  dplyr::select(mm, nn, vv, tt)
 
PPESCL <- bind_rows(SumTort,PPCL) #ExTort, 

combiCL <- PPESCL %>%
  dplyr::filter(tt==0.0000005) %>%   #maybe find a way to automatically filter double tt values...
  mutate(nx = nn*mm) %>%
  mutate(mmall=sum(nx)/sum(nn)) %>%
  mutate(SD=sqrt(nx), d=mm-mmall) %>%
  mutate(nsd=((nx^2+d^2)*nn)) %>%
  mutate(varall=sum(nsd)/sum(nn), n=sum(nn)) %>%
  dplyr::select(mm=mmall, vv=varall, nn=n, tt) %>%
  unique() %>%
  dplyr::select(mm, nn, vv, tt)


PPCL <- PPESCL %>%
  filter(tt !=0.0000005) %>%
  bind_rows(combiCL)%>%
  arrange(tt)

```



```{r "paleoTS object", echo=FALSE, include=FALSE}

kable(PPCL, caption="paleoTS object (mm= mean CL, nn = sample size, vv = variance (CL), tt = Age)")
```



```{r "paleoTS plot", echo=FALSE, fig.cap="individuals, including island species"}
library(paleoTS)
paleoPPCL <-as.paleoTS(PPCL$mm, PPCL$vv, PPCL$nn, PPCL$tt, MM = NULL, genpars = NULL, label = "Testudinidae body size evolution mode, Holocene-Upper Miocene, CL, including Island species")
#paleoPPCL
plot(paleoPPCL)

```



```{r "Model-fitting, individuals" , echo=FALSE, message=FALSE, include=FALSE}

PaleoPCCLFit <- (fit3models(paleoPPCL, silent=FALSE, method="AD", pool=FALSE))

PaleoPCCLFit2 <- (fit4models(paleoPPCL, silent=FALSE, method="AD", pool=FALSE))

# PaleoPCCLShift <- (fitModeShift(paleoPPCL, minb = 50, pool = TRUE, order = c("Stasis-RW", "RW-Stasis"),
#              rw.model = c("URW", "GRW"), method = c("Joint", "AD"), 
#              silent = FALSE))

```



```{r "Model-fitting, individuals, table", echo=FALSE}

kable(PaleoPCCLFit, caption="Model-fitting results for testudinidae, individuals, including island species")

kable(PaleoPCCLFit2, caption="Model-fitting results for testudinidae (4 models), individuals, including island species")

```


\newpage

### species (all)

```{r "paleoTS plot with species mean, including island species", echo=FALSE, fig.cap="paleoTS plot with species mean, including island species"}
SpeciesMean <- PleiPlioCL %>%
  filter(EpochBins != "Modern") %>%
  group_by(EpochBins, Taxon, Age) %>%
  summarise(meanCL = mean(CL), n=n()) %>%
  merge(BINS)

SpeciesModern <- PleiPlioCL %>%
  filter(EpochBins == "Modern") %>%
  group_by(Taxon) %>%
  summarise(meanCL=mean(CL), sdCL=sd(CL), n=n(), Age=mean(Age), EpochBins=unique(EpochBins), MeanBins=unique(MeanBins))


SpeciesModern[is.na(SpeciesModern)]<-0 #subset NAs with O for n=1



SpeciesOverview <- SpeciesMean %>%
#  filter(EpochBins != "Modern") %>%
  filter( !is.na(meanCL)) %>%
  group_by(EpochBins) %>%
  summarise(meanSpeciesCL = mean(meanCL), nSpecies=n(), MeanBins = mean(MeanBins)) %>%
  arrange(MeanBins) 

#kable(SpeciesOverview)




SpeciesPaleo <- SpeciesMean %>%
  dplyr::select(meanCL, MeanBins) %>%
  dplyr::filter(meanCL != "NA") %>%
  mutate(tt= MeanBins) %>% # create mean age
  group_by(tt) %>% #create time bins
  summarise(mm=mean(meanCL), vv=var(meanCL), nn=n()) #create means etc. for each time bin 

#SpeciesPaleo[is.na(SpeciesPaleo)]<-0 #subset NAs with O for n=1


sumTort <- read.csv("tortoises_summary.csv", sep=";", header=TRUE)
#colnames(sumTort)[1] <- "Taxon"
colnames(sumTort)[6] <- "meanCL"
colnames(sumTort)[7] <- "sdCL"
#sumTort$EpochBins <- "Modern"
#sumTort$MeanBins <- 0.0000005


sumTortoises <- sumTort %>%
  mutate(Taxon= as.character(Species)) %>%
  mutate(MeanBins=(Mamin+Mamax)/2) %>%
  select(Taxon, MeanBins,  meanCL, sdCL) %>% #n,
  bind_rows(SpeciesModern)


SumTort <- sumTortoises %>%
  group_by(Taxon) %>%
  mutate(tt=MeanBins, vv=sdCL^2, nn=n, mm=meanCL) %>%
  dplyr::select(mm, nn, vv, tt, Taxon) %>%
  mutate(nx = nn*mm) %>%
  mutate(mmall=sum(nx)/sum(nn)) %>%
  mutate(SD=sqrt(nx), d=mm-mmall) %>%
  mutate(nsd=((nx^2+d^2)*nn)) %>%
  mutate(varall=sum(nsd)/sum(nn), n=sum(nn)) %>%
  dplyr::select(mm=mmall, vv=varall, nn=n, tt, Taxon) %>%
  unique() %>%
  dplyr::select(CL=mm, n=nn, var=vv, tt, Taxon)

# write.table(SumTort,file="SumTortModern.txt", sep="\t", row.names = FALSE) 

#boxplot(SumTort$CL, caption="Body size distribution in time bin 'modern'.")


modernMean <- SumTort %>%
  ungroup() %>%
  select(CL, n, tt) %>%
  filter( !is.na(CL)) %>%
  group_by(tt) %>%
  summarise(mm = mean(CL), vv=var(CL), nn=n())

#bis hier alle modernen taxa zusammengefasst (summarised and MFN_testudinidae)



SpecPaleo <- bind_rows(modernMean,SpeciesPaleo) %>%
  arrange(tt)


#kable(SpecPaleo)


paleoSpec <-as.paleoTS(SpecPaleo$mm, SpecPaleo$vv, SpecPaleo$nn, SpecPaleo$tt, MM = NULL, genpars = NULL, label = "Testudinidae body size evolution mode, Holocene-Upper Miocene, species mean CL", reset.time=TRUE)

plot(paleoSpec)
```




```{r "Model-fitting, species" , echo=FALSE, message=FALSE, include=FALSE}

PaleoSpecFit <- (fit3models(paleoSpec, silent=FALSE, method="AD", pool=FALSE))
PaleoSpecFit2 <- (fit4models(paleoSpec, silent=FALSE, method="AD", pool=FALSE))
```



```{r "Model-fitting, species, table", echo=FALSE}

kable(PaleoSpecFit, caption="Model-fitting results for testudinidae, species, including island species")

kable(PaleoSpecFit2, caption="Model-fitting results for testudinidae (4 models), species, including island species")

```


\newpage

### genera (all)

```{r "paleoTS plot with genus mean, including island species", echo=FALSE, fig.cap="paleoTS plot with genus mean, including island species"}
GenusMean <- PleiPlioCL %>%
  filter(EpochBins != "Modern") %>%
  filter(!is.na(CL)) %>%
  group_by(EpochBins, Genus) %>%
  summarise(meanCL = mean(CL), n=n()) %>%
#  ungroup() %>%
#  group_by(EpochBins) %>%
  summarise(mm = mean(meanCL), nn=n(), vv=var(meanCL)) %>%
  merge(BINS) %>%
  select(mm, nn, vv, tt=MeanBins)
  
#na <- PleiPlioCL[!complete.cases(PleiPlioCL),]



GenusModern <- PleiPlioCL %>%
  filter(EpochBins == "Modern") %>%
  filter(!is.na(CL)) %>%
  group_by(Genus) %>%
  summarise(meanCL=mean(CL), sdCL=sd(CL), n=n(), Age=mean(Age), EpochBins=unique(EpochBins), MeanBins=unique(MeanBins)) #%>%
#  summarise(mm=mean(meanCL), nn=n(), vv=var(meanCL), tt=mean(MeanBins))



sumTort <- read.csv("tortoises_summary.csv", sep=";", header=TRUE)
#colnames(sumTort)[1] <- "Taxon"
colnames(sumTort)[7] <- "meanCL"
colnames(sumTort)[8] <- "sdCL"
#sumTort$EpochBins <- "Modern"
#sumTort$MeanBins <- 0.0000005


sumTortoises <- sumTort %>%
  mutate(Genus= as.character(Genus)) %>%
  mutate(MeanBins=(Mamin+Mamax)/2) %>%
  select(Genus, MeanBins,  meanCL, sdCL, n) %>% #n,
  bind_rows(GenusModern)


SumTort <- sumTortoises %>%
  group_by(Genus) %>%
  mutate(tt=MeanBins, vv=sdCL^2, nn=n, mm=meanCL) %>%
  dplyr::select(mm, nn, vv, tt, Genus) %>%
  mutate(nx = nn*mm) %>%
  mutate(mmall=sum(nx)/sum(nn)) %>%
  mutate(SD=sqrt(nx), d=mm-mmall) %>%
  mutate(nsd=((nx^2+d^2)*nn)) %>%
  mutate(varall=sum(nsd)/sum(nn), n=sum(nn)) %>%
  dplyr::select(mm=mmall, vv=varall, nn=n, tt, Genus) %>%
  unique() %>%
  dplyr::select(CL=mm, n=nn, var=vv, tt, Genus)

#write.table(SumTort,file="SumTortModernGenus.txt", sep="\t", row.names = FALSE)

#kable(SumTort, caption="Overview over body size means per time bin on genus level.")

#boxplot(SumTort$CL, caption="Body size distribution in time bin 'modern'.")


modernMeanGenus <- SumTort %>%
  ungroup() %>%
  select(CL, n, tt) %>%
  filter( !is.na(CL)) %>%
  group_by(tt) %>%
  summarise(mm = mean(CL), vv=var(CL), nn=n())

#bis hier alle modernen taxa zusammengefasst (summarised and MFN_testudinidae)


GenusPaleo <- modernMeanGenus %>%
  bind_rows(GenusMean)%>%
  arrange(tt)


#kable(GenusPaleo)


paleoGen <-as.paleoTS(GenusPaleo$mm, GenusPaleo$vv, GenusPaleo$nn, GenusPaleo$tt, MM = NULL, genpars = NULL, label = "Testudinidae body size evolution mode, Holocene-Upper Miocene, genus mean CL", reset.time=TRUE)

plot(paleoGen)

```



```{r "Model-fitting, genera" , echo=FALSE, message=FALSE, include=FALSE}

PaleoGenFit <- (fit3models(paleoGen, silent=FALSE, method="AD", pool=FALSE))

PaleoGenFit2 <- (fit4models(paleoGen, silent=FALSE, method="AD", pool=FALSE))
```



```{r "Model-fitting, genera, table", echo=FALSE}

kable(PaleoGenFit, caption="Model-fitting results for testudinidae, genera, including island species")

kable(PaleoGenFit2, caption="Model-fitting results for testudinidae (4 models), genera, including island species")


```




\newpage

## continental (excluding insular species)

### individuals (continental)

```{r "paleoTS, individuals, exluding island species", echo=FALSE, message=FALSE, fig.cap="individuals, excluding island species"}
PPCLI <- PleiPlioCL %>%
  dplyr::select(CL, MeanBins, Island) %>%
  dplyr::filter(CL != "NA" & Island == "n") %>%
 # dplyr::filter(PleiPlioCL$Island == "n") %>%
  mutate(tt= MeanBins) %>% # create mean age
  group_by(tt) %>% #create time bins
  summarise(mm=mean(CL), vv=var(CL), nn=n()) #create means etc. for each time bin 

#PPCLI[is.na(PPCLI)]<-0 #subset NAs with O for n=1


sumTort <- read.csv("tortoises_summary.csv", sep=";", header=TRUE)

SumTort <- sumTort %>%
  dplyr::filter(Island == "n") %>%
  mutate(tt=(Mamin+Mamax)/2, vv=sdCLmm^2, nn=n, mm=meanCLmm) %>%
  dplyr::select(mm, nn, vv, tt)
 
PPESCLI <- bind_rows(SumTort,PPCLI) #ExTort, 

combiCLI <- PPESCLI %>%
  dplyr::filter(tt==0.0000005) %>%   #maybe find a way to automatically filter double tt values...
  mutate(nx = nn*mm) %>%
  mutate(mmall=sum(nx)/sum(nn)) %>%
  mutate(SD=sqrt(nx), d=mm-mmall) %>%
  mutate(nsd=((nx^2+d^2)*nn)) %>%
  mutate(varall=sum(nsd)/sum(nn), n=sum(nn)) %>%
  dplyr::select(mm=mmall, vv=varall, nn=n, tt) %>%
  unique() %>%
  dplyr::select(mm, nn, vv, tt)


PPCLIs <- PPESCLI %>%
  filter(tt !=0.0000005) %>%
  bind_rows(combiCLI)%>%
  arrange(tt)



#kable(PPCLIs, caption="paleoTS object (mm= mean CL, nn = sample size, vv = variance (CL), tt = Age)")


library(paleoTS)
paleoPPCLIs <-as.paleoTS(PPCLIs$mm, PPCLIs$vv, PPCLIs$nn, PPCLIs$tt, MM = NULL, genpars = NULL, label = "Testudinidae body size evolution mode, Holocene-Upper Miocene, CL, including Island species")
#paleoPPCL
plot(paleoPPCLIs)
```




```{r "Model-fitting, individuals, continental" , echo=FALSE, message=FALSE, include=FALSE}

PaleoPCCLIsFit <- (fit3models(paleoPPCLIs, silent=FALSE, method="AD", pool=FALSE))


PaleoPCCLIsFit2 <- (fit4models(paleoPPCLIs, silent=FALSE, method="AD", pool=FALSE))
```



```{r "Model-fitting, individuals, continental, table", echo=FALSE}

kable(PaleoPCCLIsFit, caption="Model-fitting results for testudinidae, individuals, excluding island species")

kable(PaleoPCCLIsFit2, caption="Model-fitting results for testudinidae (4 models), individuals, excluding island species")

```



\newpage


### species (continental)

```{r "paleoTS plot with species mean, excluding island species", echo=FALSE, message=FALSE, fig.cap="paleoTS plot with species mean, excluding island species"}
SpeciesMeanIs <- PleiPlioCL %>%
  filter(EpochBins != "Modern" & Island == "n") %>%
  group_by(EpochBins, Taxon, Age) %>%
  summarise(meanCL = mean(CL), n=n()) %>%
  merge(BINS)

SpeciesModernIs <- PleiPlioCL %>%
  filter(EpochBins == "Modern" & Island == "n") %>%
  group_by(Taxon) %>%
  summarise(meanCL=mean(CL), sdCL=sd(CL), n=n(), Age=mean(Age), EpochBins=unique(EpochBins), MeanBins=unique(MeanBins))


SpeciesModernIs[is.na(SpeciesModernIs)]<-0 #subset NAs with O for n=1



SpeciesOverviewIs <- SpeciesMeanIs %>%
#  filter(EpochBins != "Modern") %>%
  filter( !is.na(meanCL)) %>%
  group_by(EpochBins) %>%
  summarise(meanSpeciesCL = mean(meanCL), nSpecies=n(), MeanBins = mean(MeanBins)) %>%
  arrange(MeanBins) 

#kable(SpeciesOverviewIs)




SpeciesPaleoIs <- SpeciesMeanIs %>%
  dplyr::select(meanCL, MeanBins) %>%
  dplyr::filter(meanCL != "NA") %>%
  mutate(tt= MeanBins) %>% # create mean age
  group_by(tt) %>% #create time bins
  summarise(mm=mean(meanCL), vv=var(meanCL), nn=n()) #create means etc. for each time bin 

#SpeciesPaleo[is.na(SpeciesPaleo)]<-0 #subset NAs with O for n=1


sumTort <- read.csv("tortoises_summary.csv", sep=";", header=TRUE)
colnames(sumTort)[6] <- "meanCL"
colnames(sumTort)[7] <- "sdCL"


sumTortoises <- sumTort %>%
  dplyr::filter(Island == "n") %>%
  mutate(Taxon= as.character(Species)) %>%
  mutate(MeanBins=(Mamin+Mamax)/2) %>%
  select(Taxon, MeanBins,  meanCL, sdCL) %>% #n,
  bind_rows(SpeciesModernIs)


SumTort <- sumTortoises %>%
  group_by(Taxon) %>%
  mutate(tt=MeanBins, vv=sdCL^2, nn=n, mm=meanCL) %>%
  dplyr::select(mm, nn, vv, tt, Taxon) %>%
  mutate(nx = nn*mm) %>%
  mutate(mmall=sum(nx)/sum(nn)) %>%
  mutate(SD=sqrt(nx), d=mm-mmall) %>%
  mutate(nsd=((nx^2+d^2)*nn)) %>%
  mutate(varall=sum(nsd)/sum(nn), n=sum(nn)) %>%
  dplyr::select(mm=mmall, vv=varall, nn=n, tt, Taxon) %>%
  unique() %>%
  dplyr::select(CL=mm, n=nn, var=vv, tt, Taxon)

# write.table(SumTort,file="SumTortModern.txt", sep="\t", row.names = FALSE) 

#boxplot(SumTort$CL, caption="Body size distribution in time bin 'modern'.")


modernMeanIs <- SumTort %>%
  ungroup() %>%
  select(CL, n, tt) %>%
  filter( !is.na(CL)) %>%
  group_by(tt) %>%
  summarise(mm = mean(CL), vv=var(CL), nn=n())

#bis hier alle modernen taxa zusammengefasst (summarised and MFN_testudinidae)



SpecPaleoIs <- bind_rows(modernMeanIs,SpeciesPaleoIs) %>%
  arrange(tt)


#kable(SpecPaleoIs)


paleoSpecIs <-as.paleoTS(SpecPaleoIs$mm, SpecPaleoIs$vv, SpecPaleoIs$nn, SpecPaleoIs$tt, MM = NULL, genpars = NULL, label = "Testudinidae body size evolution mode, Holocene-Upper Miocene, species mean CL, continental", reset.time=TRUE)

plot(paleoSpecIs)
```



```{r "Model-fitting, species, continental" , echo=FALSE, message=FALSE, include=FALSE}

PaleoSpecIsFit <- (fit3models(paleoSpecIs, silent=FALSE, method="AD", pool=FALSE))

PaleoSpecIsFit2 <- (fit4models(paleoSpecIs, silent=FALSE, method="AD", pool=FALSE))
```



```{r "Model-fitting, species, continental, table", echo=FALSE}

kable(PaleoSpecIsFit, caption="Model-fitting results for testudinidae, species, excluding island species")

kable(PaleoSpecIsFit2, caption="Model-fitting results for testudinidae, species, excluding island species")

```




\newpage

### genera (continental)

```{r "paleoTS plot with genus mean, excluding island species", echo=FALSE, message=FALSE, fig.cap="paleoTS plot with genus mean, excluding island species"}
GenusMeanIs <- PleiPlioCL %>%
  filter(EpochBins != "Modern" & Island == "n") %>%
  filter(!is.na(CL)) %>%
  group_by(EpochBins, Genus) %>%
  summarise(meanCL = mean(CL), n=n()) %>%
#  ungroup() %>%
#  group_by(EpochBins) %>%
  summarise(mm = mean(meanCL), nn=n(), vv=var(meanCL)) %>%
  merge(BINS) %>%
  select(mm, nn, vv, tt=MeanBins)
  
#na <- PleiPlioCL[!complete.cases(PleiPlioCL),]



GenusModernIs <- PleiPlioCL %>%
  filter(EpochBins == "Modern" & Island == "n") %>%
  filter(!is.na(CL)) %>%
  group_by(Genus) %>%
  summarise(meanCL=mean(CL), sdCL=sd(CL), n=n(), Age=mean(Age), EpochBins=unique(EpochBins), MeanBins=unique(MeanBins)) #%>%
#  summarise(mm=mean(meanCL), nn=n(), vv=var(meanCL), tt=mean(MeanBins))



sumTort <- read.csv("tortoises_summary.csv", sep=";", header=TRUE)
colnames(sumTort)[7] <- "meanCL"
colnames(sumTort)[8] <- "sdCL"


sumTortoises <- sumTort %>%
  dplyr::filter(Island == "n") %>%
  mutate(Genus= as.character(Genus)) %>%
  mutate(MeanBins=(Mamin+Mamax)/2) %>%
  select(Genus, MeanBins,  meanCL, sdCL, n) %>% #n,
  bind_rows(GenusModernIs)


SumTort <- sumTortoises %>%
  group_by(Genus) %>%
  mutate(tt=MeanBins, vv=sdCL^2, nn=n, mm=meanCL) %>%
  dplyr::select(mm, nn, vv, tt, Genus) %>%
  mutate(nx = nn*mm) %>%
  mutate(mmall=sum(nx)/sum(nn)) %>%
  mutate(SD=sqrt(nx), d=mm-mmall) %>%
  mutate(nsd=((nx^2+d^2)*nn)) %>%
  mutate(varall=sum(nsd)/sum(nn), n=sum(nn)) %>%
  dplyr::select(mm=mmall, vv=varall, nn=n, tt, Genus) %>%
  unique() %>%
  dplyr::select(CL=mm, n=nn, var=vv, tt, Genus)

#write.table(SumTort,file="SumTortModernGenus.txt", sep="\t", row.names = FALSE)

#kable(SumTort, caption="Overview over body size means per time bin on genus level, excluding island species.")

#boxplot(SumTort$CL, caption="Body size distribution in time bin 'modern'.")


modernMeanGenusIs <- SumTort %>%
  ungroup() %>%
  select(CL, n, tt) %>%
  filter( !is.na(CL)) %>%
  group_by(tt) %>%
  summarise(mm = mean(CL), vv=var(CL), nn=n())

#bis hier alle modernen taxa zusammengefasst (summarised and MFN_testudinidae)


GenusPaleoIs <- modernMeanGenusIs %>%
  bind_rows(GenusMeanIs)%>%
  arrange(tt)

GenusPaleoIs[is.na(GenusPaleoIs)] <- 0

#kable(GenusPaleoIs)


paleoGenIs <-as.paleoTS(GenusPaleoIs$mm, GenusPaleoIs$vv, GenusPaleoIs$nn, GenusPaleoIs$tt, MM = NULL, genpars = NULL, label = "Testudinidae body size evolution mode, Holocene-Upper Miocene, genus mean CL", reset.time=TRUE)

plot(paleoGenIs)
```



```{r "Model-fitting, genera, continental" , echo=FALSE, message=FALSE, include=FALSE}

PaleoGenIsFit <- (fit3models(paleoGenIs, silent=FALSE, method="AD", pool=FALSE))


PaleoGenIsFit2 <- (fit4models(paleoGenIs, silent=FALSE, method="AD", pool=FALSE))

```



```{r "Model-fitting, genera, continental, table", echo=FALSE}

kable(PaleoGenIsFit, caption="Model-fitting results for testudinidae, genera, excluding insular species")


kable(PaleoGenIsFit2, caption="Model-fitting results for testudinidae, genera, excluding insular species")


```



\newpage


## insular (excluding continental)
### individuals (insular)

```{r "paleoTS, individuals, exluding continental species", echo=FALSE, message=FALSE, fig.cap="individuals, excluding continental species"}
PPCLCon <- PleiPlioCL %>%
  dplyr::select(CL, MeanBins, Island) %>%
  dplyr::filter(CL != "NA" & Island == "y") %>%
 # dplyr::filter(PleiPlioCL$Island == "n") %>%
  mutate(tt= MeanBins) %>% # create mean age
  group_by(tt) %>% #create time bins
  summarise(mm=mean(CL), vv=var(CL), nn=n()) #create means etc. for each time bin 

PPCLCon[is.na(PPCLCon)]<-0 #subset NAs with O for n=1


sumTort <- read.csv("tortoises_summary.csv", sep=";", header=TRUE)

SumTortCon <- sumTort %>%
  dplyr::filter(Island == "y") %>%
  mutate(tt=(Mamin+Mamax)/2, vv=sdCLmm^2, nn=n, mm=meanCLmm) %>%
  dplyr::select(mm, nn, vv, tt)
 
PPESCLCon <- bind_rows(SumTortCon,PPCLCon) #ExTort, 

combiCLCon <- PPESCLCon %>%
  dplyr::filter(tt==0.0000005) %>%   #maybe find a way to automatically filter double tt values...
  mutate(nx = nn*mm) %>%
  mutate(mmall=sum(nx)/sum(nn)) %>%
  mutate(SD=sqrt(nx), d=mm-mmall) %>%
  mutate(nsd=((nx^2+d^2)*nn)) %>%
  mutate(varall=sum(nsd)/sum(nn), n=sum(nn)) %>%
  dplyr::select(mm=mmall, vv=varall, nn=n, tt) %>%
  unique() %>%
  dplyr::select(mm, nn, vv, tt)


PPCLCon <- PPESCLCon %>%
  filter(tt !=0.0000005) %>%
  bind_rows(combiCLCon)%>%
  arrange(tt)



#kable(PPCLCon, caption="paleoTS object (mm= mean CL, nn = sample size, vv = variance (CL), tt = Age)")


library(paleoTS)
paleoPPCLCon <-as.paleoTS(PPCLCon$mm, PPCLCon$vv, PPCLCon$nn, PPCLCon$tt, MM = NULL, genpars = NULL, label = "Testudinidae body size evolution mode, Holocene-Upper Miocene, CL, only insular species")
#paleoPPCL
plot(paleoPPCLCon)
```




```{r "Model-fitting, individuals, insular" , echo=FALSE, message=FALSE, include=FALSE}

PaleoPCCLConFit <- (fit3models(paleoPPCLCon, silent=FALSE, method="AD", pool=FALSE))

#PaleoPCCLConFit2 <- (fit4models(paleoPPCLCon, silent=FALSE, method="AD", pool=FALSE))

```



```{r "Model-fitting, individuals, insular, table", echo=FALSE}

kable(PaleoPCCLConFit, caption="Model-fitting results for testudinidae, individuals, only insular species")

```

\newpage

### species (insular)

```{r "paleoTS plot with species mean, excluding continental species", echo=FALSE, message=FALSE, fig.cap="paleoTS plot with species mean, only insular species"}

SpeciesMeanCon <- PleiPlioCL %>%
  filter(EpochBins != "Modern" & Island == "y") %>%
  group_by(EpochBins, Taxon, Age) %>%
  summarise(meanCL = mean(CL), n=n()) %>%
  merge(BINS)

SpeciesModernCon <- PleiPlioCL %>%
  filter(EpochBins == "Modern" & Island == "y") %>%
  group_by(Taxon) %>%
  summarise(meanCL=mean(CL), sdCL=sd(CL), n=n(), Age=mean(Age), EpochBins=unique(EpochBins), MeanBins=unique(MeanBins))


SpeciesModernCon[is.na(SpeciesModernCon)]<-0 #subset NAs with O for n=1



SpeciesOverviewCon <- SpeciesMeanCon %>%
#  filter(EpochBins != "Modern") %>%
  filter( !is.na(meanCL)) %>%
  group_by(EpochBins) %>%
  summarise(meanSpeciesCL = mean(meanCL), nSpecies=n(), MeanBins = mean(MeanBins)) %>%
  arrange(MeanBins) 

#kable(SpeciesOverviewCon)




SpeciesPaleoCon <- SpeciesMeanCon %>%
  dplyr::select(meanCL, MeanBins) %>%
  dplyr::filter(meanCL != "NA") %>%
  mutate(tt= MeanBins) %>% # create mean age
  group_by(tt) %>% #create time bins
  summarise(mm=mean(meanCL), vv=var(meanCL), nn=n()) #create means etc. for each time bin 

SpeciesPaleoCon[is.na(SpeciesPaleoCon)]<-0 #subset NAs with O for n=1


sumTort <- read.csv("tortoises_summary.csv", sep=";", header=TRUE)
colnames(sumTort)[6] <- "meanCL"
colnames(sumTort)[7] <- "sdCL"


sumTortoisesCon <- sumTort %>%
  dplyr::filter(Island == "y") %>%
  mutate(Taxon= as.character(Species)) %>%
  mutate(MeanBins=(Mamin+Mamax)/2) %>%
  select(Taxon, MeanBins,  meanCL, sdCL) %>% #n,
  bind_rows(SpeciesModernCon)


SumTortCon <- sumTortoisesCon %>%
  group_by(Taxon) %>%
  mutate(tt=MeanBins, vv=sdCL^2, nn=n, mm=meanCL) %>%
  dplyr::select(mm, nn, vv, tt, Taxon) %>%
  mutate(nx = nn*mm) %>%
  mutate(mmall=sum(nx)/sum(nn)) %>%
  mutate(SD=sqrt(nx), d=mm-mmall) %>%
  mutate(nsd=((nx^2+d^2)*nn)) %>%
  mutate(varall=sum(nsd)/sum(nn), n=sum(nn)) %>%
  dplyr::select(mm=mmall, vv=varall, nn=n, tt, Taxon) %>%
  unique() %>%
  dplyr::select(CL=mm, n=nn, var=vv, tt, Taxon)

# write.table(SumTort,file="SumTortModern.txt", sep="\t", row.names = FALSE) 

#boxplot(SumTort$CL, caption="Body size distribution in time bin 'modern'.")


modernMeanCon <- SumTortCon %>%
  ungroup() %>%
  select(CL, n, tt) %>%
  filter( !is.na(CL)) %>%
  group_by(tt) %>%
  summarise(mm = mean(CL), vv=var(CL), nn=n())

#bis hier alle modernen taxa zusammengefasst (summarised and MFN_testudinidae)



SpecPaleoCon <- bind_rows(modernMeanCon,SpeciesPaleoCon) %>%
  arrange(tt)


#kable(SpecPaleoCon)


paleoSpecCon <-as.paleoTS(SpecPaleoCon$mm, SpecPaleoCon$vv, SpecPaleoCon$nn, SpecPaleoCon$tt, MM = NULL, genpars = NULL, label = "Testudinidae body size evolution mode, Holocene-Upper Miocene, species mean CL, excluding contintenal species", reset.time=TRUE)

plot(paleoSpecCon)
```



```{r "Model-fitting, species, insular" , echo=FALSE, message=FALSE, include=FALSE}

PaleoSpecConFit <- (fit3models(paleoSpecCon, silent=FALSE, method="AD", pool=FALSE))

#PaleoSpecConFit2 <- (fit4models(paleoSpecCon, silent=FALSE, method="AD", pool=FALSE))

```



```{r "Model-fitting, species, insular, table", echo=FALSE}

kable(PaleoSpecConFit, caption="Model-fitting results for testudinidae, species, only insular species")

```


\newpage


### genera (insular)

```{r "paleoTS plot with genus mean, excluding continental species", echo=FALSE, message=FALSE, fig.cap="paleoTS plot with genus mean, only insular species"}

GenusMeanCon <- PleiPlioCL %>%
  filter(EpochBins != "Modern" & Island == "y") %>%  # & EpochBins != "Upper Miocene"
  filter(!is.na(CL)) %>%
  group_by(EpochBins, Genus) %>%
  summarise(meanCL = mean(CL), n=n()) %>%
#  ungroup() %>%
#  group_by(EpochBins) %>%
  summarise(mm = mean(meanCL), nn=n(), vv=var(meanCL)) %>%
  merge(BINS) %>%
  select(mm, nn, vv, tt=MeanBins)
  
GenusMeanCon[is.na(GenusMeanCon)]<-0



GenusModernCon <- PleiPlioCL %>%
  filter(EpochBins == "Modern" & Island == "y") %>%
  filter(!is.na(CL)) %>%
  group_by(Genus) %>%
  summarise(meanCL=mean(CL), sdCL=sd(CL), n=n(), Age=mean(Age), EpochBins=unique(EpochBins), MeanBins=unique(MeanBins)) #%>%
#  summarise(mm=mean(meanCL), nn=n(), vv=var(meanCL), tt=mean(MeanBins))

GenusModernCon[is.na(GenusModernCon)]<-0


sumTort <- read.csv("tortoises_summary.csv", sep=";", header=TRUE)
colnames(sumTort)[7] <- "meanCL"
colnames(sumTort)[8] <- "sdCL"


sumTortoisesCon <- sumTort %>%
  dplyr::filter(Island == "y") %>%
  mutate(Genus= as.character(Genus)) %>%
  mutate(MeanBins=(Mamin+Mamax)/2) %>%
  select(Genus, MeanBins,  meanCL, sdCL, n) %>% #n,
  bind_rows(GenusModernCon)


SumTortCon <- sumTortoisesCon %>%
  group_by(Genus) %>%
  mutate(tt=MeanBins, vv=sdCL^2, nn=n, mm=meanCL) %>%
  dplyr::select(mm, nn, vv, tt, Genus) %>%
  mutate(nx = nn*mm) %>%
  mutate(mmall=sum(nx)/sum(nn)) %>%
  mutate(SD=sqrt(nx), d=mm-mmall) %>%
  mutate(nsd=((nx^2+d^2)*nn)) %>%
  mutate(varall=sum(nsd)/sum(nn), n=sum(nn)) %>%
  dplyr::select(mm=mmall, vv=varall, nn=n, tt, Genus) %>%
  unique() %>%
  dplyr::select(CL=mm, n=nn, var=vv, tt, Genus)

#write.table(SumTort,file="SumTortModernGenus.txt", sep="\t", row.names = FALSE)

#kable(SumTort, caption="Overview over body size means per time bin on genus level, excluding island species.")

#boxplot(SumTort$CL, caption="Body size distribution in time bin 'modern'.")


modernMeanGenusCon <- SumTortCon %>%
  ungroup() %>%
  select(CL, n, tt) %>%
  filter( !is.na(CL)) %>%
  group_by(tt) %>%
  summarise(mm = mean(CL), vv=var(CL), nn=n())

#bis hier alle modernen taxa zusammengefasst (summarised and MFN_testudinidae)


GenusPaleoCon <- modernMeanGenusCon %>%
  bind_rows(GenusMeanCon)%>%
  arrange(tt)


GenusPaleoCon[is.na(GenusPaleoCon)]<-0

#kable(GenusPaleoCon)


paleoGenCon <-as.paleoTS(GenusPaleoCon$mm, GenusPaleoCon$vv, GenusPaleoCon$nn, GenusPaleoCon$tt, MM = NULL, genpars = NULL, label = "Testudinidae body size evolution mode, Holocene-Upper Miocene, genus mean CL, insular genera", reset.time=TRUE)

plot(paleoGenCon)
```



```{r "Model-fitting, genera, insular" , echo=FALSE, message=FALSE, include=FALSE}

PaleoGenConFit <- (fit3models(paleoGenCon, silent=FALSE, method="AD", pool=FALSE))
```



```{r "Model-fitting, genera, insular, table", echo=FALSE}

kable(PaleoGenConFit, caption="Model-fitting results for testudinidae, genera, only insular species")

```



\newpage

## play with time bins: no bins (mean age of each sample == tt)

### all

```{r "paleoTS with different time bins, no bins, genera", echo=FALSE, fig.cap="Mean age of each sample as time bin, genera"}

GenusMeanAll <- testRatio %>%
#  merge(BINS) %>%
#  filter(EpochBins != "Modern") %>%  # & EpochBins != "Upper Miocene"
  filter(!is.na(CL)) %>%
  group_by(Age, Genus) %>%
  summarise(meanCL = mean(CL), n=n()) %>%
#  ungroup() %>%
#  group_by(EpochBins) %>%
  summarise(mm = mean(meanCL), nn=n(), vv=var(meanCL)) %>%
 # merge(BINS) %>%
  select(mm, nn, vv, tt=Age)
  
GenusMeanAll[is.na(GenusMeanAll)]<-0



# GenusModernAll <- testRatio %>%
# #  merge(BINS) %>%
# #  filter(EpochBins == "Modern") %>%
#   filter(!is.na(CL)) %>%
#   group_by(Genus) %>%
#   summarise(meanCL=mean(CL), sdCL=sd(CL), n=n(), Age=mean(Age), EpochBins=unique(EpochBins), MeanBins=unique(MeanBins)) #%>%
# #  summarise(mm=mean(meanCL), nn=n(), vv=var(meanCL), tt=mean(MeanBins))
# 
# GenusModernAll[is.na(GenusModernAll)]<-0


sumTort <- read.csv("tortoises_summary.csv", sep=";", header=TRUE)
colnames(sumTort)[7] <- "meanCL"
colnames(sumTort)[8] <- "sdCL"


sumTortoisesAll <- sumTort %>%
#  dplyr::filter(Island == "y") %>%
  mutate(Genus= as.character(Genus)) %>%
  mutate(MeanBins=(Mamin+Mamax)/2) %>%
  select(Genus, MeanBins,  meanCL, sdCL, n) %>% #n,
  bind_rows(GenusMeanAll)


SumTortAll <- sumTortoisesAll %>%
  group_by(Genus) %>%
  mutate(tt=MeanBins, vv=sdCL^2, nn=n, mm=meanCL) %>%
  dplyr::select(mm, nn, vv, tt, Genus) %>%
  mutate(nx = nn*mm) %>%
  mutate(mmall=sum(nx)/sum(nn)) %>%
  mutate(SD=sqrt(nx), d=mm-mmall) %>%
  mutate(nsd=((nx^2+d^2)*nn)) %>%
  mutate(varall=sum(nsd)/sum(nn), n=sum(nn)) %>%
  dplyr::select(mm=mmall, vv=varall, nn=n, tt, Genus) %>%
  unique() %>%
  dplyr::select(CL=mm, n=nn, var=vv, tt, Genus)


modernMeanGenusAll <- SumTortAll %>%
  ungroup() %>%
  select(CL, n, tt) %>%
  filter( !is.na(CL)) %>%
  group_by(tt) %>%
  summarise(mm = mean(CL), vv=var(CL), nn=n())

#bis hier alle modernen taxa zusammengefasst (summarised and MFN_testudinidae)


GenusPaleoAll <- modernMeanGenusAll %>%
  bind_rows(GenusMeanAll)%>%
  arrange(tt)


#kable(GenusPaleoAll)


paleoGenAll <-as.paleoTS(GenusPaleoAll$mm, GenusPaleoAll$vv, GenusPaleoAll$nn, GenusPaleoAll$tt, MM = NULL, genpars = NULL, label = "Testudinidae body size evolution mode", reset.time=TRUE)

plot(paleoGenAll)


```

```{r "Model-fitting, genera, all, no bins" , echo=FALSE, message=FALSE, include=FALSE}

PaleoGenAllFit <- (fit3models(paleoGenAll, silent=FALSE, method="AD", pool=FALSE))

#PaleoGenAllFit2 <- (fit4models(paleoGenAll, silent=FALSE, method="AD", pool=FALSE))

```



```{r "Model-fitting, genera, all, no bins, table", echo=FALSE}

kable(PaleoGenAllFit, caption="Model-fitting results for testudinidae, no bins, genera")

```

\newpage
### continental (no bins)



```{r "paleoTS with different time bins, no bins, genera, continental", echo=FALSE, fig.cap="Mean age of each sample as time bin, genera, continental"}

GenusMeanAll <- testRatio %>%
#  merge(BINS) %>%
#  filter(EpochBins != "Modern") %>%  # & EpochBins != "Upper Miocene"
  filter(Island == "n") %>%
  filter(!is.na(CL)) %>%
  group_by(Age, Genus) %>%
  summarise(meanCL = mean(CL), n=n()) %>%
#  ungroup() %>%
#  group_by(EpochBins) %>%
  summarise(mm = mean(meanCL), nn=n(), vv=var(meanCL)) %>%
 # merge(BINS) %>%
  select(mm, nn, vv, tt=Age)
  
GenusMeanAll[is.na(GenusMeanAll)]<-0



# GenusModernAll <- testRatio %>%
# #  merge(BINS) %>%
# #  filter(EpochBins == "Modern") %>%
#   filter(!is.na(CL)) %>%
#   group_by(Genus) %>%
#   summarise(meanCL=mean(CL), sdCL=sd(CL), n=n(), Age=mean(Age), EpochBins=unique(EpochBins), MeanBins=unique(MeanBins)) #%>%
# #  summarise(mm=mean(meanCL), nn=n(), vv=var(meanCL), tt=mean(MeanBins))
# 
# GenusModernAll[is.na(GenusModernAll)]<-0


sumTort <- read.csv("tortoises_summary.csv", sep=";", header=TRUE)
colnames(sumTort)[7] <- "meanCL"
colnames(sumTort)[8] <- "sdCL"


sumTortoisesAll <- sumTort %>%
  dplyr::filter(Island == "n") %>%
  mutate(Genus= as.character(Genus)) %>%
  mutate(MeanBins=(Mamin+Mamax)/2) %>%
  select(Genus, MeanBins,  meanCL, sdCL, n) %>% #n,
  bind_rows(GenusMeanAll)


SumTortAll <- sumTortoisesAll %>%
  group_by(Genus) %>%
  mutate(tt=MeanBins, vv=sdCL^2, nn=n, mm=meanCL) %>%
  dplyr::select(mm, nn, vv, tt, Genus) %>%
  mutate(nx = nn*mm) %>%
  mutate(mmall=sum(nx)/sum(nn)) %>%
  mutate(SD=sqrt(nx), d=mm-mmall) %>%
  mutate(nsd=((nx^2+d^2)*nn)) %>%
  mutate(varall=sum(nsd)/sum(nn), n=sum(nn)) %>%
  dplyr::select(mm=mmall, vv=varall, nn=n, tt, Genus) %>%
  unique() %>%
  dplyr::select(CL=mm, n=nn, var=vv, tt, Genus)


modernMeanGenusAll <- SumTortAll %>%
  ungroup() %>%
  select(CL, n, tt) %>%
  filter( !is.na(CL)) %>%
  group_by(tt) %>%
  summarise(mm = mean(CL), vv=var(CL), nn=n())

#bis hier alle modernen taxa zusammengefasst (summarised and MFN_testudinidae)


GenusPaleoAll <- modernMeanGenusAll %>%
  bind_rows(GenusMeanAll)%>%
  arrange(tt)


#kable(GenusPaleoAll)


paleoGenAll <-as.paleoTS(GenusPaleoAll$mm, GenusPaleoAll$vv, GenusPaleoAll$nn, GenusPaleoAll$tt, MM = NULL, genpars = NULL, label = "Testudinidae body size evolution mode", reset.time=TRUE)

plot(paleoGenAll)


```

```{r "Model-fitting, genera, all, no bins, continental" , echo=FALSE, message=FALSE, include=FALSE}

PaleoGenAllFit <- (fit3models(paleoGenAll, silent=FALSE, method="AD", pool=FALSE))

#PaleoGenAllFit2 <- (fit4models(paleoGenAll, silent=FALSE, method="AD", pool=FALSE))

```



```{r "Model-fitting, genera, all, no bins, continental, table", echo=FALSE}

kable(PaleoGenAllFit, caption="Model-fitting results for testudinidae, no bins, genera, continental")

```


\newpage
### insular (no bins)



```{r "paleoTS with different time bins, no bins, genera, insular", echo=FALSE, fig.cap="Mean age of each sample as time bin, genera, insular"}

GenusMeanAll <- testRatio %>%
#  merge(BINS) %>%
#  filter(EpochBins != "Modern") %>%  # & EpochBins != "Upper Miocene"
  filter(Island == "y") %>%
  filter(!is.na(CL)) %>%
  group_by(Age, Genus) %>%
  summarise(meanCL = mean(CL), n=n()) %>%
#  ungroup() %>%
#  group_by(EpochBins) %>%
  summarise(mm = mean(meanCL), nn=n(), vv=var(meanCL)) %>%
 # merge(BINS) %>%
  select(mm, nn, vv, tt=Age)
  
GenusMeanAll[is.na(GenusMeanAll)]<-0



# GenusModernAll <- testRatio %>%
# #  merge(BINS) %>%
# #  filter(EpochBins == "Modern") %>%
#   filter(!is.na(CL)) %>%
#   group_by(Genus) %>%
#   summarise(meanCL=mean(CL), sdCL=sd(CL), n=n(), Age=mean(Age), EpochBins=unique(EpochBins), MeanBins=unique(MeanBins)) #%>%
# #  summarise(mm=mean(meanCL), nn=n(), vv=var(meanCL), tt=mean(MeanBins))
# 
# GenusModernAll[is.na(GenusModernAll)]<-0


sumTort <- read.csv("tortoises_summary.csv", sep=";", header=TRUE)
colnames(sumTort)[7] <- "meanCL"
colnames(sumTort)[8] <- "sdCL"


sumTortoisesAll <- sumTort %>%
  dplyr::filter(Island == "y") %>%
  mutate(Genus= as.character(Genus)) %>%
  mutate(MeanBins=(Mamin+Mamax)/2) %>%
  select(Genus, MeanBins,  meanCL, sdCL, n) %>% #n,
  bind_rows(GenusMeanAll)


SumTortAll <- sumTortoisesAll %>%
  group_by(Genus) %>%
  mutate(tt=MeanBins, vv=sdCL^2, nn=n, mm=meanCL) %>%
  dplyr::select(mm, nn, vv, tt, Genus) %>%
  mutate(nx = nn*mm) %>%
  mutate(mmall=sum(nx)/sum(nn)) %>%
  mutate(SD=sqrt(nx), d=mm-mmall) %>%
  mutate(nsd=((nx^2+d^2)*nn)) %>%
  mutate(varall=sum(nsd)/sum(nn), n=sum(nn)) %>%
  dplyr::select(mm=mmall, vv=varall, nn=n, tt, Genus) %>%
  unique() %>%
  dplyr::select(CL=mm, n=nn, var=vv, tt, Genus)


modernMeanGenusAll <- SumTortAll %>%
  ungroup() %>%
  select(CL, n, tt) %>%
  filter( !is.na(CL)) %>%
  group_by(tt) %>%
  summarise(mm = mean(CL), vv=var(CL), nn=n())

#bis hier alle modernen taxa zusammengefasst (summarised and MFN_testudinidae)

modernMeanGenusAll[is.na(modernMeanGenusAll)] <- 0

GenusPaleoAll <- modernMeanGenusAll %>%
  bind_rows(GenusMeanAll)%>%
  arrange(tt)


#kable(GenusPaleoAll)


paleoGenAll <-as.paleoTS(GenusPaleoAll$mm, GenusPaleoAll$vv, GenusPaleoAll$nn, GenusPaleoAll$tt, MM = NULL, genpars = NULL, label = "Testudinidae body size evolution mode", reset.time=TRUE)

plot(paleoGenAll)


```

```{r "Model-fitting, genera, all, no bins, insular" , echo=FALSE, message=FALSE, include=FALSE}

PaleoGenAllFit <- (fit3models(paleoGenAll, silent=FALSE, method="AD", pool=FALSE))

#PaleoGenAllFit2 <- (fit4models(paleoGenAll, silent=FALSE, method="AD", pool=FALSE))

```



```{r "Model-fitting, genera, all, no bins, insular, table", echo=FALSE}

kable(PaleoGenAllFit, caption="Model-fitting results for testudinidae, no bins, genera, insular")

```



\newpage

## Equal time bins
### individuals (equal bins)

```{r "Play around with time bins, larger equal bins, individuals", echo=FALSE, fig.cap="Equal bins, individuals"}

Alternative <- testRatio

Alternative$bin <- cut(Alternative$Age, c(0:50.000, breaks=0.0005))


AltBins <- data.frame(c( (0+0.0005)/2,(0.0005+1)/2,   (1+2)/2,  (2+3)/2, (3+4)/2,  (4+5)/2, (5+6)/2,   
(6+7)/2,  (7+8)/2,  (8+9)/2,  (9+10)/2,   
(10+11)/2,  (11+12)/2, (12+13)/2,  (13+14)/2,  (14+15)/2,  (15+16)/2,  (16+17)/2,   (17+18)/2,
(18+19)/2,  (19+20)/2,  (23+24)/2,   (25+26)/2,  (32+33)/2,   (33+34)/2,    (49+50)/2      ))

names(AltBins) <- "bins"



ABins <- Alternative %>%
  select(bin) %>%
  unique() %>%
  arrange(bin)


AltMeanBins <- bind_cols(ABins,AltBins)



AlterPaleo <- Alternative %>%
  merge(AltMeanBins) 

#names(AlterPaleo) <- c("Taxon", "CL", "extraCL", "PL", "size", "estimated", "Age", "Island", "Continent", "Genus", "bin", "tt")

paleoAlternative <- AlterPaleo %>%
  select(CL, tt=bins) %>%
  filter( !is.na(CL)) %>%
  group_by(tt) %>%
  summarise(mm = mean(CL), vv=var(CL), nn=n())


paleoAlternative[is.na(paleoAlternative)] <- 0

#kable(paleoAlternative, caption="Time bins with age range, epoch name, mean age and corresponding sample sizes (on individual, species and genus level)")

paleoAlter <-as.paleoTS(paleoAlternative$mm, paleoAlternative$vv, paleoAlternative$nn, paleoAlternative$tt, MM = NULL, genpars = NULL, label = "Testudinidae body size evolution mode, equal bins, individuals", reset.time=TRUE)

plot(paleoAlter)


```

```{r "Model-fitting, different time bins, individuals" , echo=FALSE, message=FALSE, include=FALSE}

paleoAlterFit <- (fit3models(paleoAlter, silent=FALSE, method="AD", pool=FALSE))
```



```{r "Model-fitting, different time bins, individuals, table", echo=FALSE}

kable(paleoAlterFit, caption="Model-fitting results for testudinidae, equal time bins, individuals")

```

\newpage

### species (equal bins)

```{r "Play around with time bins, equal bin, species level", echo=FALSE, fig.cap="Equal bins, species"}

Alternative <- testRatio

Alternative$bin <- cut(Alternative$Age, c(0:50.000, breaks=0.0005))


AltBins <- data.frame(c( (0+0.0005)/2,(0.0005+1)/2,   (1+2)/2,  (2+3)/2, (3+4)/2,  (4+5)/2, (5+6)/2,   
(6+7)/2,  (7+8)/2,  (8+9)/2,  (9+10)/2,   
(10+11)/2,  (11+12)/2, (12+13)/2,  (13+14)/2,  (14+15)/2,  (15+16)/2,  (16+17)/2,   (17+18)/2,
(18+19)/2,  (19+20)/2,  (23+24)/2,   (25+26)/2,  (32+33)/2,   (33+34)/2,    (49+50)/2      ))

names(AltBins) <- "bins"



ABins <- Alternative %>%
  select(bin) %>%
  unique() %>%
  arrange(bin)


AltMeanBins <- bind_cols(ABins,AltBins)



AlterPaleo <- Alternative %>%
  merge(AltMeanBins) 

#names(AlterPaleo) <- c("Taxon", "CL", "extraCL", "PL", "size", "estimated", "Age", "Island", "Continent", "Genus", "bin", "tt")

paleoAlternativeSpecies <- AlterPaleo %>%
  select(CL, tt=bins, Taxon) %>%
  filter( !is.na(CL)) %>%
  group_by(Taxon, tt) %>%
  summarise(meanCL = mean(CL), varCL=var(CL), n=n())


paleoAlternativeSpecies[is.na(paleoAlternativeSpecies)] <- 0

SpeciesAlter <- paleoAlternativeSpecies %>%
  ungroup() %>%
  select(meanCL, tt) %>%
  group_by(tt) %>%
  summarise(mm = mean(meanCL), vv=var(meanCL), nn=n()) %>%
  arrange(tt)

SpeciesAlter[is.na(SpeciesAlter)] <- 0  


#kable(SpeciesAlter, caption="Time bins with age range, epoch name, mean age and corresponding sample sizes (on individual, species and genus level)")

SpeciesAlt <-as.paleoTS(SpeciesAlter$mm, SpeciesAlter$vv, SpeciesAlter$nn, SpeciesAlter$tt, MM = NULL, genpars = NULL, label = "Testudinidae body size evolution mode", reset.time=TRUE)

plot(SpeciesAlt)


```

```{r "Model-fitting, different time bins, species" , echo=FALSE, message=FALSE, include=FALSE}

SpeciesAltFit <- (fit3models(SpeciesAlt, silent=FALSE, method="AD", pool=FALSE))
```



```{r "Model-fitting, different time bins, species, table", echo=FALSE}

kable(SpeciesAltFit, caption="Model-fitting results for testudinidae, equal time bins, species")

```

\newpage

### genera (equal bins)

```{r "Play around with time bins, generic level", echo=FALSE, fig.cap="Equal bins, genera"}

Alternative <- testRatio

Alternative$bin <- cut(Alternative$Age, c(0:50.000, breaks=0.0005))


AltBins <- data.frame(c( (0+0.0005)/2,(0.0005+1)/2,   (1+2)/2,  (2+3)/2, (3+4)/2,  (4+5)/2, (5+6)/2,   
(6+7)/2,  (7+8)/2,  (8+9)/2,  (9+10)/2,   
(10+11)/2,  (11+12)/2, (12+13)/2,  (13+14)/2,  (14+15)/2,  (15+16)/2,  (16+17)/2,   (17+18)/2,
(18+19)/2,  (19+20)/2,  (23+24)/2,   (25+26)/2,  (32+33)/2,   (33+34)/2,    (49+50)/2      ))

names(AltBins) <- "bins"



ABins <- Alternative %>%
  select(bin) %>%
  unique() %>%
  arrange(bin)


AltMeanBins <- bind_cols(ABins,AltBins)



AlterPaleo <- Alternative %>%
  merge(AltMeanBins) 

#names(AlterPaleo) <- c("Taxon", "CL", "extraCL", "PL", "size", "estimated", "Age", "Island", "Continent", "Genus", "bin", "tt")

paleoAlternativeGenus <- AlterPaleo %>%
  select(CL, tt=bins, Genus) %>%
  filter( !is.na(CL)) %>%
  group_by(Genus, tt) %>%
  summarise(meanCL = mean(CL), varCL=var(CL), n=n())


paleoAlternativeGenus[is.na(paleoAlternativeGenus)] <- 0

GenusAlter <- paleoAlternativeGenus %>%
  ungroup() %>%
  select(meanCL, tt) %>%
  group_by(tt) %>%
  summarise(mm = mean(meanCL), vv=var(meanCL), nn=n()) %>%
  arrange(tt)

GenusAlter[is.na(GenusAlter)] <- 0  


#kable(GenusAlter, caption="Time bins with age range, epoch name, mean age and corresponding sample sizes (on individual, species and genus level)")

GenusAlt <-as.paleoTS(GenusAlter$mm, GenusAlter$vv, GenusAlter$nn, GenusAlter$tt, MM = NULL, genpars = NULL, label = "Testudinidae body size evolution mode", reset.time=TRUE)

plot(GenusAlt)


```

```{r "Model-fitting, different time bins, genera" , echo=FALSE, message=FALSE, include=FALSE}

GenusAltFit <- (fit3models(GenusAlt, silent=FALSE, method="AD", pool=FALSE))
```



```{r "Model-fitting, different time bins, genera, table", echo=FALSE}

kable(GenusAltFit, caption="Model-fitting results for testudinidae, equal time bins, genera")

```

\newpage
## larger equal bins
### genera (larger equal bins)


```{r "Play around with larger time bins, generic level", echo=FALSE, fig.cap="Larger equal bins, genera"}

Alternative <- testRatio

Alternative$bin <- cut(Alternative$Age, c(0:50.000))


AltBins <- data.frame(c( (0+1)/2,  (1+2)/2,  (2+3)/2, (3+4)/2,  (4+5)/2, (5+6)/2,   
(6+7)/2,  (7+8)/2,  (8+9)/2,  (9+10)/2,   
(10+11)/2,  (11+12)/2, (12+13)/2,  (13+14)/2,  (14+15)/2,  (15+16)/2,  (16+17)/2,   (17+18)/2,
(18+19)/2,  (19+20)/2,  (23+24)/2,   (25+26)/2,  (32+33)/2,   (33+34)/2,    (49+50)/2      ))

names(AltBins) <- "bins"



ABins <- Alternative %>%
  select(bin) %>%
  unique() %>%
  arrange(bin)


AltMeanBins <- bind_cols(ABins,AltBins)



AlterPaleo <- Alternative %>%
  merge(AltMeanBins) 

#names(AlterPaleo) <- c("Taxon", "CL", "extraCL", "PL", "size", "estimated", "Age", "Island", "Continent", "Genus", "bin", "tt")

paleoAlternativeGenus <- AlterPaleo %>%
  select(CL, tt=bins, Genus) %>%
  filter( !is.na(CL)) %>%
  group_by(Genus, tt) %>%
  summarise(meanCL = mean(CL), varCL=var(CL), n=n())


paleoAlternativeGenus[is.na(paleoAlternativeGenus)] <- 0

GenusAlter <- paleoAlternativeGenus %>%
  ungroup() %>%
  select(meanCL, tt) %>%
  group_by(tt) %>%
  summarise(mm = mean(meanCL), vv=var(meanCL), nn=n()) %>%
  arrange(tt)

GenusAlter[is.na(GenusAlter)] <- 0  


#kable(GenusAlter, caption="Time bins with age range, epoch name, mean age and corresponding sample sizes (on individual, species and genus level)")

GenusAlt <-as.paleoTS(GenusAlter$mm, GenusAlter$vv, GenusAlter$nn, GenusAlter$tt, MM = NULL, genpars = NULL, label = "Testudinidae body size evolution mode", reset.time=TRUE)

plot(GenusAlt)


```

```{r "Model-fitting, larger time bins, genus" , echo=FALSE, message=FALSE, include=FALSE}

GenusAltFit <- (fit3models(GenusAlt, silent=FALSE, method="AD", pool=FALSE))
```



```{r "Model-fitting, larger time bins, genus, table", echo=FALSE}

kable(GenusAltFit, caption="Model-fitting results for testudinidae, larger equal time bins, genera")

```


\newpage
## per continent



### Africa, individuals



```{r "paleoTS, individuals, Africa", echo=FALSE, message=FALSE, fig.cap="Africa, individuals"}
Africa <- PleiPlioCL %>%
  filter(!is.na(CL)) %>%
  merge(Continents) %>%
  filter(Con=="Africa") %>%
  select( CL, EpochBins) %>%  #Genus,
  group_by(EpochBins) %>%   #, Genus
  summarise(meanCL=mean(CL), n=n())

AfCon <- PleiPlioCL %>%
  dplyr::select(CL, MeanBins, Continent) %>%
  filter(!is.na(CL)) %>%
  merge(Continents) %>%
  filter(Continent=="Africa") %>%
 # dplyr::filter(PleiPlioCL$Island == "n") %>%
  mutate(tt= MeanBins) %>% # create mean age
  group_by(tt) %>% #create time bins
  summarise(mm=mean(CL), vv=var(CL), nn=n()) #create means etc. for each time bin 

AfCon[is.na(AfCon)]<-0 #subset NAs with O for n=1


sumTort <- read.csv("tortoises_summary.csv", sep=";", header=TRUE)

SumTortCon <- sumTort %>%
  merge(Continents) %>%
  filter(Continent=="Africa") %>%
  mutate(tt=(Mamin+Mamax)/2, vv=sdCLmm^2, nn=n, mm=meanCLmm) %>%
  dplyr::select(mm, nn, vv, tt)
 
AfriCon <- bind_rows(SumTortCon,AfCon) #ExTort, 

combiCLCon <- AfriCon %>%
  dplyr::filter(tt==0.0000005) %>%   #maybe find a way to automatically filter double tt values...
  mutate(nx = nn*mm) %>%
  mutate(mmall=sum(nx)/sum(nn)) %>%
  mutate(SD=sqrt(nx), d=mm-mmall) %>%
  mutate(nsd=((nx^2+d^2)*nn)) %>%
  mutate(varall=sum(nsd)/sum(nn), n=sum(nn)) %>%
  dplyr::select(mm=mmall, vv=varall, nn=n, tt) %>%
  unique() %>%
  dplyr::select(mm, nn, vv, tt)


AfricaCon <- AfriCon %>%
  filter(tt !=0.0000005) %>%
  bind_rows(combiCLCon)%>%
  arrange(tt)



#kable(AfricaCon, caption="paleoTS object (mm= mean CL, nn = sample size, vv = variance (CL), tt = Age)")



paleoAfricaCon <-as.paleoTS(AfricaCon$mm, AfricaCon$vv, AfricaCon$nn, AfricaCon$tt, MM = NULL, genpars = NULL, label = "Testudinidae body size evolution mode")
#paleoPPCL
plot(paleoAfricaCon)
```




```{r "Model-fitting, individuals, Africa" , echo=FALSE, message=FALSE, include=FALSE}

paleoAfricaConFit <- (fit3models(paleoAfricaCon, silent=FALSE, method="AD", pool=FALSE))
```



```{r "Model-fitting, individuals, Africa, table", echo=FALSE}

kable(paleoAfricaConFit, caption="Model-fitting results for testudinidae, individuals, Africa")

```

\newpage 

### Africa, no bins, individuals

```{r "paleoTS, no bins individuals, Africa", echo=FALSE, message=FALSE, fig.cap="Africa, individuals, no bins"}
Africa <- testRatio %>%
  filter(!is.na(CL)) %>%
  merge(Continents) %>%
  filter(Con=="Africa") %>%
#  select( CL, Age) %>%  #Genus,
#  group_by(EpochBins) %>%   #, Genus
  group_by(Age) %>%
  summarise(meanCL=mean(CL), n=n())

AfCon <- testRatio%>%
  dplyr::select(CL, Age, Continent) %>%
  filter(!is.na(CL)) %>%
  merge(Continents) %>%
  filter(Continent=="Africa") %>%
 # dplyr::filter(PleiPlioCL$Island == "n") %>%
  mutate(tt= Age) %>% # create mean age
  group_by(tt) %>% #create time bins
  summarise(mm=mean(CL), vv=var(CL), nn=n()) #create means etc. for each time bin 

AfCon[is.na(AfCon)]<-0 #subset NAs with O for n=1


sumTort <- read.csv("tortoises_summary.csv", sep=";", header=TRUE)

SumTortCon <- sumTort %>%
  merge(Continents) %>%
  filter(Continent=="Africa") %>%
  mutate(tt=(Mamin+Mamax)/2, vv=sdCLmm^2, nn=n, mm=meanCLmm) %>%
  dplyr::select(mm, nn, vv, tt)
 
AfriCon <- bind_rows(SumTortCon,AfCon) #ExTort, 

combiCLCon <- AfriCon %>%
  dplyr::filter(tt==0.0000005) %>%   #maybe find a way to automatically filter double tt values...
  mutate(nx = nn*mm) %>%
  mutate(mmall=sum(nx)/sum(nn)) %>%
  mutate(SD=sqrt(nx), d=mm-mmall) %>%
  mutate(nsd=((nx^2+d^2)*nn)) %>%
  mutate(varall=sum(nsd)/sum(nn), n=sum(nn)) %>%
  dplyr::select(mm=mmall, vv=varall, nn=n, tt) %>%
  unique() %>%
  dplyr::select(mm, nn, vv, tt)


AfricaCon <- AfriCon %>%
  filter(tt !=0.0000005) %>%
  bind_rows(combiCLCon)%>%
  arrange(tt)



#kable(AfricaCon, caption="paleoTS object (mm= mean CL, nn = sample size, vv = variance (CL), tt = Age)")



paleoAfricaCon <-as.paleoTS(AfricaCon$mm, AfricaCon$vv, AfricaCon$nn, AfricaCon$tt, MM = NULL, genpars = NULL, label = "Testudinidae body size evolution mode")
#paleoPPCL
plot(paleoAfricaCon)
```




```{r "Model-fitting, individuals, no bins, Africa" , echo=FALSE, message=FALSE, include=FALSE}

paleoAfricaConFit <- (fit3models(paleoAfricaCon, silent=FALSE, method="AD", pool=FALSE))
```



```{r "Model-fitting, individuals, no bins, Africa, table", echo=FALSE}

kable(paleoAfricaConFit, caption="Model-fitting results for testudinidae, individuals, no bins, Africa")

```


\newpage 
### Africa, no bins, genera

```{r "paleoTS with different time bins, no bins, genera, Africa", echo=FALSE, fig.cap="Mean age of each sample as time bin, genera, Africa"}

GenusMeanAll <- testRatio %>%
#  merge(BINS) %>%
#  filter(EpochBins != "Modern") %>%  # & EpochBins != "Upper Miocene"
  merge(Continents) %>%
  filter(Con == "Africa") %>%
  filter(!is.na(CL)) %>%
  group_by(Age, Genus) %>%
  summarise(meanCL = mean(CL), n=n()) %>%
#  ungroup() %>%
#  group_by(EpochBins) %>%
  summarise(mm = mean(meanCL), nn=n(), vv=var(meanCL)) %>%
 # merge(BINS) %>%
  select(mm, nn, vv, tt=Age)
  
GenusMeanAll[is.na(GenusMeanAll)]<-0



sumTort <- read.csv("tortoises_summary.csv", sep=";", header=TRUE)
colnames(sumTort)[7] <- "meanCL"
colnames(sumTort)[8] <- "sdCL"


sumTortoisesAll <- sumTort %>%
#  dplyr::filter(Island == "y") %>%
  merge(Continents) %>%
  filter(Con== "Africa") %>%
  mutate(Genus= as.character(Genus)) %>%
  mutate(MeanBins=(Mamin+Mamax)/2) %>%
  select(Genus, MeanBins,  meanCL, sdCL, n) #%>% #n,
#  bind_rows(GenusMeanAll)


SumTortAll <- sumTortoisesAll %>%
  group_by(Genus) %>%
  mutate(tt=MeanBins, vv=sdCL^2, nn=n, mm=meanCL) %>%
  dplyr::select(mm, nn, vv, tt, Genus) %>%
  mutate(nx = nn*mm) %>%
  mutate(mmall=sum(nx)/sum(nn)) %>%
  mutate(SD=sqrt(nx), d=mm-mmall) %>%
  mutate(nsd=((nx^2+d^2)*nn)) %>%
  mutate(varall=sum(nsd)/sum(nn), n=sum(nn)) %>%
  dplyr::select(mm=mmall, vv=varall, nn=n, tt, Genus) %>%
  unique() %>%
  dplyr::select(CL=mm, n=nn, var=vv, tt, Genus)


modernMeanGenusAll <- SumTortAll %>%
  ungroup() %>%
  select(CL, n, tt) %>%
  filter( !is.na(CL)) %>%
  group_by(tt) %>%
  summarise(mm = mean(CL), vv=var(CL), nn=n())

#bis hier alle modernen taxa zusammengefasst (summarised and MFN_testudinidae)


GenusPaleoAll <- modernMeanGenusAll %>%
  bind_rows(GenusMeanAll)%>%
  arrange(tt)

GenusPaleoAll[is.na(GenusPaleoAll)] <- 0

#kable(GenusPaleoAll)


paleoGenAll <-as.paleoTS(GenusPaleoAll$mm, GenusPaleoAll$vv, GenusPaleoAll$nn, GenusPaleoAll$tt, MM = NULL, genpars = NULL, label = "Testudinidae body size evolution mode", reset.time=TRUE)

plot(paleoGenAll)


```

```{r "Model-fitting, genera, all, no bins, Africa" , echo=FALSE, message=FALSE, include=FALSE}

PaleoGenAllFit <- (fit3models(paleoGenAll, silent=FALSE, method="AD", pool=FALSE))

#PaleoGenAllFit2 <- (fit4models(paleoGenAll, silent=FALSE, method="AD", pool=FALSE))

```



```{r "Model-fitting, genera, all, no bins, Africa, table", echo=FALSE}

kable(PaleoGenAllFit, caption="Model-fitting results for testudinidae, no bins, genera")

```



\newpage
### Europe, individuals



```{r "paleoTS, individuals, Europe", echo=FALSE, message=FALSE, fig.cap="Europe, individuals"}
Europe <- PleiPlioCL %>%
  filter(!is.na(CL)) %>%
  merge(Continents) %>%
  filter(Con=="Europe") %>%
  select(CL, EpochBins) %>%
  group_by(EpochBins) %>%
  summarise(meanCL=mean(CL), n=n())



EuropeCon <- PleiPlioCL %>%
  dplyr::select(CL, MeanBins, Continent) %>%
  filter(!is.na(CL)) %>%
  merge(Continents) %>%
  filter(Con=="Europe") %>%
 # dplyr::filter(PleiPlioCL$Island == "n") %>%
  mutate(tt= MeanBins) %>% # create mean age
  group_by(tt) %>% #create time bins
  summarise(mm=mean(CL), vv=var(CL), nn=n()) #create means etc. for each time bin 

EuropeCon[is.na(EuropeCon)]<-0 #subset NAs with O for n=1



#kable(EuropeCon, caption="paleoTS object (mm= mean CL, nn = sample size, vv = variance (CL), tt = Age)")


#library(paleoTS)
paleoEuropeCon <-as.paleoTS(EuropeCon$mm, EuropeCon$vv, EuropeCon$nn, EuropeCon$tt, MM = NULL, genpars = NULL, label = "Testudinidae body size evolution mode")
#paleoPPCL
plot(paleoEuropeCon)
```




```{r "Model-fitting, individuals, Europe" , echo=FALSE, message=FALSE, include=FALSE}

PaleoEuropeConFit <- (fit3models(paleoEuropeCon, silent=FALSE, method="AD", pool=FALSE))


PaleoEuropeConFit2 <- (fit4models(paleoEuropeCon, silent=FALSE, method="AD", pool=FALSE))
```



```{r "Model-fitting, individuals, Europe, table", echo=FALSE}

kable(PaleoEuropeConFit, caption="Model-fitting results for testudinidae, individuals, Europe")

kable(PaleoEuropeConFit2, caption="Model-fitting results for testudinidae, individuals, Europe")


```


\newpage 

### Europe, no bins, individuals

```{r "paleoTS, no bins individuals, Europe", echo=FALSE, message=FALSE, fig.cap="Europe, individuals, no bins"}
Europe <- testRatio %>%
  filter(!is.na(CL)) %>%
  merge(Continents) %>%
  filter(Con=="Europe") %>%
#  select( CL, Age) %>%  #Genus,
#  group_by(EpochBins) %>%   #, Genus
  group_by(Age) %>%
  summarise(meanCL=mean(CL), n=n())

EuCon <- testRatio%>%
  dplyr::select(CL, Age, Continent) %>%
  filter(!is.na(CL)) %>%
  merge(Continents) %>%
  filter(Continent=="Europe") %>%
 # dplyr::filter(PleiPlioCL$Island == "n") %>%
  mutate(tt= Age) %>% # create mean age
  group_by(tt) %>% #create time bins
  summarise(mm=mean(CL), vv=var(CL), nn=n()) #create means etc. for each time bin 

EuCon[is.na(EuCon)]<-0 #subset NAs with O for n=1


sumTort <- read.csv("tortoises_summary.csv", sep=";", header=TRUE)

SumTortCon <- sumTort %>%
  merge(Continents) %>%
  filter(Continent=="Europe") %>%
  mutate(tt=(Mamin+Mamax)/2, vv=sdCLmm^2, nn=n, mm=meanCLmm) %>%
  dplyr::select(mm, nn, vv, tt)
 
EuroCon <- bind_rows(SumTortCon,EuCon) #ExTort, 

combiCLCon <- EuroCon %>%
  dplyr::filter(tt==0.0000005) %>%   #maybe find a way to automatically filter double tt values...
  mutate(nx = nn*mm) %>%
  mutate(mmall=sum(nx)/sum(nn)) %>%
  mutate(SD=sqrt(nx), d=mm-mmall) %>%
  mutate(nsd=((nx^2+d^2)*nn)) %>%
  mutate(varall=sum(nsd)/sum(nn), n=sum(nn)) %>%
  dplyr::select(mm=mmall, vv=varall, nn=n, tt) %>%
  unique() %>%
  dplyr::select(mm, nn, vv, tt)


EuropeCon <- EuroCon %>%
  filter(tt !=0.0000005) %>%
  bind_rows(combiCLCon)%>%
  arrange(tt)



#kable(EuropeCon, caption="paleoTS object (mm= mean CL, nn = sample size, vv = variance (CL), tt = Age)")



paleoEuropeCon <-as.paleoTS(EuropeCon$mm, EuropeCon$vv, EuropeCon$nn, EuropeCon$tt, MM = NULL, genpars = NULL, label = "Testudinidae body size evolution mode")
#paleoPPCL
plot(paleoEuropeCon)
```




```{r "Model-fitting, individuals, no bins, Europe" , echo=FALSE, message=FALSE, include=FALSE}

paleoEuropeConFit <- (fit3models(paleoEuropeCon, silent=FALSE, method="AD", pool=FALSE))

#paleoEuropeConFit2 <- (fit4models(paleoEuropeCon, silent=FALSE, method="AD", pool=FALSE))

```



```{r "Model-fitting, individuals, no bins, Europe, table", echo=FALSE}

kable(paleoEuropeConFit, caption="Model-fitting results for testudinidae, individuals, no bins, Europe")

```


\newpage 
### Europe, no bins, genera

```{r "paleoTS with different time bins, no bins, genera, Europe", echo=FALSE, fig.cap="Mean age of each sample as time bin, genera,Europe"}

GenusMeanAll <- testRatio %>%
#  merge(BINS) %>%
#  filter(EpochBins != "Modern") %>%  # & EpochBins != "Upper Miocene"
  merge(Continents) %>%
  filter(Con == "Europe") %>%
  filter(!is.na(CL)) %>%
  group_by(Age, Genus) %>%
  summarise(meanCL = mean(CL), n=n()) %>%
#  ungroup() %>%
#  group_by(EpochBins) %>%
  summarise(mm = mean(meanCL), nn=n(), vv=var(meanCL)) %>%
 # merge(BINS) %>%
  select(mm, nn, vv, tt=Age)
  
GenusMeanAll[is.na(GenusMeanAll)]<-0



# sumTort <- read.csv("tortoises_summary.csv", sep=";", header=TRUE)
# colnames(sumTort)[7] <- "meanCL"
# colnames(sumTort)[8] <- "sdCL"
# 
# 
# sumTortoisesAll <- sumTort %>%
# #  dplyr::filter(Island == "y") %>%
#   merge(Continents) %>%
#   filter(Con== "Europe") %>%
#   mutate(Genus= as.character(Genus)) %>%
#   mutate(MeanBins=(Mamin+Mamax)/2) %>%
#   select(Genus, MeanBins,  meanCL, sdCL, n) %>% #n,
#   bind_rows(GenusMeanAll)
# 
# 
# SumTortAll <- sumTortoisesAll %>%
#   group_by(Genus) %>%
#   mutate(tt=MeanBins, vv=sdCL^2, nn=n, mm=meanCL) %>%
#   dplyr::select(mm, nn, vv, tt, Genus) %>%
#   mutate(nx = nn*mm) %>%
#   mutate(mmall=sum(nx)/sum(nn)) %>%
#   mutate(SD=sqrt(nx), d=mm-mmall) %>%
#   mutate(nsd=((nx^2+d^2)*nn)) %>%
#   mutate(varall=sum(nsd)/sum(nn), n=sum(nn)) %>%
#   dplyr::select(mm=mmall, vv=varall, nn=n, tt, Genus) %>%
#   unique() %>%
#   dplyr::select(CL=mm, n=nn, var=vv, tt, Genus)
# 
# 
# modernMeanGenusAll <- SumTortAll %>%
#   ungroup() %>%
#   select(CL, n, tt) %>%
#   filter( !is.na(CL)) %>%
#   group_by(tt) %>%
#   summarise(mm = mean(CL), vv=var(CL), nn=n())

#bis hier alle modernen taxa zusammengefasst (summarised and MFN_testudinidae)


# GenusPaleoAll <- modernMeanGenusAll %>%
#   bind_rows(GenusMeanAll)%>%
#   arrange(tt)

GenusPaleoAll <- GenusMeanAll

GenusPaleoAll[is.na(GenusPaleoAll)] <- 0

#kable(GenusPaleoAll)


paleoGenAll <-as.paleoTS(GenusPaleoAll$mm, GenusPaleoAll$vv, GenusPaleoAll$nn, GenusPaleoAll$tt, MM = NULL, genpars = NULL, label = "Testudinidae body size evolution mode", reset.time=TRUE)

plot(paleoGenAll)


```

```{r "Model-fitting, genera, all, no bins, Europe" , echo=FALSE, message=FALSE, include=FALSE}

PaleoGenAllFit <- (fit3models(paleoGenAll, silent=FALSE, method="AD", pool=FALSE))

#PaleoGenAllFit2 <- (fit4models(paleoGenAll, silent=FALSE, method="AD", pool=FALSE))

```



```{r "Model-fitting, genera, all, no bins, Europe, table", echo=FALSE}

kable(PaleoGenAllFit, caption="Model-fitting results for testudinidae, no bins, genera")

```





\newpage


### America, individuals (2nd try)



```{r "paleoTS, individuals, America", echo=FALSE, message=FALSE, fig.cap="Africa, individuals"}
America <- PleiPlioCL %>%
  filter(!is.na(CL)) %>%
  merge(Continents) %>%
  filter(Con=="America") %>%
  select( CL, EpochBins) %>%  #Genus,
  group_by(EpochBins) %>%   #, Genus
  summarise(meanCL=mean(CL), n=n())

AmerCon <- PleiPlioCL %>%
  dplyr::select(CL, MeanBins, Continent) %>%
  filter(!is.na(CL)) %>%
  merge(Continents) %>%
  filter(Con=="America") %>%
 # dplyr::filter(PleiPlioCL$Island == "n") %>%
  mutate(tt= MeanBins) %>% # create mean age
  group_by(tt) %>% #create time bins
  summarise(mm=mean(CL), vv=var(CL), nn=n()) #create means etc. for each time bin 



AmerCon[is.na(AmerCon)]<-0 #subset NAs with O for n=1


sumTort <- read.csv("tortoises_summary.csv", sep=";", header=TRUE)

SumTortCon <- sumTort %>%
  merge(Continents) %>%
  filter(Con=="America") %>%
  mutate(tt=(Mamin+Mamax)/2, vv=sdCLmm^2, nn=n, mm=meanCLmm) %>%
  dplyr::select(mm, nn, vv, tt) 
 
AmeriCon <- bind_rows(SumTortCon,AmerCon) #ExTort, 

combiCLCon <- AmeriCon %>%
  dplyr::filter(tt==0.0000005) %>%   #maybe find a way to automatically filter double tt values...
  mutate(nx = nn*mm) %>%
  mutate(mmall=sum(nx)/sum(nn)) %>%
  mutate(SD=sqrt(nx), d=mm-mmall) %>%
  mutate(nsd=((nx^2+d^2)*nn)) %>%
  mutate(varall=sum(nsd)/sum(nn), n=sum(nn)) %>%
  dplyr::select(mm=mmall, vv=varall, nn=n, tt) %>%
  unique() %>%
  dplyr::select(mm, nn, vv, tt)


AmericaCon <- AmeriCon %>%
  filter(tt !=0.0000005) %>%
  bind_rows(combiCLCon)%>%
  arrange(tt)



#kable(AmericaCon, caption="paleoTS object (mm= mean CL, nn = sample size, vv = variance (CL), tt = Age)")



paleoAmericaCon <-as.paleoTS(AmericaCon$mm, AmericaCon$vv, AmericaCon$nn, AmericaCon$tt, MM = NULL, genpars = NULL, label = "Testudinidae body size evolution mode")
#paleoPPCL
plot(paleoAmericaCon)
```
fits don't work, no idea why



```{r "Model-fitting, individuals, America" , echo=FALSE, message=FALSE, include=FALSE}

#paleoAmericaConFit <- (fit3models(paleoAmericaCon, silent=FALSE, pool=FALSE))
```



```{r "Model-fitting, individuals, America, table", echo=FALSE, include=FALSE}

#kable(paleoAmericaConFit, caption="Model-fitting results for testudinidae, individuals, Africa")

```

\newpage
### America, no bins, individuals

```{r "paleoTS, no bins individuals, America", echo=FALSE, message=FALSE, fig.cap="America, individuals, no bins"}
Africa <- testRatio %>%
  filter(!is.na(CL)) %>%
  merge(Continents) %>%
  filter(Con=="America") %>%
#  select( CL, Age) %>%  #Genus,
#  group_by(EpochBins) %>%   #, Genus
  group_by(Age) %>%
  summarise(meanCL=mean(CL), n=n())

AfCon <- testRatio%>%
  dplyr::select(CL, Age, Continent) %>%
  filter(!is.na(CL)) %>%
  merge(Continents) %>%
  filter(Con=="America") %>%
 # dplyr::filter(PleiPlioCL$Island == "n") %>%
  mutate(tt= Age) %>% # create mean age
  group_by(tt) %>% #create time bins
  summarise(mm=mean(CL), vv=var(CL), nn=n()) #create means etc. for each time bin 

AfCon[is.na(AfCon)]<-0 #subset NAs with O for n=1


sumTort <- read.csv("tortoises_summary.csv", sep=";", header=TRUE)

SumTortCon <- sumTort %>%
  merge(Continents) %>%
  filter(Con=="America") %>%
  mutate(tt=(Mamin+Mamax)/2, vv=sdCLmm^2, nn=n, mm=meanCLmm) %>%
  dplyr::select(mm, nn, vv, tt)
 
AfriCon <- bind_rows(SumTortCon,AfCon) #ExTort, 

combiCLCon <- AfriCon %>%
  dplyr::filter(tt==0.0000005) %>%   #maybe find a way to automatically filter double tt values...
  mutate(nx = nn*mm) %>%
  mutate(mmall=sum(nx)/sum(nn)) %>%
  mutate(SD=sqrt(nx), d=mm-mmall) %>%
  mutate(nsd=((nx^2+d^2)*nn)) %>%
  mutate(varall=sum(nsd)/sum(nn), n=sum(nn)) %>%
  dplyr::select(mm=mmall, vv=varall, nn=n, tt) %>%
  unique() %>%
  dplyr::select(mm, nn, vv, tt)


AfricaCon <- AfriCon %>%
  filter(tt !=0.0000005) %>%
  bind_rows(combiCLCon)%>%
  arrange(tt)



#kable(AfricaCon, caption="paleoTS object (mm= mean CL, nn = sample size, vv = variance (CL), tt = Age)")



paleoAfricaCon <-as.paleoTS(AfricaCon$mm, AfricaCon$vv, AfricaCon$nn, AfricaCon$tt, MM = NULL, genpars = NULL, label = "Testudinidae body size evolution mode")
#paleoPPCL
plot(paleoAfricaCon)
```




```{r "Model-fitting, individuals, no bins, America" , echo=FALSE, message=FALSE, include=FALSE}

paleoAfricaConFit <- (fit3models(paleoAfricaCon, silent=FALSE, method="AD", pool=FALSE))
```



```{r "Model-fitting, individuals, no bins, America, table", echo=FALSE}

kable(paleoAfricaConFit, caption="Model-fitting results for testudinidae, individuals, no bins, America")

```


\newpage 
### America, no bins, genera

```{r "paleoTS with different time bins, no bins, genera, America", echo=FALSE, fig.cap="Mean age of each sample as time bin, genera, America"}

GenusMeanAll <- testRatio %>%
#  merge(BINS) %>%
#  filter(EpochBins != "Modern") %>%  # & EpochBins != "Upper Miocene"
  merge(Continents) %>%
  filter(Con == "America") %>%
  filter(!is.na(CL)) %>%
  group_by(Age, Genus) %>%
  summarise(meanCL = mean(CL), n=n()) %>%
#  ungroup() %>%
#  group_by(EpochBins) %>%
  summarise(mm = mean(meanCL), nn=n(), vv=var(meanCL)) %>%
 # merge(BINS) %>%
  select(mm, nn, vv, tt=Age)
  
GenusMeanAll[is.na(GenusMeanAll)]<-0



sumTort <- read.csv("tortoises_summary.csv", sep=";", header=TRUE)
colnames(sumTort)[7] <- "meanCL"
colnames(sumTort)[8] <- "sdCL"


sumTortoisesAll <- sumTort %>%
#  dplyr::filter(Island == "y") %>%
  merge(Continents) %>%
  filter(Con== "America") %>%
  mutate(Genus= as.character(Genus)) %>%
  mutate(MeanBins=(Mamin+Mamax)/2) %>%
  select(Genus, MeanBins,  meanCL, sdCL, n) #%>% #n,
 # bind_rows(GenusMeanAll)


SumTortAll <- sumTortoisesAll %>%
  group_by(Genus) %>%
  mutate(tt=MeanBins, vv=sdCL^2, nn=n, mm=meanCL) %>%
  dplyr::select(mm, nn, vv, tt, Genus) %>%
  mutate(nx = nn*mm) %>%
  mutate(mmall=sum(nx)/sum(nn)) %>%
  mutate(SD=sqrt(nx), d=mm-mmall) %>%
  mutate(nsd=((nx^2+d^2)*nn)) %>%
  mutate(varall=sum(nsd)/sum(nn), n=sum(nn)) %>%
  dplyr::select(mm=mmall, vv=varall, nn=n, tt, Genus) %>%
  unique() %>%
  dplyr::select(CL=mm, n=nn, var=vv, tt, Genus)


modernMeanGenusAll <- SumTortAll %>%
  ungroup() %>%
  select(CL, n, tt) %>%
  filter( !is.na(CL)) %>%
  group_by(tt) %>%
  summarise(mm = mean(CL), vv=var(CL), nn=n())

#bis hier alle modernen taxa zusammengefasst (summarised and MFN_testudinidae)


GenusPaleoAll <- modernMeanGenusAll %>%
  bind_rows(GenusMeanAll)%>%
  arrange(tt)

GenusPaleoAll[is.na(GenusPaleoAll)] <- 0

#kable(GenusPaleoAll)


paleoGenAll <-as.paleoTS(GenusPaleoAll$mm, GenusPaleoAll$vv, GenusPaleoAll$nn, GenusPaleoAll$tt, MM = NULL, genpars = NULL, label = "Testudinidae body size evolution mode", reset.time=TRUE)

plot(paleoGenAll)


```

```{r "Model-fitting, genera, all, no bins, America" , echo=FALSE, message=FALSE, include=FALSE}

PaleoGenAllFit <- (fit3models(paleoGenAll, silent=FALSE, method="AD", pool=FALSE))

#PaleoGenAllFit2 <- (fit4models(paleoGenAll, silent=FALSE, method="AD", pool=FALSE))

```



```{r "Model-fitting, genera, all, no bins, America, table", echo=FALSE}

kable(PaleoGenAllFit, caption="Model-fitting results for testudinidae, no bins, genera")

```



\newpage
### Asia, individuals



```{r "paleoTS, individuals, Asia", echo=FALSE, message=FALSE, fig.cap="individuals, Asia"}


AsCon <- PleiPlioCL %>%
  dplyr::select(CL, MeanBins, Continent) %>%
  merge(Continents) %>%
  filter(Con=="Asia") %>%
 # dplyr::filter(PleiPlioCL$Island == "n") %>%
  mutate(tt= MeanBins) %>% # create mean age
  group_by(tt) %>% #create time bins
  summarise(mm=mean(CL), vv=var(CL), nn=n()) #create means etc. for each time bin 

AsCon[is.na(AsCon)]<-0 #subset NAs with O for n=1


sumTort <- read.csv("tortoises_summary.csv", sep=";", header=TRUE)

SumTortCon <- sumTort %>%
  merge(Continents) %>%
  filter(Con=="Asia") %>%
  mutate(tt=(Mamin+Mamax)/2, vv=sdCLmm^2, nn=n, mm=meanCLmm) %>%
  dplyr::select(mm, nn, vv, tt)
 
#AsiCon <- bind_rows(SumTortCon,PPCLCon) #ExTort, 

combiCLCon <- SumTortCon %>%
  dplyr::filter(tt==0.0000005) %>%   #maybe find a way to automatically filter double tt values...
  mutate(nx = nn*mm) %>%
  mutate(mmall=sum(nx)/sum(nn)) %>%
  mutate(SD=sqrt(nx), d=mm-mmall) %>%
  mutate(nsd=((nx^2+d^2)*nn)) %>%
  mutate(varall=sum(nsd)/sum(nn), n=sum(nn)) %>%
  dplyr::select(mm=mmall, vv=varall, nn=n, tt) %>%
  unique() %>%
  dplyr::select(mm, nn, vv, tt)


AsiaCon <- AsCon %>%
  filter(tt !=0.0000005) %>%
  bind_rows(combiCLCon)%>%
  arrange(tt)



#kable(AsiaCon, caption="paleoTS object (mm= mean CL, nn = sample size, vv = variance (CL), tt = Age)")


#library(paleoTS)
paleoAsiaCon <-as.paleoTS(AsiaCon$mm, AsiaCon$vv, AsiaCon$nn, AsiaCon$tt, MM = NULL, genpars = NULL, label = "Testudinidae body size evolution mode, Asia")
#paleoPPCL
plot(paleoAsiaCon)
```




```{r "Model-fitting, individuals, Asia" , echo=FALSE, message=FALSE, include=FALSE}

PaleoAsiaConFit <- (fit3models(paleoAsiaCon, silent=FALSE, method="AD", pool=FALSE))
```



```{r "Model-fitting, individuals, Asia, table", echo=FALSE}

kable(PaleoAsiaConFit, caption="Model-fitting results for testudinidae, individuals, Asia")

```

\newpage


### Asia, no bins, individuals

```{r "paleoTS, no bins individuals, Asia", echo=FALSE, message=FALSE, fig.cap="Asia, individuals, no bins"}
Africa <- testRatio %>%
  filter(!is.na(CL)) %>%
  merge(Continents) %>%
  filter(Con=="Asia") %>%
#  select( CL, Age) %>%  #Genus,
#  group_by(EpochBins) %>%   #, Genus
  group_by(Age) %>%
  summarise(meanCL=mean(CL), n=n())

AfCon <- testRatio%>%
  dplyr::select(CL, Age, Continent) %>%
  filter(!is.na(CL)) %>%
  merge(Continents) %>%
  filter(Con=="Asia") %>%
 # dplyr::filter(PleiPlioCL$Island == "n") %>%
  mutate(tt= Age) %>% # create mean age
  group_by(tt) %>% #create time bins
  summarise(mm=mean(CL), vv=var(CL), nn=n()) #create means etc. for each time bin 

AfCon[is.na(AfCon)]<-0 #subset NAs with O for n=1


sumTort <- read.csv("tortoises_summary.csv", sep=";", header=TRUE)

SumTortCon <- sumTort %>%
  merge(Continents) %>%
  filter(Con=="Asia") %>%
  mutate(tt=(Mamin+Mamax)/2, vv=sdCLmm^2, nn=n, mm=meanCLmm) %>%
  dplyr::select(mm, nn, vv, tt)
 
AfriCon <- bind_rows(SumTortCon,AfCon) #ExTort, 

combiCLCon <- AfriCon %>%
  dplyr::filter(tt==0.0000005) %>%   #maybe find a way to automatically filter double tt values...
  mutate(nx = nn*mm) %>%
  mutate(mmall=sum(nx)/sum(nn)) %>%
  mutate(SD=sqrt(nx), d=mm-mmall) %>%
  mutate(nsd=((nx^2+d^2)*nn)) %>%
  mutate(varall=sum(nsd)/sum(nn), n=sum(nn)) %>%
  dplyr::select(mm=mmall, vv=varall, nn=n, tt) %>%
  unique() %>%
  dplyr::select(mm, nn, vv, tt)


AfricaCon <- AfriCon %>%
  filter(tt !=0.0000005) %>%
  bind_rows(combiCLCon)%>%
  arrange(tt)



#kable(AfricaCon, caption="paleoTS object (mm= mean CL, nn = sample size, vv = variance (CL), tt = Age)")



paleoAfricaCon <-as.paleoTS(AfricaCon$mm, AfricaCon$vv, AfricaCon$nn, AfricaCon$tt, MM = NULL, genpars = NULL, label = "Testudinidae body size evolution mode")
#paleoPPCL
plot(paleoAfricaCon)
```




```{r "Model-fitting, individuals, no bins, Asia" , echo=FALSE, message=FALSE, include=FALSE}

paleoAfricaConFit <- (fit3models(paleoAfricaCon, silent=FALSE, method="AD", pool=FALSE))
```



```{r "Model-fitting, individuals, no bins, Asia, table", echo=FALSE}

kable(paleoAfricaConFit, caption="Model-fitting results for testudinidae, individuals, no bins, Asia")

```


\newpage 
### Asia, no bins, genera

```{r "paleoTS with different time bins, no bins, genera, Asia", echo=FALSE, fig.cap="Mean age of each sample as time bin, genera, Asia"}

GenusMeanAll <- testRatio %>%
#  merge(BINS) %>%
#  filter(EpochBins != "Modern") %>%  # & EpochBins != "Upper Miocene"
  merge(Continents) %>%
  filter(Con == "Asia") %>%
  filter(!is.na(CL)) %>%
  group_by(Age, Genus) %>%
  summarise(meanCL = mean(CL), n=n()) %>%
#  ungroup() %>%
#  group_by(EpochBins) %>%
  summarise(mm = mean(meanCL), nn=n(), vv=var(meanCL)) %>%
 # merge(BINS) %>%
  select(mm, nn, vv, tt=Age)
  
GenusMeanAll[is.na(GenusMeanAll)]<-0



sumTort <- read.csv("tortoises_summary.csv", sep=";", header=TRUE)
colnames(sumTort)[7] <- "meanCL"
colnames(sumTort)[8] <- "sdCL"


sumTortoisesAll <- sumTort %>%
#  dplyr::filter(Island == "y") %>%
  merge(Continents) %>%
  filter(Con== "Asia") %>%
  mutate(Genus= as.character(Genus)) %>%
  mutate(MeanBins=(Mamin+Mamax)/2) %>%
  select(Genus, MeanBins,  meanCL, sdCL, n) #%>% #n,
 # bind_rows(GenusMeanAll)


SumTortAll <- sumTortoisesAll %>%
  group_by(Genus) %>%
  mutate(tt=MeanBins, vv=sdCL^2, nn=n, mm=meanCL) %>%
  dplyr::select(mm, nn, vv, tt, Genus) %>%
  mutate(nx = nn*mm) %>%
  mutate(mmall=sum(nx)/sum(nn)) %>%
  mutate(SD=sqrt(nx), d=mm-mmall) %>%
  mutate(nsd=((nx^2+d^2)*nn)) %>%
  mutate(varall=sum(nsd)/sum(nn), n=sum(nn)) %>%
  dplyr::select(mm=mmall, vv=varall, nn=n, tt, Genus) %>%
  unique() %>%
  dplyr::select(CL=mm, n=nn, var=vv, tt, Genus)


modernMeanGenusAll <- SumTortAll %>%
  ungroup() %>%
  select(CL, n, tt) %>%
  filter( !is.na(CL)) %>%
  group_by(tt) %>%
  summarise(mm = mean(CL), vv=var(CL), nn=n())

#bis hier alle modernen taxa zusammengefasst (summarised and MFN_testudinidae)


GenusPaleoAll <- modernMeanGenusAll %>%
  bind_rows(GenusMeanAll)%>%
  arrange(tt)

GenusPaleoAll[is.na(GenusPaleoAll)] <- 0

#kable(GenusPaleoAll)


paleoGenAll <-as.paleoTS(GenusPaleoAll$mm, GenusPaleoAll$vv, GenusPaleoAll$nn, GenusPaleoAll$tt, MM = NULL, genpars = NULL, label = "Testudinidae body size evolution mode", reset.time=TRUE)

plot(paleoGenAll)


```

```{r "Model-fitting, genera, all, no bins, Asia" , echo=FALSE, message=FALSE, include=FALSE}

PaleoGenAllFit <- (fit3models(paleoGenAll, silent=FALSE, method="AD", pool=FALSE))

#PaleoGenAllFit2 <- (fit4models(paleoGenAll, silent=FALSE, method="AD", pool=FALSE))

```



```{r "Model-fitting, genera, all, no bins, Asia, table", echo=FALSE}

kable(PaleoGenAllFit, caption="Model-fitting results for testudinidae, no bins, genera")

```



\newpage
### Eurasia, individuals



```{r "paleoTS, individuals, Eurasia", echo=FALSE, message=FALSE, fig.cap="individuals, Eurasia"}


EACon <- PleiPlioCL %>%
  dplyr::select(CL, MeanBins, Continent) %>%
  merge(Continents) %>%
  filter(!is.na(CL)) %>%
  filter(Con=="Asia" | Con == "Europe") %>%
 # dplyr::filter(PleiPlioCL$Island == "n") %>%
  mutate(tt= MeanBins) %>% # create mean age
  group_by(tt) %>% #create time bins
  summarise(mm=mean(CL), vv=var(CL), nn=n()) #create means etc. for each time bin 

EACon[is.na(EACon)]<-0 #subset NAs with O for n=1


sumTort <- read.csv("tortoises_summary.csv", sep=";", header=TRUE)

SumTortCon <- sumTort %>%
  merge(Continents) %>%
  filter(Con=="Asia" | Con=="Europe") %>%
 # filter(!is.na(CL)) %>%
  mutate(tt=(Mamin+Mamax)/2, vv=sdCLmm^2, nn=n, mm=meanCLmm) %>%
  dplyr::select(mm, nn, vv, tt)
 
EurCon <- bind_rows(SumTortCon,EACon) #ExTort, 

combiCLCon <- PPESCLCon %>%
  dplyr::filter(tt==0.0000005) %>%   #maybe find a way to automatically filter double tt values...
  mutate(nx = nn*mm) %>%
  mutate(mmall=sum(nx)/sum(nn)) %>%
  mutate(SD=sqrt(nx), d=mm-mmall) %>%
  mutate(nsd=((nx^2+d^2)*nn)) %>%
  mutate(varall=sum(nsd)/sum(nn), n=sum(nn)) %>%
  dplyr::select(mm=mmall, vv=varall, nn=n, tt) %>%
  unique() %>%
  dplyr::select(mm, nn, vv, tt)

EurasiaCon <- EurCon %>%
  filter(tt !=0.0000005) %>%
  bind_rows(combiCLCon)%>%
  arrange(tt)



#kable(EurasiaCon, caption="paleoTS object (mm= mean CL, nn = sample size, vv = variance (CL), tt = Age)")


paleoEurasiaCon <-as.paleoTS(EurasiaCon$mm, EurasiaCon$vv, EurasiaCon$nn, EurasiaCon$tt, MM = NULL, genpars = NULL, label = "Testudinidae body size evolution mode, Eurasia")
#paleoPPCL
plot(paleoEurasiaCon)
```




```{r "Model-fitting, individuals, Eurasia" , echo=FALSE, message=FALSE, include=FALSE}
PaleoEurasiaConFit <- (fit3models(paleoEurasiaCon, silent=FALSE, method="AD", pool=FALSE))

PaleoEurasiaConFit2 <- (fit4models(paleoEurasiaCon, silent=FALSE, method="AD", pool=FALSE))
```



```{r "Model-fitting, individuals, Eurasia, table", echo=FALSE}

kable(PaleoEurasiaConFit, caption="Model-fitting results for testudinidae, individuals, Asia")

kable(PaleoEurasiaConFit2, caption="Model-fitting results for testudinidae (4 models), individuals, Asia")

```

\newpage
### Eurasia, no bins, individuals

```{r "paleoTS, no bins individuals, Eurasia", echo=FALSE, message=FALSE, fig.cap="Eurasia, individuals, no bins"}
Africa <- testRatio %>%
  filter(!is.na(CL)) %>%
  merge(Continents) %>%
  filter(Con=="Asia" | Con == "Europe") %>%
#  select( CL, Age) %>%  #Genus,
#  group_by(EpochBins) %>%   #, Genus
  group_by(Age) %>%
  summarise(meanCL=mean(CL), n=n())

AfCon <- testRatio%>%
  dplyr::select(CL, Age, Continent) %>%
  filter(!is.na(CL)) %>%
  merge(Continents) %>%
  filter(Con=="Asia" | Con == "Europe") %>%
 # dplyr::filter(PleiPlioCL$Island == "n") %>%
  mutate(tt= Age) %>% # create mean age
  group_by(tt) %>% #create time bins
  summarise(mm=mean(CL), vv=var(CL), nn=n()) #create means etc. for each time bin 

AfCon[is.na(AfCon)]<-0 #subset NAs with O for n=1


sumTort <- read.csv("tortoises_summary.csv", sep=";", header=TRUE)

SumTortCon <- sumTort %>%
  merge(Continents) %>%
  filter(Con=="Asia" | Con == "Europe") %>%
  mutate(tt=(Mamin+Mamax)/2, vv=sdCLmm^2, nn=n, mm=meanCLmm) %>%
  dplyr::select(mm, nn, vv, tt)
 
AfriCon <- bind_rows(SumTortCon,AfCon) #ExTort, 

combiCLCon <- AfriCon %>%
  dplyr::filter(tt==0.0000005) %>%   #maybe find a way to automatically filter double tt values...
  mutate(nx = nn*mm) %>%
  mutate(mmall=sum(nx)/sum(nn)) %>%
  mutate(SD=sqrt(nx), d=mm-mmall) %>%
  mutate(nsd=((nx^2+d^2)*nn)) %>%
  mutate(varall=sum(nsd)/sum(nn), n=sum(nn)) %>%
  dplyr::select(mm=mmall, vv=varall, nn=n, tt) %>%
  unique() %>%
  dplyr::select(mm, nn, vv, tt)


AfricaCon <- AfriCon %>%
  filter(tt !=0.0000005) %>%
  bind_rows(combiCLCon)%>%
  arrange(tt)



#kable(AfricaCon, caption="paleoTS object (mm= mean CL, nn = sample size, vv = variance (CL), tt = Age)")



paleoAfricaCon <-as.paleoTS(AfricaCon$mm, AfricaCon$vv, AfricaCon$nn, AfricaCon$tt, MM = NULL, genpars = NULL, label = "Testudinidae body size evolution mode")
#paleoPPCL
plot(paleoAfricaCon)
```




```{r "Model-fitting, individuals, no bins, Eurasia" , echo=FALSE, message=FALSE, include=FALSE}

paleoAfricaConFit <- (fit3models(paleoAfricaCon, silent=FALSE, method="AD", pool=FALSE))

```



```{r "Model-fitting, individuals, no bins, Eurasia, table", echo=FALSE}

kable(paleoAfricaConFit, caption="Model-fitting results for testudinidae, individuals, no bins, Eurasia")

```


\newpage 
### Eurasia, no bins, genera

```{r "paleoTS with different time bins, no bins, genera, Eurasia", echo=FALSE, fig.cap="Mean age of each sample as time bin, genera, Eurasia"}

GenusMeanAll <- testRatio %>%
#  merge(BINS) %>%
#  filter(EpochBins != "Modern") %>%  # & EpochBins != "Upper Miocene"
  merge(Continents) %>%
  filter(Con == "Asia" | Con == "Europe") %>%
  filter(!is.na(CL)) %>%
  group_by(Age, Genus) %>%
  summarise(meanCL = mean(CL), n=n()) %>%
#  ungroup() %>%
#  group_by(EpochBins) %>%
  summarise(mm = mean(meanCL), nn=n(), vv=var(meanCL)) %>%
 # merge(BINS) %>%
  select(mm, nn, vv, tt=Age)
  
GenusMeanAll[is.na(GenusMeanAll)]<-0



sumTort <- read.csv("tortoises_summary.csv", sep=";", header=TRUE)
colnames(sumTort)[7] <- "meanCL"
colnames(sumTort)[8] <- "sdCL"


sumTortoisesAll <- sumTort %>%
#  dplyr::filter(Island == "y") %>%
  merge(Continents) %>%
  filter(Con== "Asia" | Con == "Europe") %>%
  mutate(Genus= as.character(Genus)) %>%
  mutate(MeanBins=(Mamin+Mamax)/2) %>%
  select(Genus, MeanBins,  meanCL, sdCL, n) #%>% #n,
 # bind_rows(GenusMeanAll)


SumTortAll <- sumTortoisesAll %>%
  group_by(Genus) %>%
  mutate(tt=MeanBins, vv=sdCL^2, nn=n, mm=meanCL) %>%
  dplyr::select(mm, nn, vv, tt, Genus) %>%
  mutate(nx = nn*mm) %>%
  mutate(mmall=sum(nx)/sum(nn)) %>%
  mutate(SD=sqrt(nx), d=mm-mmall) %>%
  mutate(nsd=((nx^2+d^2)*nn)) %>%
  mutate(varall=sum(nsd)/sum(nn), n=sum(nn)) %>%
  dplyr::select(mm=mmall, vv=varall, nn=n, tt, Genus) %>%
  unique() %>%
  dplyr::select(CL=mm, n=nn, var=vv, tt, Genus)


modernMeanGenusAll <- SumTortAll %>%
  ungroup() %>%
  select(CL, n, tt) %>%
  filter( !is.na(CL)) %>%
  group_by(tt) %>%
  summarise(mm = mean(CL), vv=var(CL), nn=n())

#bis hier alle modernen taxa zusammengefasst (summarised and MFN_testudinidae)


GenusPaleoAll <- modernMeanGenusAll %>%
  bind_rows(GenusMeanAll)%>%
  arrange(tt)

GenusPaleoAll[is.na(GenusPaleoAll)] <- 0

#kable(GenusPaleoAll)


paleoGenAll <-as.paleoTS(GenusPaleoAll$mm, GenusPaleoAll$vv, GenusPaleoAll$nn, GenusPaleoAll$tt, MM = NULL, genpars = NULL, label = "Testudinidae body size evolution mode", reset.time=TRUE)

plot(paleoGenAll)


```

```{r "Model-fitting, genera, all, no bins, Eurasia" , echo=FALSE, message=FALSE, include=FALSE}

PaleoGenAllFit <- (fit3models(paleoGenAll, silent=FALSE, method="AD", pool=FALSE))

#PaleoGenAllFit2 <- (fit4models(paleoGenAll, silent=FALSE, method="AD", pool=FALSE))

```



```{r "Model-fitting, genera, all, no bins, Eurasia, table", echo=FALSE}

kable(PaleoGenAllFit, caption="Model-fitting results for testudinidae, no bins, genera")

```

