---
title: "MAthesis"
#author: "Julia Joos"
#date: "14 August 2017"
output: 
  pdf_document:
   # classoption: landscape
    toc: true
   # toc_depth: 2
   # number_sections: true
    fig_caption: true
    df_print: kable
   # fontsize: 12pt
   # geometry: margin=1in
   # documentclass: scrartcl
   # mainfont: Helvetica
  # citation_package: natbib
    keep_tex: true
  

header-includes:
    - \usepackage{setspace}
    - \doublespacing
#     
# includes:
#       before_body: titlepage.tex
    
---

```{r "setup", include=FALSE}
require("knitr")
#opts_knit$set(root.dir = "//naturkundemuseum-berlin.de/MuseumDFSRoot/Benutzer/Julia.Joos/Eigene Dateien/MA")
## on laptop: 
opts_knit$set(root.dir = "C:/Users/Jule/Documents/Uni/MA")
library(dplyr)
library(ggplot2)
library(paleoTS)
library(stats)
library(moments)
```




```{r "import data set", echo=FALSE}
#### Data basis - import data set from Excel ####
setwd("C:/Users/Jule/Documents/Uni/MA")
tidyCL<-read.csv("tortoises_tidy.csv", sep=";", header=TRUE)

#####prepare for analysis (fix column names in .csv-file after converting table from excel####
colnames(tidyCL)[6] <- "MAmin"
colnames(tidyCL)[7] <- "Mamax"
colnames(tidyCL)[17] <- "CL"
colnames(tidyCL)[18] <- "PL"
colnames(tidyCL)[21] <- "estimated"

tidyCL <-  tidyCL %>%
  mutate(Age= ((MAmin)+(as.numeric(Mamax)))/2)  #%>%
  # filter(estimated=="m" | estimated=="mo"| estimated=="mf") #%>%
  # filter(!is.na(CL))

####### import extant data ####
extant <- read.csv("MFN_testudinidae.csv", sep=";", header=TRUE, dec=".", na.strings = "NA", stringsAsFactors=FALSE)  # file: MFN_testudinidae.csv

colnames(extant)[5] <- "SCL"
colnames(extant)[11] <- "PL"
colnames(extant)[12] <- "PLmid"



Extant <- extant %>%
  mutate(CL = SCL * 10, PL=PL*10, PLmid=PLmid*10) 
```


```{r "estimating CL from PL", echo=FALSE, results='asis'}
CLPLtidy <- tidyCL %>%
  filter(!is.na(CL) & !is.na(PL)) %>%
  dplyr::select(Taxon, CL, PL, size, Age, Island, Continent, Genus) %>%
  mutate(ratio=CL/PL) %>%
  group_by(Taxon) %>% #to show ratios per Taxon, leave out to get a total ratio
  summarise(meanRatio=round(mean(ratio),2), sdRatio=round(sd(ratio),2), n=n(), min=min(ratio), max=max(ratio))

CLPLextant <- Extant %>%
  filter(!is.na(CL) & !is.na(PL)) %>%
  dplyr::select(Taxon=Species, CL, PL, PLmid, Island, Continent, Genus) %>%
  mutate(ratio=CL/PL, ratioMid=CL/PLmid)
  #group_by(Taxon) %>% #to show ratios per Taxon, leave out to get a total ratio
  #  summarise(meanRatio=round(mean(ratio),2), sdRatio=round(sd(ratio),2), n=n(), min=min(ratio), max=max(ratio))

Ratio <- CLPLextant %>%
  summarise(meanRatio=round(mean(ratio),2), sdRatio=round(sd(ratio),2), n=n(), min=min(ratio), max=max(ratio))

RatioSpecies <- CLPLextant %>%
  group_by(Taxon) %>% #to show ratios per Taxon, leave out to get a total ratio
  summarise(meanRatio=round(mean(ratio),2), sdRatio=round(sd(ratio),2), n=n(), min=min(ratio), max=max(ratio))


fossil <- tidyCL %>%
  mutate(Taxon=as.character(Taxon), Island=as.character(Island), Continent=as.character(Continent), estimated=as.character(estimated), Genus=as.character(Genus)) %>%
  dplyr::select(Taxon, CL, PL, size, estimated, Age, Island, Continent, Genus)
  
modern <- Extant %>%
  dplyr::select(Taxon=Species, CL, PL, estimated, Age, Island, Continent, Genus)

All <- bind_rows(modern, fossil)

testRatio <- All %>% #tidyCL
  dplyr::select(Taxon, CL, PL, size, estimated, Age, Island, Continent, Genus) %>%
  mutate(extraCL = PL*Ratio$meanRatio) %>%
  dplyr::select(Taxon, CL, extraCL, PL, size, estimated, Age, Island, Continent, Genus)

testRatio$CL[is.na(testRatio$CL)] <- testRatio$extraCL[is.na(testRatio$CL)]
```



# Time bins (stratigraphic stages)

```{r "Bin data, smaller bins", echo=FALSE}
Miocene <- testRatio %>% #testRatio or tidyCL 
  filter(Age < 23.000)

# PleiPlio$bin <- cut(PleiPlio$Age, c(0, 0.000001, 0.0117, 0.126, 0.781, 2.588, 3.6, 5.332, 11.608))
# 
# EpochBins <- as.vector(c("Modern", "Modern", "Upper Pleistocene", "Middle Pleistocene", "Lower Pleistocene", "Upper Pliocene", "Lower Pliocene", "Upper Miocene"))
# 
# 
# MeanBins <- as.vector(c((0+0.000001)/2, (0+0.0117)/2, (0.0117+0.126)/2, (0.126+0.781)/2, (0.781+2.588)/2,(2.588+3.6)/2, (3.6+5.332)/2, (5.332+11.608)/2))


# new cuts: 1.806, 4.466, 7.424, 9.516, 13.789, 18

Miocene$bin <- cut(Miocene$Age, c(0, 0.0117, 0.126, 0.781, 1.806, 2.588, 3.6,
                                  5.332, 7.246, 11.608, 13.82, 15.97, 23.03))




EpochBins <- as.vector(c("Modern", "Upper Pleistocene", "Middle Pleistocene", "Lower Pleistocene", "Gelasian", "Piacencian", "Zanclean", "Messinian","Tortonian", "Serravallian","Langhian",
                         "Burdigalian/Aquitanian"))

Stages <- as.vector(c("Modern", "Upper Pleistocene", "Middle Pleistocene", "Lower Pleistocene", "Lower Pleistocene", "Upper Pliocene", "Lower Pliocene", "Upper Miocene","Upper Miocene",
                      "Middle Miocene","Middle Miocene", "Lower Miocene"))


MeanBins <- as.vector(c((0+0.0117)/2, (0.0117+0.126)/2, (0.126+0.781)/2, (0.781+1.806)/2, (1.806+2.588)/2,(2.588+3.6)/2, (3.6+5.332)/2, (5.332+7.246)/2, (7.246+11.608)/2, (11.608+13.82)/2, (13.82+15.97)/2, (15.97+23.03)/2))

#1.806, 4.466, 7.424, 9.516, 13.789, 18


BinsMio <- Miocene %>%
  select(bin) %>%
  group_by(bin) %>%
  summarise(nIndividuals=n())

BinsSpeciesMio <- Miocene %>%
  select(bin, Taxon) %>%
  group_by(bin, Taxon) %>%
  summarise(nSpecies=n()) %>%
  summarise(nSpecies=n())


BinsGeneraMio <- Miocene %>%
  select(bin, Genus) %>%
  group_by(bin, Genus) %>%
  summarise(nGenera=n()) %>%
  summarise(nGenera=n())

bin <- as.vector(unique(BinsMio$bin))



BINSMio <- data.frame(bin, EpochBins, Stages, MeanBins) %>%
  merge(BinsMio) %>%
  merge(BinsSpeciesMio) %>%
  merge(BinsGeneraMio) %>%
  arrange(MeanBins)

 BINSMio$EpochBins = factor(BINSMio$EpochBins, 
                           levels= c("Modern", "Upper Pleistocene", "Middle Pleistocene", "Lower Pleistocene", "Gelasian", "Piacencian", "Zanclean", "Messinian","Tortonian", "Serravallian","Langhian",
                         "Burdigalian/Aquitanian" ))

#BINS <- read.table("timebins.txt", sep="\t", header=TRUE)

#kable(Bins, caption="Time bins with corresponding sample sizes (individuals)")

kable(BINSMio, caption="Smaller time bins with age range, epoch name, mean age and corresponding sample sizes (on individual, species and genus level)")

PleiPlioCL <- Miocene %>%
  merge(BINSMio) %>%
  filter(!is.na(CL))

# SUM <- PleiPlioCL %>%
#   group_by(MeanBins) %>%
#   summarise(n=n())

na <- PleiPlioCL$EpochBins[!complete.cases(PleiPlioCL$EpochBins)]


  
```



```{r "overviewData", echo=FALSE, fig.cap="Scatterplot of carapace length over time, indicating insular (triangle) and continental (circles) and colour indicating continents. Lines indicate stratigraphic stages which were used as time bins, the dashed line is the border between the two stages of the Lower Miocene, which were consideres as one time bin. "}

#Get overview over data set

Continent <- as.vector(unique(PleiPlioCL$Continent))
Con <- as.vector(c("Asia", "Africa", "Europe", "America", "America", "America", "Europe"))#
Continents <- data.frame(Continent, Con)



scatter <- testRatio %>%
  filter(!is.na(CL)) %>%
  filter(Age < 23.000) %>%
  merge(Continents) %>%
  select(CL, Age, Island, Con, estimated) %>%
  ggplot(aes(Age, CL)) + geom_jitter(aes(shape=Island, colour= Con)) +
  theme_classic() +
  geom_vline(xintercept = c(0, 0.0117, 0.126, 0.781, 1.806, 2.588, 3.6,
                                  5.332, 7.246, 11.608, 13.82, 15.97, 23.03))+
  # geom_vline(xintercept= c(0, 0.0117, 0.126, 0.781, 2.588, 3.6, 5.332, 11.608, 15.97, 23.03)) +
   geom_vline(xintercept= 20.44, linetype="dashed")  +
  scale_color_manual(values=c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7") , name="Continents")+
  scale_shape_manual(values= c(16, 17), name="Insularity", breaks=c("continental", "insular")) +
  xlab("Age [mya]") + ylab("Carapace length [mm]")
  # 


scatter

#length(scatter$CL)


```

\newpage

# Maps
## fossil occurences of testudinidae

```{r "MapFossilOccurrences", echo=FALSE, fig.cap="Map displaying all fossil occurrences of testudinids, with color indicating whether relevant literature was available (black if not) and if it was, whether body size data was available or not (yes and no, respectively)."}

CL <- tidyCL %>%
#  filter(Age < 11.000) %>%
  dplyr::select(Locality, Genus, Taxon, Latitude, Longitude, Country, Age) %>%
  group_by(Locality) %>%
  mutate(count= n())


FossilOccurrences<-read.csv("tortoises_occurrences.csv", sep=";", header=TRUE)

FossOcc <- FossilOccurrences %>%
  mutate(Age= (as.numeric(as.character(MA.min)) + as.numeric(as.character(Ma.max)))/2) %>%
  select(Locality, Country, Latitude, Longitude, Age, Genus, Taxon, Clavailability) %>%
#  merge(tidyCL) %>%
  group_by(Locality) %>%
  mutate(count= n(), Longitude=as.numeric(as.character(Longitude)))


#na <- FossOcc[!complete.cases(FossOcc),]

# OccMap <-  merge(Map, FossOcc, by="Locality", incomparables=TRUE) %>%
#  distinct()
  
# unique(CL$Locality) #wie viele localities
#length(unique(FossOcc$Locality[which(FossOcc$Clavailability == "yes")]))


mapWorld <- borders("world", colour="azure3", fill="azure3") # create a layer of borders, run line at the beginning (before loading plotly)

cbbPalette <- c("#000000", "#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

OwnPalette <- c("#000000", "#000000", "#56B4E9")

mapOc <- FossOcc %>%
  ggplot(aes(Longitude, Latitude)) +# borders("world", ylim = c(-60, 90)) +
  mapWorld +
  theme_classic() +
  geom_point(data=FossOcc, alpha=1/4,(aes(as.numeric(Longitude), Latitude, colour=FossOcc$Clavailability))) +
  geom_point(data=CL, alpha=1/2,(aes(Longitude, Latitude, colour="yes"))) +
  theme(legend.position="none") +
  scale_colour_manual(values=OwnPalette) #cbbPalette

#unique(FossOcc$CL)

mapOc

# require(plotly)
# ggplotly(mapOc)




# length(CL$Locality)
# length(unique(CL$Locality)) #wie viele localities
# length(unique(FossOcc$Locality[which(FossOcc$Clavailability == "yes")]))



```

\newpage
## body size of testudinidae

```{r "MapCL", echo=FALSE, fig.cap="Map displaying all localities for which body size data for testudinids was available in the literature. Size of points denotes sample size, color denotes approximate age."}


tidyCL$bin <- cut(tidyCL$Age, c(0, 0.0117, 0.126, 0.781, 1.806, 2.588, 3.6,
                                  5.332, 7.246, 11.608, 13.82, 15.97, 20.44, 23.03)
)
                  
  #                c(0, 0.000001, 0.0117, 0.126, 0.781, 2.588, 3.6, 5.332, 11.608, 15.97, 23.03,50.000))





MapCL <- tidyCL %>%
  merge(BINSMio) %>%
#  filter(Age < 23.000) %>%
#  filter(Latitude != "-") %>%
  dplyr::select(Genus, Taxon, Latitude, Longitude, Country, CL, PL, MeanBins, size) %>%
  group_by(Latitude) %>%
  mutate(count= n()) 


mapWorld <- borders("world", colour="azure3", fill="azure3") # create a layer of borders, run line at the beginning (before loading plotly)


mapCL <- MapCL %>%
  ggplot(aes(Longitude, Latitude)) +# borders("world", ylim = c(-60, 90)) +
  mapWorld +
  theme_classic() +
  geom_point(aes(Longitude, Latitude,size=count, colour=MeanBins)) +  #colour=size, 
  scale_colour_gradientn(colors=c("orange", "red", "purple", "blue", "green", "yellow"))



mapCL


```




```{r "Get overview over sample sizes", echo=FALSE}
OverviewSpecies <- PleiPlioCL %>%
  filter(EpochBins != "Modern") %>%
  group_by(EpochBins, Taxon) %>%
  summarise(n=n(), meanCL = mean(CL))

kable(OverviewSpecies, caption="Overview over fossil species per time bin, with sample size and mean CL.")

OverviewSpeciesFossil <- PleiPlioCL %>%
  filter(EpochBins != "Modern") %>%
  group_by(Taxon) %>%
  summarise(n=n(), meanCL = mean(CL))

#write.table(OverviewSpecies,file="OverviewSpeciesSampleSize.txt", sep="\t", row.names = FALSE) 
kable(OverviewSpeciesFossil, caption="General overview over fossil species, with sample size and mean CL")

OverviewGeneraTime <- PleiPlioCL %>%
  group_by(EpochBins, Genus) %>%
  summarise(n=n(), meanCL = mean(CL))

kable(OverviewGeneraTime, caption="Overview over genera (modern and fossil) per time bin, with sample sizes and mean CL.")


OverviewGenera <- PleiPlioCL %>%
  group_by(Genus) %>%
  summarise(n=n(), meanCL = mean(CL))

kable(OverviewGenera, caption="General overview over genera, with sample sizes and mean CL.")

```

\newpage

# Sampling Accumulation Curves

```{r "SACSpecies", echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Species Accumulation Curve of fossil species per Locality and reference"}

#Species Accumulation Curve



veganSL <- tidyCL %>%
  dplyr::select(Locality, Taxon) %>%
  group_by(Locality, Taxon) %>%
  summarise(n=n()) %>%
  tidyr::spread(Taxon, n, fill=0)

library(vegan)

#par(mfrow = c(2, 1))

veganSL=veganSL[,-1]
veganspSL=specaccum(veganSL,method="rarefaction", permutations=1000)
plot(veganspSL,xlab="Localities",ylab="Richness", xvar="individuals", ci.type="line", ci.lty=2, ci.col="grey", col="deepskyblue4", lwd=2 )



veganSR <- tidyCL %>%
  dplyr::select(Reference, Taxon) %>%
  group_by(Reference, Taxon) %>%
  summarise(n=n()) %>%
  tidyr::spread(Taxon, n, fill=0)

library(vegan)

veganSR=veganSR[,-1]
veganspSR=specaccum(veganSR,method="rarefaction", permutations=1000)
plot(veganspSR,xlab="References",ylab="Richness", xvar="individuals", ci.type="line", ci.lty=2, ci.col="grey", col="deepskyblue4", lwd=2)


```



```{r "SACGenera", echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Sampling Accumulation Curve of fossil genera per reference"}

veganGL <- tidyCL %>%
  dplyr::select(Locality, Genus) %>%
  group_by(Locality, Genus) %>%
  summarise(n=n()) %>%
  tidyr::spread(Genus, n, fill=0)




#par(mfrow = c(2, 1))


veganGL=veganGL[,-1]
veganspGL=specaccum(veganGL,method="rarefaction", permutations=1000)
# plot(veganspGL,xlab="Localities",ylab="Richness", xvar="individuals", ci.type="line", ci.lty=2, ci.col="grey", col="deepskyblue4", lwd=2, main="Fossil genera, CL, per Locality" )
# --> appendix!


veganGR <- tidyCL %>%
  dplyr::select(Reference, Genus) %>%
  group_by(Reference, Genus) %>%
  summarise(n=n()) %>%
  tidyr::spread(Genus, n, fill=0)

library(vegan)

veganGR=veganGR[,-1]
veganspGR=specaccum(veganGR,method="rarefaction", permutations=1000)
plot(veganspGR,xlab="References",ylab="Richness", xvar="individuals", ci.type="line", ci.lty=2, ci.col="grey", col="deepskyblue4", lwd=2)


```


```{r "SACGEurasia", echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Sampling Accumulation Curve of fossil genera per reference, Eurasia"}

#Species Accumulation Curve with Genera, Eurasia

overviewVegan <- PleiPlioCL %>%
  merge(Continents) %>%
  filter(EpochBins != "Modern") %>%
  group_by( Con) %>%  #Continent,
 # filter(Con=="Europe" | Con=="Asia" )%>%
  filter(!is.na(CL)) %>%
  summarise(meanCL=mean(CL), sdCL= sd(CL), n=n(), meanAge=mean(Age))


veganEA <- tidyCL %>%
  merge(Continents) %>%
  filter(Con=="Europe" | Con=="Asia") %>%
  dplyr::select(Reference, Genus) %>%
  group_by(Reference, Genus) %>%
  summarise(n=n()) %>%
  tidyr::spread(Genus, n, fill=0)

#library(vegan)

veganEA=veganEA[,-1]
veganspEA=specaccum(veganEA,method="rarefaction", permutations=1000)
plot(veganspEA,xlab="References",ylab="Richness", xvar="individuals", ci.type="line", ci.lty=2, ci.col="grey", col="deepskyblue4", lwd=2)


```



```{r "SACGEurope", echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Sampling Accumulation Curve of fossil genera per reference, Europe"}

#Species Accumulation Curve with Genera, Europe

veganEu <- tidyCL %>%
  merge(Continents) %>%
  filter(Con=="Europe") %>%
  dplyr::select(Reference, Genus) %>%
  group_by(Reference, Genus) %>%
  summarise(n=n()) %>%
  tidyr::spread(Genus, n, fill=0)

#library(vegan)

veganEu=veganEu[,-1]
veganspEu=specaccum(veganEu,method="rarefaction", permutations=1000)
plot(veganspEu,xlab="References",ylab="Richness", xvar="individuals", ci.type="line", ci.lty=2, ci.col="grey", col="deepskyblue4", lwd=2)


```



```{r "SACGAfrica", echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Sampling Accumulation Curve of fossil genera per reference, Africa"}


#Species Accumulation Curve with Genera, Africa

veganAf <- tidyCL %>%
  merge(Continents) %>%
  filter(Con=="Africa") %>%
  dplyr::select(Reference, Genus) %>%
  group_by(Reference, Genus) %>%
  summarise(n=n()) %>%
  tidyr::spread(Genus, n, fill=0)

#library(vegan)

veganAf=veganAf[,-1]
veganspAf=specaccum(veganAf,method="rarefaction", permutations=1000)
plot(veganspAf,xlab="References",ylab="Richness", xvar="individuals", ci.type="line", ci.lty=2, ci.col="grey", col="deepskyblue4", lwd=2)


```


```{r "SACGAmerica", echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Sampling Accumulation Curve of fossil genera per reference, America"}

#Species Accumulation Curve with Genera, America

veganAm <- tidyCL %>%
  merge(Continents) %>%
  filter(Con=="America") %>%
  dplyr::select(Reference, Genus) %>%
  group_by(Reference, Genus) %>%
  summarise(n=n()) %>%
  tidyr::spread(Genus, n, fill=0)

#library(vegan)

veganAm=veganAm[,-1]
veganspAm=specaccum(veganAm,method="rarefaction", permutations=1000)
plot(veganspAm,xlab="References",ylab="Richness", xvar="individuals", ci.type="line", ci.lty=2, ci.col="grey", col="deepskyblue4", lwd=2)


```



```{r "SACGNAmerica", echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Sampling Accumulation Curve of fossil genera per reference, N-America"}

#Species Accumulation Curve with Genera, N-America


veganNA <- tidyCL %>%
  merge(Continents) %>%
  filter(Continent=="N-America") %>%
  dplyr::select(Reference, Genus) %>%
  group_by(Reference, Genus) %>%
  summarise(n=n()) %>%
  tidyr::spread(Genus, n, fill=0)

#library(vegan)

veganNA=veganNA[,-1]
veganspNA=specaccum(veganNA,method="rarefaction", permutations=1000)
plot(veganspNA,xlab="References",ylab="Richness", xvar="individuals", ci.type="line", ci.lty=2, ci.col="grey", col="deepskyblue4", lwd=2)


```


```{r "SACGSAmerica", echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Sampling Accumulation Curve of fossil genera per reference, S-America"}

#Species Accumulation Curve with Genera, S-America

veganSA <- tidyCL %>%
  merge(Continents) %>%
  filter(Continent=="S-America") %>%
  dplyr::select(Reference, Genus) %>%
  group_by(Reference, Genus) %>%
  summarise(n=n()) %>%
  tidyr::spread(Genus, n, fill=0)

#library(vegan)

veganSA=veganSA[,-1]
veganspSA=specaccum(veganSA,method="rarefaction", permutations=1000)
plot(veganspSA,xlab="References",ylab="Richness", xvar="individuals", ci.type="line", ci.lty=2, ci.col="grey", col="deepskyblue4", lwd=2)


```


```{r "SACGAsia", echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Sampling Accumulation Curve of fossil genera per reference, Asia"}

#Species Accumulation Curve with Genera, Asia

veganAs <- tidyCL %>%
  merge(Continents) %>%
  filter(Con=="Asia") %>%
  dplyr::select(Reference, Genus) %>%
  group_by(Reference, Genus) %>%
  summarise(n=n()) %>%
  tidyr::spread(Genus, n, fill=0)

#library(vegan)

veganAs=veganAs[,-1]
veganspAs=specaccum(veganAs,method="rarefaction", permutations=1000)
plot(veganspAs,xlab="References",ylab="Richness", xvar="individuals", ci.type="line", ci.lty=2, ci.col="grey", col="deepskyblue4", lwd=2)


```






\newpage

# Histograms
## all

```{r "HistAll", echo=FALSE, fig.cap="Distribution of body size data, logtransformed, all data."}


#Histograms of body size data, all

HistCL <- PleiPlioCL %>%
  filter( !is.na(CL)) %>%
  mutate(CL=log(CL)) %>%
#  filter(EpochBins != "Modern") %>%
  ggplot(aes(CL)) + 
  #geom_histogram( col="black", fill="gray") + 
  geom_histogram( aes(y=..density..),col="black", fill="gray")+
  #geom_density() +
  geom_density(alpha=.2, fill="darkslategray1") +
  #facet_wrap(~EpochBins, scales="free_x")+   #binwidth=10,
  theme_classic()+ 
  #theme_gray() +
  theme(panel.border = element_rect(colour = "black", fill=NA))

#HistCLModern
HistCL  






StatsAll <- PleiPlioCL %>%
  filter(!is.na(CL)) %>%
#  group_by(Island) %>%
  summarise(nCL=length(CL), #range=range(CL),
            min=min(CL), max=max(CL), 
            var=var(CL), mean=round(mean(CL),1), logm=round(mean(log10(CL)),1),
            med=round(median(CL),1), logmed=round(median(log10(CL)),1), #CLmode=mode(CL), CLlogmode=mode(log10(CL)),
            skew=round(skewness(CL),2), logsk=round(skewness(log10(CL)),2),
            kurt=round(kurtosis(CL),2), logku=round(kurtosis(log10(CL)),2) ) %>%
  unique()





```
```{r "normalDistribution", echo=FALSE}

qqnorm(PleiPlioCL$CL); qqline(PleiPlioCL$CL, col=2)
qqnorm(log10(PleiPlioCL$CL)); qqline(log10(PleiPlioCL$CL), col=2)


```



\newpage

## per time bin

```{r "HistBins", echo=FALSE, fig.cap="Distribution of body size data per time bin, logtransformed."}

#Histograms of body size data, per time bin


HistCLBins <- PleiPlioCL %>%
 # merge(BINS) %>%
  filter( !is.na(CL)) %>%
  mutate(CL=log(CL)) %>%
  arrange(MeanBins) %>%
#  filter(EpochBins != "Modern") %>%
  ggplot(aes(CL)) + 
  geom_histogram( aes(y=..density..),col="black", fill="gray")+
  #geom_density() +
  geom_density(alpha=.2, fill="darkslategray1") +
  facet_wrap(~EpochBins, scales="free_x")+   #binwidth=10,
  theme_classic()+ 
  #theme_gray() +
  theme(panel.border = element_rect(colour = "black", fill=NA))


HistCLBins


StatsBins <- PleiPlioCL %>%
  filter(!is.na(CL)) %>%
  group_by(EpochBins) %>%
  summarise(nCL=length(CL), min=min(CL), max=max(CL), var=var(CL), mean=round(mean(CL),1), logm=round(mean(log10(CL)),1),
            med=round(median(CL),1), logmed=round(median(log10(CL)),1), #CLmode=mode(CL), CLlogmode=mode(log10(CL)),
            skew=round(skewness(CL),2), logsk=round(skewness(log10(CL)),2),
            kurt=round(kurtosis(CL),2), logku=round(kurtosis(log10(CL)),2) ) %>%
  unique()

#kable(StatsBins)


```





\newpage

## modern vs. fossil

```{r "HistFosMo", echo=FALSE, fig.cap="Distribution of body size data modern vs. fossil, logtransformed."}

#Histograms of body size data, modern vs. fossil


Epoch <- as.vector(c("Modern", "Pleistocene", "Pleistocene", "Pleistocene", "Pleistocene", 
                      "Pliocene", "Pliocene",
                     "Miocene", "Miocene", "Miocene",  "Miocene", "Miocene"))
EPOCH <- as.vector(c("Modern", "Fossil", "Fossil", "Fossil"
                     , "Fossil", "Fossil", "Fossil", "Fossil", "Fossil", "Fossil"
                     , "Fossil", "Fossil"))
EpochBins <- as.vector(unique(PleiPlioCL$EpochBins))
Epochs <- data.frame(Epoch,EpochBins, EPOCH)


Epochs$EPOCH = factor(Epochs$EPOCH,levels=c("Modern", "Fossil"))

HistCLFossil <- PleiPlioCL %>%
  merge(Epochs) %>%
  filter( !is.na(CL)) %>%
  mutate(CL=log(CL)) %>%
#  filter(EpochBins != "Modern") %>%
  ggplot(aes(CL)) + 
  geom_histogram( aes(y=..density..),col="black", fill="gray")+
  #geom_density() +
  geom_density(alpha=.2, fill="darkslategray1") +
  facet_wrap(~EPOCH, scales="free_x")+   #binwidth=10,
  theme_classic()+ 
  #theme_gray() +
  theme(panel.border = element_rect(colour = "black", fill=NA))


HistCLFossil


StatsFossil <- PleiPlioCL %>%
  merge(Epochs) %>%
  filter(!is.na(CL)) %>%
  group_by(EPOCH) %>%
  summarise(nCL=length(CL), min=min(CL), max=max(CL), var=var(CL), mean=round(mean(CL),1), logm=round(mean(log10(CL)),1),
            med=round(median(CL),1), logmed=round(median(log10(CL)),1), #CLmode=mode(CL), CLlogmode=mode(log10(CL)),
            skew=round(skewness(CL),2), logsk=round(skewness(log10(CL)),2),
            kurt=round(kurtosis(CL),2), logku=round(kurtosis(log10(CL)),2) ) %>%
  unique()

#kable(StatsFossil)


```


\newpage

## modern vs. fossil, continental vs. insular


```{r "HistFMCI", echo=FALSE, fig.cap="Distribution of body size data modern vs. fossil, continental vs. insular logtransformed."}

#Histograms of body size data, modern vs. fossil, continental vs. insular

HistCLFossilIsland <- PleiPlioCL %>%
  merge(Epochs) %>%
  filter( !is.na(CL)) %>%
  mutate(CL=log(CL)) %>%
#  filter(EpochBins != "Modern") %>%
  ggplot(aes(CL)) + 
  geom_histogram( aes(y=..density..),col="black", fill="gray")+
  #geom_density() +
  geom_density(alpha=.2, fill="darkslategray1") + 
  facet_wrap(EPOCH~Island, scales="free_x")+   #binwidth=10,
  theme_classic()+ 
  #theme_gray() +
  theme(panel.border = element_rect(colour = "black", fill=NA))


HistCLFossilIsland


StatsFossilIsland <- PleiPlioCL %>%
  merge(Epochs) %>%
  filter(!is.na(CL)) %>%
  group_by(EPOCH, Island) %>%
  summarise(nCL=length(CL), min=min(CL), max=max(CL), var=var(CL), mean=round(mean(CL),1), logm=round(mean(log10(CL)),1),
            med=round(median(CL),1), logmed=round(median(log10(CL)),1), #CLmode=mode(CL), CLlogmode=mode(log10(CL)),
            skew=round(skewness(CL),2), logsk=round(skewness(log10(CL)),2),
            kurt=round(kurtosis(CL),2), logku=round(kurtosis(log10(CL)),2) ) %>%
  unique()

#kable(StatsFossilIsland)


```

\newpage
## continental vs. insular

```{r "HistCI", echo=FALSE, fig.cap="Distribution of body site data of continental (n) and insular(y) species, logtransformed."}

#Histograms of body size data, continental vs. insular

HistCLIsland <- PleiPlioCL %>%
  filter( !is.na(CL)) %>%
  mutate(CL=log(CL)) %>%
#  filter(EpochBins != "Modern") %>%
  ggplot(aes(CL)) + 
  geom_histogram( aes(y=..density..),col="black", fill="gray")+
  #geom_density() +
  geom_density(alpha=.2, fill="darkslategray1") + 
  facet_wrap(~Island, scales="free_x")+   #binwidth=10,
  theme_classic()+ 
  #theme_gray() +
  theme(panel.border = element_rect(colour = "black", fill=NA))

#HistCLModern
HistCLIsland


StatsIsland <- PleiPlioCL %>%
  filter(!is.na(CL)) %>%
  group_by(Island) %>%
  summarise(nCL=length(CL), min=min(CL), max=max(CL), var=var(CL), mean=round(mean(CL),1), logm=round(mean(log10(CL)),1),
            med=round(median(CL),1), logmed=round(median(log10(CL)),1), #CLmode=mode(CL), CLlogmode=mode(log10(CL)),
            skew=round(skewness(CL),2), logsk=round(skewness(log10(CL)),2),
            kurt=round(kurtosis(CL),2), logku=round(kurtosis(log10(CL)),2) ) %>%
  unique()

#kable(StatsIsland)
```

\newpage
## continents

```{r "HistCon", echo=FALSE, fig.cap="Distribution of body site data per continent, logtransformed."}

#Histograms of body size data, split by continents

Continent <- as.vector(unique(PleiPlioCL$Continent))
Con <- as.vector(c("Asia", "Africa", "Europe", "America", "America", "America", "Europe"))#
Continents <- data.frame(Continent, Con)

HistCLContinents <- PleiPlioCL %>%
  filter( !is.na(CL)) %>%
  mutate(CL=log(CL)) %>%
  merge(Continents) %>%
#  filter(EpochBins != "Modern") %>%
  ggplot(aes(CL)) + 
  geom_histogram( aes(y=..density..),col="black", fill="gray")+
  #geom_density() +
  geom_density(alpha=.2, fill="darkslategray1") +
  facet_wrap(~Con, scales="free_x")+   #binwidth=10,
  theme_classic()+ 
  #theme_gray() +
  theme(panel.border = element_rect(colour = "black", fill=NA))


HistCLContinents


StatsContinents <- PleiPlioCL %>%
  merge(Continents) %>%
  filter(!is.na(CL)) %>%
  group_by(Con) %>%
  summarise(nCL=length(CL), min=min(CL), max=max(CL), var=var(CL), mean=round(mean(CL),1), logm=round(mean(log10(CL)),1),
            med=round(median(CL),1), logmed=round(median(log10(CL)),1), #CLmode=mode(CL), CLlogmode=mode(log10(CL)),
            skew=round(skewness(CL),2), logsk=round(skewness(log10(CL)),2),
            kurt=round(kurtosis(CL),2), logku=round(kurtosis(log10(CL)),2) ) %>%
  unique()

#kable(StatsContinents)
```


```{r "HistGen", echo=FALSE, fig.cap="Distribution of body size, genera, logtransformed.", include=FALSE}

#Histograms of body size data, genera

Continent <- as.vector(unique(PleiPlioCL$Continent))
Con <- as.vector(c("Asia", "Africa", "Europe", "America", "America", "America", "Europe"))#
Continents <- data.frame(Continent, Con)

HistCLGenera <- PleiPlioCL %>%
  filter( !is.na(CL)) %>%
  mutate(CL=log(CL)) %>%
  merge(Continents) %>%
#  filter(EpochBins != "Modern") %>%
  ggplot(aes(CL)) + 
  geom_histogram( aes(y=..density..),col="black", fill="gray")+
  #geom_density() +
  geom_density(alpha=.2, fill="darkslategray1") + 
  facet_wrap(~Genus, scales="free_x")+   #binwidth=10,
  theme_classic()+ 
  #theme_gray() +
  theme(panel.border = element_rect(colour = "black", fill=NA))


HistCLGenera


StatsGenera <- PleiPlioCL %>%
  merge(Continents) %>%
  filter(!is.na(CL)) %>%
  group_by(Genus) %>%
  summarise(nCL=length(CL), min=min(CL), max=max(CL), var=var(CL), mean=round(mean(CL),1), logm=round(mean(log10(CL)),1),
            med=round(median(CL),1), logmed=round(median(log10(CL)),1), #CLmode=mode(CL), CLlogmode=mode(log10(CL)),
            skew=round(skewness(CL),2), logsk=round(skewness(log10(CL)),2),
            kurt=round(kurtosis(CL),2), logku=round(kurtosis(log10(CL)),2) ) %>%
  unique()

kable(StatsGenera)
```


\newpage
## General statistics

```{r "Tabel Stats Distribution CL", echo=FALSE}
Stats <- bind_rows(StatsAll, StatsBins, StatsFossil, StatsIsland, 
                   StatsFossilIsland, StatsContinents) %>%
  select(-EpochBins, -Island, -Con, -EPOCH)



Stats$Variable <- c("all", "Modern", "Upper Pleistocene", "Middle Pleistocene", "Lower Pleistocene", "Gelasian", "Piacencian", "Zanclean", "Messinian","Tortonian", "Serravallian","Langhian",
                         "Burdigalian/Aquitanian", "Modern","Fossil", "continental",
                    "insular","modern-con", "modern-ins", "fossil-con", "fossil-ins",
                    "Africa", "America", "Asia", "Europe")


kable(Stats, caption="General statistics of body size data: all, per time bin, insular and continental, per continent (all referring to CL: min, max, variance, mean, logmean, median, logmedian, skewness, logskewness, kurosis, logkurtosis")

```

\newpage
# Boxplots
## genera per time bins

```{r "BPGBins", echo=FALSE, warning=FALSE, fig.cap="Boxplots of mean CL per time bin, including mean and sd CL for each genus (as pointrange)."}

#Boxplots of each genus per time bin

IndGenera <- PleiPlioCL %>%
  group_by(EpochBins, Genus) %>%
  filter(!is.na(CL)) %>%
  summarise(GenusMean=mean(CL), GenusSD=sd(CL), n=n()) 

IndGenera[is.na(IndGenera)] <-0


give.n <- function(x){
  return(c(y = 0, label = length(x)))
}



BinGenera <- PleiPlioCL %>%
  group_by(EpochBins, Genus) %>%
  filter(!is.na(CL)) %>%
  summarise(GenusMean=mean(CL), GenusSD=sd(CL), n=n()) %>%
#  summarise(TimeBinMean=mean(GenusMean), TimeBinSD=sd(GenusMean), n=n()) %>%
  ungroup() %>%#, CL=CL
  ggplot(aes(EpochBins, GenusMean)) + #, colour=Genus
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  stat_boxplot(geom ='errorbar', width = 0.2) +
  geom_boxplot() +
  geom_pointrange(data=IndGenera, position="jitter", aes(x=EpochBins, y=GenusMean, colour=EpochBins, ymin = GenusMean-GenusSD, ymax = GenusMean+GenusSD)) +
  stat_summary(fun.data = give.n, geom = "text") +
  theme(legend.background = element_rect(colour = 'black'),
        panel.border = element_rect(colour = "black", fill=NA)) +
  scale_colour_manual(values=c("#808080", "#848484", "#878787", "#8B8B8B", "#8F8F8F", "#929292",
                               "#969696", "#999999", "#969696", "#999999",
                               "#969696", "#999999", "#969696", "#999999", "#999999")) +
  theme(legend.position="none")

BinGenera

```

\newpage
## continental vs. insular per time bin

```{r "BPGBinsCI", echo=FALSE, warning=FALSE, fig.cap="Boxplots of each genus per time bin, continental vs. insular species."}

#Boxplots of each genus per time bin, continental vs. insular

IndGenera <- PleiPlioCL %>%
  group_by(EpochBins, Genus, Island) %>%
  filter(!is.na(CL)) %>%
  summarise(GenusMean=mean(CL), GenusSD=sd(CL), n=n()) 

IndGenera[is.na(IndGenera)] <- 0


give.n <- function(x){
  return(c(y = 0, label = length(x)))
}



BinGenera <- PleiPlioCL %>%
  group_by(EpochBins, Genus, Island) %>%
  filter(!is.na(CL)) %>%
  summarise(GenusMean=mean(CL), GenusSD=sd(CL), n=n()) %>%
#  summarise(TimeBinMean=mean(GenusMean), TimeBinSD=sd(GenusMean), n=n()) %>%
  ungroup() %>%#, CL=CL
  ggplot(aes(EpochBins, GenusMean)) + #, colour=Genus
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  stat_boxplot(geom ='errorbar', width = 0.2) +
  geom_boxplot() +
  geom_pointrange(data=IndGenera, position="jitter", aes(x=EpochBins, y=GenusMean, colour=EpochBins, ymin = GenusMean-GenusSD, ymax = GenusMean+GenusSD)) +
  facet_wrap(~Island)+
  stat_summary(fun.data = give.n, geom = "text") +
  theme(legend.background = element_rect(colour = 'black'),
        panel.border = element_rect(colour = "black", fill=NA)) +
  scale_colour_manual(values=c("#808080", "#848484", "#878787", "#8B8B8B", "#8F8F8F", "#929292",
                               "#969696", "#999999", "#969696", "#999999",
                               "#969696", "#999999", "#969696", "#999999", "#999999")) +
  theme(legend.position="none")

BinGenera

```

\newpage
## fossil vs. modern

```{r "BPMF", echo=FALSE, warning=FALSE, fig.cap="Boxplots fossil vs. modern."}

#Boxplots modern vs. fossil

IndGenera <- PleiPlioCL %>%
  merge(Epochs) %>%
  group_by(EPOCH, Genus, Island) %>%
  filter(!is.na(CL)) %>%
  summarise(GenusMean=mean(CL), GenusSD=sd(CL), n=n()) 

IndGenera[is.na(IndGenera)] <- 0


give.n <- function(x){
  return(c(y = 0, label = length(x)))
}



BinGenera <- PleiPlioCL %>%
  merge(Epochs) %>%
  group_by(EPOCH, Genus, Island) %>%
  filter(!is.na(CL)) %>%
  summarise(GenusMean=mean(CL), GenusSD=sd(CL), n=n()) %>%
#  summarise(TimeBinMean=mean(GenusMean), TimeBinSD=sd(GenusMean), n=n()) %>%
  ungroup() %>%#, CL=CL
  ggplot(aes(EPOCH, GenusMean)) + #, colour=Genus
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  stat_boxplot(geom ='errorbar', width = 0.2) +
  geom_boxplot() +
  geom_pointrange(data=IndGenera, position="jitter", aes(x=EPOCH, y=GenusMean, colour=EPOCH, ymin = GenusMean-GenusSD, ymax = GenusMean+GenusSD)) +
#  facet_wrap(~Island)+
  stat_summary(fun.data = give.n, geom = "text") +
  theme(legend.background = element_rect(colour = 'black'),
        panel.border = element_rect(colour = "black", fill=NA)) +
  scale_colour_manual(values=c("#808080", "#848484", "#878787", "#8B8B8B", "#8F8F8F", "#929292",
                               "#969696", "#999999", "#969696", "#999999",
                               "#969696", "#999999", "#969696", "#999999", "#999999")) +
  theme(legend.position="none")

BinGenera

# library(plotly)
# ggplotly(BinGenera)

```


```{r "RSFM", echo=FALSE}

# randon sampling modern fossil

TimeCL <- PleiPlioCL %>%
  merge(Epochs) %>%
  group_by(EPOCH) %>%
  filter(!is.na(CL)) %>%
  summarise(meanCL=mean(CL), sdCL = sd(CL), varCL=var(CL), n=n())

ModernR <- PleiPlioCL %>%
  merge(Epochs) %>%
  group_by(EPOCH) %>%
  filter(!is.na(CL)) %>%
  filter(EPOCH=="Modern")

FossilR <- PleiPlioCL %>%
  merge(Epochs) %>%
  filter(!is.na(CL)) %>%
  filter(EPOCH=="Fossil")


Modern <- as.vector(ModernR$CL[which(ModernR$EPOCH=="Modern")])
FossilRandom <- sample(FossilR$CL, length(Modern), replace=FALSE)


# median(sample(FossilR$CL, length(Modern), replace=FALSE))

FossilRan <- (replicate(1000, {
 sample(FossilR$CL, length(Modern), replace=FALSE)
  }))

hist(FossilRan, main="Fossil, random sampling")
abline(v=median(FossilR$CL))#locates actual statistics with all data

#hist(sample(FossilR$CL, 251, replace=FALSE))


Modern <- PleiPlioCL$CL[which(PleiPlioCL$EpochBins=="Modern")]
Fossil <- sample(PleiPlioCL$CL[which(PleiPlioCL$EpochBins!="Modern")], 251, replace=FALSE)

mean(Modern)
mean(Fossil)


ModernFossil<- wilcox.test(Modern,Fossil, alternative = "l",paired=FALSE)  

ModernFossil

#ModernFossil$p.value

#ModernFossil$p.value < 0.05



```
Wilcoxon Rank Sum Test (unpaired data): 

modern < fossil (P = $`r ModernFossil$p.value`$)

\newpage
## fossil vs. modern, continental vs. insular


```{r "BPFMCI", echo=FALSE, warning=FALSE, fig.cap="Boxplots fossil vs. modern, continental vs. insular species."}

#Boxplots fossil vs. modern, continental vs. insular

IndGenera <- PleiPlioCL %>%
  merge(Epochs) %>%
  group_by(EPOCH, Genus, Island) %>%
  filter(!is.na(CL)) %>%
  summarise(GenusMean=mean(CL), GenusSD=sd(CL), n=n()) 

IndGenera[is.na(IndGenera)] <- 0


give.n <- function(x){
  return(c(y = 0, label = length(x)))
}



BinGenera <- PleiPlioCL %>%
  merge(Epochs) %>%
  group_by(EPOCH, Genus, Island) %>%
  filter(!is.na(CL)) %>%
  summarise(GenusMean=mean(CL), GenusSD=sd(CL), n=n()) %>%
#  summarise(TimeBinMean=mean(GenusMean), TimeBinSD=sd(GenusMean), n=n()) %>%
  ungroup() %>%#, CL=CL
  ggplot(aes(EPOCH, GenusMean)) + #, colour=Genus
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  stat_boxplot(geom ='errorbar', width = 0.2) +
  geom_boxplot() +
  geom_pointrange(data=IndGenera, position="jitter", aes(x=EPOCH, y=GenusMean, colour=EPOCH, ymin = GenusMean-GenusSD, ymax = GenusMean+GenusSD)) +
  facet_wrap(~Island)+
  stat_summary(fun.data = give.n, geom = "text") +
  theme(legend.background = element_rect(colour = 'black'),
        panel.border = element_rect(colour = "black", fill=NA)) +
  scale_colour_manual(values=c("#808080", "#848484", "#878787", "#8B8B8B", "#8F8F8F", "#929292",
                               "#969696", "#999999", "#969696", "#999999",
                               "#969696", "#999999", "#969696", "#999999", "#999999")) +
  theme(legend.position="none")

BinGenera




```


```{r "RSMFCI", echo=FALSE}

#randon sampling modern fossil, island continental

FossilIsland <- PleiPlioCL$CL[which(PleiPlioCL$EpochBins!="Modern" & PleiPlioCL$Island=="y")]
length(FossilIsland)

ModernIsland <- sample(PleiPlioCL$CL[which(PleiPlioCL$EpochBins=="Modern" & PleiPlioCL$Island=="y")], length(FossilIsland), replace=FALSE)
length(ModernIsland)


ModernIslandRan <- (replicate(1000, {
 sample(PleiPlioCL$CL[which(PleiPlioCL$EpochBins=="Modern" & PleiPlioCL$Island=="y")], length(FossilIsland), replace=FALSE)
  }))

hist(ModernIslandRan, main="Modern, insular, random sampling")
abline(v=median(PleiPlioCL$CL[which(PleiPlioCL$EpochBins=="Modern" & PleiPlioCL$Island=="y")]))#locates actual statistics with all data



# mean(FossilIsland)
# mean(ModernIsland)


ModernFossilIsland<- wilcox.test(ModernIsland,FossilIsland, alternative = "l",paired=FALSE)  

 ModernFossilIsland
# 
# ModernFossilIsland$p.value
# 
# ModernFossilIsland$p.value < 0.05



ModernCon <- PleiPlioCL$CL[which(PleiPlioCL$EpochBins=="Modern" & PleiPlioCL$Island=="n")]
length(ModernCon)
FossilCon <- sample(PleiPlioCL$CL[which(PleiPlioCL$EpochBins!="Modern" & PleiPlioCL$Island=="n")],
                    length(ModernCon), replace=FALSE)

length(FossilCon)


FossilConRan <- (replicate(1000, {
 sample(PleiPlioCL$CL[which(PleiPlioCL$EpochBins!="Modern" & PleiPlioCL$Island=="n")],
        length(ModernCon), replace=FALSE)
  }))

hist(FossilConRan, main="Fossil, continental, random sampling")
abline(v=median(PleiPlioCL$CL[which(PleiPlioCL$EpochBins!="Modern" & PleiPlioCL$Island=="n")]))#locates actual statistics with all data


# mean(ModernCon)
# mean(FossilCon)

ModernFossilCon<- wilcox.test(ModernCon,FossilCon, alternative = "l",paired=FALSE)  

 ModernFossilCon
# 
# ModernFossilCon$p.value
# 
# ModernFossilCon$p.value < 0.05


```
Wilcoxon Rank Sum Test (unpaired data): 

modern continental < fossil continental (P = $`r ModernFossilCon$p.value`$)

modern insular < fossil insular (P = $`r ModernFossilIsland$p.value`$)


\newpage
## continental vs. insular

```{r "BPCI", echo=FALSE, fig.cap="Boxplot continental vs. insular, genera summarised"}

#Boxplot continental vs. insular

give.n <- function(x){
  return(c(y = 0, label = length(x)))
}


IslandGenus <- testRatio %>%
  filter(!is.na(CL)) %>%
  select(CL, Island, Genus) %>%
  filter(!is.na(CL)) %>%
  group_by(Genus, Island) %>%
  summarise(meanCL=mean(CL), sdCL=sd(CL))

IslandGenus[is.na(IslandGenus)] <- 0


IslandAll <- testRatio %>%
  select(CL, Island, Genus) %>%
  filter(!is.na(CL)) %>%
  ggplot(aes(Island, CL)) + geom_boxplot() + 
  geom_pointrange(data=IslandGenus, position="jitter", aes(x=Island, y=meanCL,  colour= Island , ymin = meanCL-sdCL, ymax = meanCL+sdCL)) +   #colour=Genus,
  theme_classic() + # for white background 
  stat_summary(fun.data = give.n, geom = "text") +
  theme(legend.background = element_rect(colour = 'black'),
        panel.border = element_rect(colour = "black", fill=NA)) +
  scale_colour_manual(values=c("#808080", "#848484", "#878787", "#8B8B8B", "#8F8F8F", "#929292",
                               "#969696", "#999999")) +
  theme(legend.position="none")

IslandAll





```


```{r "RSCI", echo=FALSE}

#randon sampling island continental


Insular <- PleiPlioCL$CL[which(PleiPlioCL$Island=="y")]
length(Insular)
Continental <- sample(PleiPlioCL$CL[which(PleiPlioCL$Island=="n")], length(Insular), replace=FALSE)
length(Continental)


ContinentalRan <- (replicate(1000, {
 sample(PleiPlioCL$CL[which(PleiPlioCL$Island=="n")], length(Insular), replace=FALSE)
  }))

hist(ContinentalRan, main="Continental, random sampling")
abline(v=median(PleiPlioCL$CL[which(PleiPlioCL$Island=="n")]))#locates actual statistics (skewness) with all data


# mean(Insular)
# mean(Continental)

InsularContinental<- wilcox.test(Insular,Continental, alternative = "g",paired=FALSE)  

 InsularContinental
# 
# InsularContinental$p.value
# 
# InsularContinental$p.value < 0.05



```

Wilcoxon Rank Sum Test (unpaired data): 

continental < insular (P = $`r InsularContinental$p.value`$)

\newpage
## continental vs. insular per time bin

```{r "BPCIBins", echo=FALSE, fig.cap="Boxplot continental vs. insular, genera summarised"}

#Boxplot continental vs. insular, split into time bins

give.n <- function(x){
  return(c(y = 0, label = length(x)))
}


IslandGenus <- PleiPlioCL %>%
  select(CL, Island, Genus, EpochBins) %>%
  filter(!is.na(CL)) %>%
  group_by(Genus, Island, EpochBins) %>%
  summarise(meanCL=mean(CL), sdCL=sd(CL))

IslandGenus[is.na(IslandGenus)] <- 0


IslandAll <- PleiPlioCL %>%
  select(CL, Island, Genus, EpochBins) %>%
  filter(!is.na(CL)) %>%
  ggplot(aes(Island, CL)) + geom_boxplot() + 
  geom_pointrange(data=IslandGenus, position="jitter", aes(x=Island, y=meanCL,  colour= Island , ymin = meanCL-sdCL, ymax = meanCL+sdCL)) +   #colour=Genus,
  theme_classic() + # for white background 
  stat_summary(fun.data = give.n, geom = "text") +
  theme(legend.background = element_rect(colour = 'black'),
        panel.border = element_rect(colour = "black", fill=NA)) +
  facet_wrap(~EpochBins) +
  scale_colour_manual(values=c("#808080", "#848484", "#878787", "#8B8B8B", "#8F8F8F", "#929292",
                               "#969696", "#999999")) +
  theme(legend.position="none")

IslandAll

```

\newpage
## continents

```{r "BPCon", echo=FALSE, fig.cap="Boxplot: body size on different continents, genera summarised"}

#Boxplot body size split into continents

give.n <- function(x){
  return(c(y = 0, label = length(x)))
}


ContinentGenus <- testRatio %>%
  merge(Continents) %>%
  select(CL, Con, Genus) %>%
  filter(!is.na(CL)) %>%
  group_by(Genus, Con) %>%
  summarise(meanCL=mean(CL), sdCL=sd(CL))


ContinentGenus[is.na(ContinentGenus)] <- 0


ContinentAll <- PleiPlioCL %>%
  merge(Continents) %>%
  select(CL, Con, Genus) %>%
  filter(!is.na(CL)) %>%
  ggplot(aes(Con, CL)) + geom_boxplot() + 
  geom_pointrange(data=ContinentGenus, position="jitter", aes(x=Con, y=meanCL,  colour= Con , ymin = meanCL-sdCL, ymax = meanCL+sdCL)) +   #colour=Genus,
  theme_classic() + # for white background 
  stat_summary(fun.data = give.n, geom = "text") +
  theme(legend.background = element_rect(colour = 'black'),
        panel.border = element_rect(colour = "black", fill=NA)) +
  scale_colour_manual(values=c("#808080", "#848484", "#878787", "#8B8B8B", "#8F8F8F", "#929292",
                               "#969696", "#999999")) +
  theme(legend.position="none")

ContinentAll




```


```{r "RSCon", echo=FALSE}

#randon sampling continents


continent <- PleiPlioCL %>%
  merge(Continents) %>%
  filter(!is.na(CL))

Africa <- continent$CL[which(continent$Con=="Africa")]
length(Africa)
mean(Africa)
America <- sample(continent$CL[which(continent$Con=="America")], length(Africa), replace=FALSE)
length(America)
mean(America)
Asia <- continent$CL[which(continent$Con=="Asia")]
length(Asia)
# mean(Asia)
Europe <- continent$CL[which(continent$Con=="Europe")]
length(Europe)
# mean(Europe)
Eurasia <- sample(continent$CL[which(continent$Con=="Europe" | continent$Con=="Asia")], length(Africa), replace=FALSE)
length(Eurasia)
mean(Eurasia)


AmericaRan <- (replicate(1000, {
 sample(continent$CL[which(continent$Con=="America")], length(Africa), replace=FALSE)
  }))

hist(AmericaRan, main="America, random sampling")
abline(v=median(continent$CL[which(continent$Con=="America")]))#locates actual statistics (skewness) with all data



EuropeRan <- (replicate(1000, {
 sample(continent$CL[which(continent$Con=="Europe")], length(Africa), replace=FALSE)
  }))

hist(EuropeRan, main="Europe, random sampling")
abline(v=median(continent$CL[which(continent$Con=="Europe")]))#locates actual statistics (skewness) with all data



EurasiaRan <- (replicate(1000, {
 sample(continent$CL[which(continent$Con=="Europe" | continent$Con=="Asia")], length(Africa), replace=FALSE)
  }))

hist(EurasiaRan, main="Eurasia, random sampling")
abline(v=median(continent$CL[which(continent$Con=="Europe" | continent$Con=="Asia")]))#locates actual statistics (skewness) with all data


ContinentsCompared <- kruskal.test(list(Africa, America, Eurasia, Europe))  #Asia, Europe

 ContinentsCompared
# 
# ContinentsCompared$p.value
# 
# ContinentsCompared$p.value < 0.05


```


Kruskal-Wallis-Test: 

Continent means differ (P = $`r ContinentsCompared$p.value`$)
(still have to look into the details...)



\newpage
## continents, continental vs. insular

```{r "BPConCI", echo=FALSE, fig.cap="Boxplot: body size on different continents, genera summarised"}

#Boxplot body size split into continents, continental vs. insular

give.n <- function(x){
  return(c(y = 0, label = length(x)))
}


ContinentsGenus <- testRatio %>%
  merge(Continents) %>%
  select(CL, Con, Genus, Island) %>%
  filter(!is.na(CL)) %>%
  group_by(Genus, Con, Island) %>%
  summarise(meanCL=mean(CL), sdCL=sd(CL))


ContinentsGenus[is.na(ContinentsGenus)] <- 0


ContinentsAll <- testRatio %>%
  merge(Continents) %>%
  select(CL, Con, Genus, Island) %>%
  filter(!is.na(CL)) %>%
  ggplot(aes(Island, CL)) + geom_boxplot() + 
  geom_pointrange(data=ContinentsGenus, position="jitter", aes(x=Island, y=meanCL,  colour= Con , ymin = meanCL-sdCL, ymax = meanCL+sdCL)) +   #colour=Genus,
  theme_classic() + # for white background 
  facet_wrap(~Con) +
  stat_summary(fun.data = give.n, geom = "text") +
  theme(legend.background = element_rect(colour = 'black'),
        panel.border = element_rect(colour = "black", fill=NA)) +
  scale_colour_manual(values=c("#808080", "#848484", "#878787", "#8B8B8B", "#8F8F8F", "#929292",
                               "#969696", "#999999")) +
  theme(legend.position="none")

ContinentsAll

```


\newpage

# paleoTS analysis

## all (continental and insular)

### genera (all)

```{r "paleoTSAll", echo=FALSE, fig.cap="paleoTS plot with genus mean, all"}

#paleoTS plot with genus mean, including island species

GenusMean <- PleiPlioCL %>%
  filter(EpochBins != "Modern") %>%
  filter(!is.na(CL)) %>%
  group_by(EpochBins, Genus) %>%
  summarise(meanCL = mean(CL), n=n()) %>%
#  filter(EpochBins != "Aquitanian") %>%
#  ungroup() %>%
#  group_by(EpochBins) %>%
  summarise(mm = mean(meanCL), nn=n(), vv=var(meanCL)) %>%
  merge(BINSMio) %>%
  select(mm, nn, vv, tt=MeanBins)
  
#na <- PleiPlioCL[!complete.cases(PleiPlioCL),]

GenusMean[is.na(GenusMean)] <- 0


GenusModern <- PleiPlioCL %>%
  filter(EpochBins == "Modern") %>%
  filter(!is.na(CL)) %>%
  group_by(Genus) %>%
  summarise(meanCL=mean(CL), sdCL=sd(CL), n=n(), Age=mean(Age), EpochBins=unique(EpochBins), MeanBins=unique(MeanBins)) #%>%
#  summarise(mm=mean(meanCL), nn=n(), vv=var(meanCL), tt=mean(MeanBins))



sumTort <- read.csv("tortoises_summary.csv", sep=";", header=TRUE)
#colnames(sumTort)[1] <- "Taxon"
colnames(sumTort)[7] <- "meanCL"
colnames(sumTort)[8] <- "sdCL"
#sumTort$EpochBins <- "Modern"
#sumTort$MeanBins <- 0.0000005


sumTortoises <- sumTort %>%
  mutate(Genus= as.character(Genus)) %>%
  mutate(MeanBins=(Mamin+Mamax)/2) %>%
  select(Genus, MeanBins,  meanCL, sdCL, n) %>% #n,
  bind_rows(GenusModern)


SumTort <- sumTortoises %>%
  group_by(Genus) %>%
  mutate(tt=MeanBins, vv=sdCL^2, nn=n, mm=meanCL) %>%
  dplyr::select(mm, nn, vv, tt, Genus) %>%
  mutate(nx = nn*mm) %>%
  mutate(mmall=sum(nx)/sum(nn)) %>%
  mutate(SD=sqrt(nx), d=mm-mmall) %>%
  mutate(nsd=((nx^2+d^2)*nn)) %>%
  mutate(varall=sum(nsd)/sum(nn), n=sum(nn)) %>%
  dplyr::select(mm=mmall, vv=varall, nn=n, tt, Genus) %>%
  unique() %>%
  dplyr::select(CL=mm, n=nn, var=vv, tt, Genus)

#write.table(SumTort,file="SumTortModernGenus.txt", sep="\t", row.names = FALSE)

#kable(SumTort, caption="Overview over body size means per time bin on genus level.")

#boxplot(SumTort$CL, caption="Body size distribution in time bin 'modern'.")


modernMeanGenus <- SumTort %>%
  ungroup() %>%
  select(CL, n, tt) %>%
  filter( !is.na(CL)) %>%
  group_by(tt) %>%
  summarise(mm = mean(CL), vv=var(CL), nn=n())

#bis hier alle modernen taxa zusammengefasst (summarised and MFN_testudinidae)


GenusPaleo <- modernMeanGenus %>%
  bind_rows(GenusMean)%>%
  arrange(tt)


kable(GenusPaleo,caption="paleoTS object, all data")


paleoGen <-as.paleoTS(GenusPaleo$mm, GenusPaleo$vv, GenusPaleo$nn, GenusPaleo$tt, MM = NULL, genpars = NULL, label = "Testudinidae body size evolution mode, Holocene-Upper Miocene, genus mean CL", reset.time=TRUE)

plot(paleoGen)

```



```{r "Model-fitting, genera" , echo=FALSE, message=FALSE, include=FALSE}

PaleoGenFit <- (fit3models(paleoGen, silent=FALSE, method="AD", pool=FALSE))

#PaleoGenFit2 <- (fit4models(paleoGen, silent=FALSE, method="AD", pool=FALSE))
```



```{r "Model-fitting, genera, table", echo=FALSE}

kable(PaleoGenFit, caption="Model-fitting results for testudinidae, genera, all")

#kable(PaleoGenFit2, caption="Model-fitting results for testudinidae (4 models), genera, including island species")


```




\newpage

## continental (excluding insular species)

### genera (continental)

```{r "paleoTSC", echo=FALSE, message=FALSE, fig.cap="paleoTS plot with genus mean, continental"}

#paleoTS plot with genus mean, excluding island species


GenusMeanIs <- PleiPlioCL %>%
  filter(EpochBins != "Modern" & Island == "n") %>%
  filter(!is.na(CL)) %>%
  group_by(EpochBins, Genus) %>%
 # filter(EpochBins != "Aquitanian") %>%
  summarise(meanCL = mean(CL), n=n()) %>%
#  ungroup() %>%
#  group_by(EpochBins) %>%
  summarise(mm = mean(meanCL), nn=n(), vv=var(meanCL)) %>%
  merge(BINSMio) %>%
  select(mm, nn, vv, tt=MeanBins)
  
#na <- PleiPlioCL[!complete.cases(PleiPlioCL),]



GenusModernIs <- PleiPlioCL %>%
  filter(EpochBins == "Modern" & Island == "n") %>%
  filter(!is.na(CL)) %>%
  group_by(Genus) %>%
  summarise(meanCL=mean(CL), sdCL=sd(CL), n=n(), Age=mean(Age), EpochBins=unique(EpochBins), MeanBins=unique(MeanBins)) #%>%
#  summarise(mm=mean(meanCL), nn=n(), vv=var(meanCL), tt=mean(MeanBins))



sumTort <- read.csv("tortoises_summary.csv", sep=";", header=TRUE)
colnames(sumTort)[7] <- "meanCL"
colnames(sumTort)[8] <- "sdCL"


sumTortoises <- sumTort %>%
  dplyr::filter(Island == "n") %>%
  mutate(Genus= as.character(Genus)) %>%
  mutate(MeanBins=(Mamin+Mamax)/2) %>%
  select(Genus, MeanBins,  meanCL, sdCL, n) %>% #n,
  bind_rows(GenusModernIs)


SumTort <- sumTortoises %>%
  group_by(Genus) %>%
  mutate(tt=MeanBins, vv=sdCL^2, nn=n, mm=meanCL) %>%
  dplyr::select(mm, nn, vv, tt, Genus) %>%
  mutate(nx = nn*mm) %>%
  mutate(mmall=sum(nx)/sum(nn)) %>%
  mutate(SD=sqrt(nx), d=mm-mmall) %>%
  mutate(nsd=((nx^2+d^2)*nn)) %>%
  mutate(varall=sum(nsd)/sum(nn), n=sum(nn)) %>%
  dplyr::select(mm=mmall, vv=varall, nn=n, tt, Genus) %>%
  unique() %>%
  dplyr::select(CL=mm, n=nn, var=vv, tt, Genus)

#write.table(SumTort,file="SumTortModernGenus.txt", sep="\t", row.names = FALSE)

#kable(SumTort, caption="Overview over body size means per time bin on genus level, excluding island species.")

#boxplot(SumTort$CL, caption="Body size distribution in time bin 'modern'.")


modernMeanGenusIs <- SumTort %>%
  ungroup() %>%
  select(CL, n, tt) %>%
  filter( !is.na(CL)) %>%
  group_by(tt) %>%
  summarise(mm = mean(CL), vv=var(CL), nn=n())

#bis hier alle modernen taxa zusammengefasst (summarised and MFN_testudinidae)


GenusPaleoIs <- modernMeanGenusIs %>%
  bind_rows(GenusMeanIs)%>%
  arrange(tt)

GenusPaleoIs[is.na(GenusPaleoIs)] <- 0

kable(GenusPaleoIs, caption="paleoTS object, continental")


paleoGenIs <-as.paleoTS(GenusPaleoIs$mm, GenusPaleoIs$vv, GenusPaleoIs$nn, GenusPaleoIs$tt, MM = NULL, genpars = NULL, label = "Testudinidae body size evolution mode, Holocene-Upper Miocene, genus mean CL", reset.time=TRUE)

plot(paleoGenIs)
```



```{r "Model-fitting, genera, continental" , echo=FALSE, message=FALSE, include=FALSE}

PaleoGenIsFit <- (fit3models(paleoGenIs, silent=FALSE, method="AD", pool=FALSE))


#PaleoGenIsFit2 <- (fit4models(paleoGenIs, silent=FALSE, method="AD", pool=FALSE))

```



```{r "Model-fitting, genera, continental, table", echo=FALSE}

kable(PaleoGenIsFit, caption="Model-fitting results for testudinidae, genera, continental")


#kable(PaleoGenIsFit2, caption="Model-fitting results for testudinidae, genera, excluding insular species")


```



\newpage


## insular (excluding continental)

### genera (insular)

```{r "paleoTSI", echo=FALSE, message=FALSE, fig.cap="paleoTS plot with genus mean, insular"}

#paleoTS plot with genus mean, excluding continental species

GenusMeanCon <- PleiPlioCL %>%
  filter(EpochBins != "Modern" & Island == "y") %>%  # & EpochBins != "Upper Miocene"
  filter(!is.na(CL)) %>%
  group_by(EpochBins, Genus) %>%
 # filter(EpochBins != "Aquitanian") %>%
  summarise(meanCL = mean(CL), n=n()) %>%
#  ungroup() %>%
#  group_by(EpochBins) %>%
  summarise(mm = mean(meanCL), nn=n(), vv=var(meanCL)) %>%
  merge(BINSMio) %>%
  select(mm, nn, vv, tt=MeanBins)
  
GenusMeanCon[is.na(GenusMeanCon)]<-0



GenusModernCon <- PleiPlioCL %>%
  filter(EpochBins == "Modern" & Island == "y") %>%
  filter(!is.na(CL)) %>%
  group_by(Genus) %>%
  summarise(meanCL=mean(CL), sdCL=sd(CL), n=n(), Age=mean(Age), EpochBins=unique(EpochBins), MeanBins=unique(MeanBins)) #%>%
#  summarise(mm=mean(meanCL), nn=n(), vv=var(meanCL), tt=mean(MeanBins))

GenusModernCon[is.na(GenusModernCon)]<-0


sumTort <- read.csv("tortoises_summary.csv", sep=";", header=TRUE)
colnames(sumTort)[7] <- "meanCL"
colnames(sumTort)[8] <- "sdCL"


sumTortoisesCon <- sumTort %>%
  dplyr::filter(Island == "y") %>%
  mutate(Genus= as.character(Genus)) %>%
  mutate(MeanBins=(Mamin+Mamax)/2) %>%
  select(Genus, MeanBins,  meanCL, sdCL, n) %>% #n,
  bind_rows(GenusModernCon)


SumTortCon <- sumTortoisesCon %>%
  group_by(Genus) %>%
  mutate(tt=MeanBins, vv=sdCL^2, nn=n, mm=meanCL) %>%
  dplyr::select(mm, nn, vv, tt, Genus) %>%
  mutate(nx = nn*mm) %>%
  mutate(mmall=sum(nx)/sum(nn)) %>%
  mutate(SD=sqrt(nx), d=mm-mmall) %>%
  mutate(nsd=((nx^2+d^2)*nn)) %>%
  mutate(varall=sum(nsd)/sum(nn), n=sum(nn)) %>%
  dplyr::select(mm=mmall, vv=varall, nn=n, tt, Genus) %>%
  unique() %>%
  dplyr::select(CL=mm, n=nn, var=vv, tt, Genus)

#write.table(SumTort,file="SumTortModernGenus.txt", sep="\t", row.names = FALSE)

#kable(SumTort, caption="Overview over body size means per time bin on genus level, excluding island species.")

#boxplot(SumTort$CL, caption="Body size distribution in time bin 'modern'.")


modernMeanGenusCon <- SumTortCon %>%
  ungroup() %>%
  select(CL, n, tt) %>%
  filter( !is.na(CL)) %>%
  group_by(tt) %>%
  summarise(mm = mean(CL), vv=var(CL), nn=n())

#bis hier alle modernen taxa zusammengefasst (summarised and MFN_testudinidae)


GenusPaleoCon <- modernMeanGenusCon %>%
  bind_rows(GenusMeanCon)%>%
  arrange(tt)


GenusPaleoCon[is.na(GenusPaleoCon)]<-0

kable(GenusPaleoCon, caption="paleoTS object, insular")


paleoGenCon <-as.paleoTS(GenusPaleoCon$mm, GenusPaleoCon$vv, GenusPaleoCon$nn, GenusPaleoCon$tt, MM = NULL, genpars = NULL, label = "Testudinidae body size evolution mode, Holocene-Upper Miocene, genus mean CL, insular genera", reset.time=TRUE)

plot(paleoGenCon)
```



```{r "Model-fitting, genera, insular" , echo=FALSE, message=FALSE, include=FALSE}

PaleoGenConFit <- (fit3models(paleoGenCon, silent=FALSE, method="AD", pool=FALSE))
```



```{r "Model-fitting, genera, insular, table", echo=FALSE}

kable(PaleoGenConFit, caption="Model-fitting results for testudinidae, genera, insular")

```





\newpage
## per continent
 
### Europe, genera

```{r "paleoTSEurope", echo=FALSE, fig.cap="Genera, Europe"}

#paleoTS with different time bins, no bins, genera, Europe

GenusMeanAll <- PleiPlioCL%>%
#  merge(BINS) %>%
#  filter(EpochBins != "Modern") %>%  # & EpochBins != "Upper Miocene"
  merge(Continents) %>%
  filter(Con == "Europe") %>%
#  filter(EpochBins != "Aquitanian") %>%
  filter(!is.na(CL)) %>%
  group_by(MeanBins, Genus) %>%
  summarise(meanCL = mean(CL), n=n()) %>%
#  ungroup() %>%
#  group_by(EpochBins) %>%
  summarise(mm = mean(meanCL), nn=n(), vv=var(meanCL)) %>%
 # merge(BINS) %>%
  select(mm, nn, vv, tt=MeanBins)
  
GenusMeanAll[is.na(GenusMeanAll)]<-0



GenusPaleoAll <- GenusMeanAll

GenusPaleoAll[is.na(GenusPaleoAll)] <- 0

kable(GenusPaleoAll, caption="paleoTS object, Europe")


paleoGenAll <-as.paleoTS(GenusPaleoAll$mm, GenusPaleoAll$vv, GenusPaleoAll$nn, GenusPaleoAll$tt, MM = NULL, genpars = NULL, label = "Testudinidae body size evolution mode", reset.time=TRUE)

plot(paleoGenAll)


```

```{r "Model-fitting, genera, all, no bins, Europe" , echo=FALSE, message=FALSE, include=FALSE}

PaleoGenAllFit <- (fit3models(paleoGenAll, silent=FALSE, method="AD", pool=FALSE))

#PaleoGenAllFit2 <- (fit4models(paleoGenAll, silent=FALSE, method="AD", pool=FALSE))

```



```{r "Model-fitting, genera, all, no bins, Europe, table", echo=FALSE}

kable(PaleoGenAllFit, caption="Model-fitting results for testudinidae, genera, Europe")

```


\newpage
 
#### Europe, smaller original bins (see Table 2), genera, continental

```{r "pTSEuC", echo=FALSE, fig.cap="paleoTS, genera, Europe, continental"}

#paleoTS with different time bins, no bins, genera, Europe, continental

GenusMeanAll <- PleiPlioCL%>%
#  merge(BINS) %>%
#  filter(EpochBins != "Modern") %>%  # & EpochBins != "Upper Miocene"
  merge(Continents) %>%
  filter(Con == "Europe" & Island == "n") %>%
#  filter(EpochBins != "Aquitanian") %>%
  filter(!is.na(CL)) %>%
  group_by(MeanBins, Genus) %>%
  summarise(meanCL = mean(CL), n=n()) %>%
#  ungroup() %>%
#  group_by(EpochBins) %>%
  summarise(mm = mean(meanCL), nn=n(), vv=var(meanCL)) %>%
 # merge(BINS) %>%
  select(mm, nn, vv, tt=MeanBins)
  
GenusMeanAll[is.na(GenusMeanAll)]<-0



GenusPaleoAll <- GenusMeanAll

GenusPaleoAll[is.na(GenusPaleoAll)] <- 0

kable(GenusPaleoAll, caption="paleoTs object, Europe, continental")


paleoGenAll <-as.paleoTS(GenusPaleoAll$mm, GenusPaleoAll$vv, GenusPaleoAll$nn, GenusPaleoAll$tt, MM = NULL, genpars = NULL, label = "Testudinidae body size evolution mode", reset.time=TRUE)

plot(paleoGenAll)


```

```{r "Model-fitting, genera, all, no bins, Europe, continental" , echo=FALSE, message=FALSE, include=FALSE}

PaleoGenAllFit <- (fit3models(paleoGenAll, silent=FALSE, method="AD", pool=FALSE))

#PaleoGenAllFit2 <- (fit4models(paleoGenAll, silent=FALSE, method="AD", pool=FALSE))

```



```{r "Model-fitting, genera, all, no bins, Europe, continental, table", echo=FALSE}

kable(PaleoGenAllFit, caption="Model-fitting results for testudinidae, genera, Europe, continental")

```


\newpage
 
#### Europe, smaller original bins (see Table 2), genera, insular

```{r "pTSEuI", echo=FALSE, fig.cap="paleoTS, genera, Europe, insular"}

#paleoTS with different time bins, no bins, genera, Europe, insular


GenusMeanAll <- PleiPlioCL%>%
#  merge(BINS) %>%
#  filter(EpochBins != "Modern") %>%  # & EpochBins != "Upper Miocene"
  merge(Continents) %>%
  filter(Con == "Europe" & Island == "y") %>%
#  filter(EpochBins != "Aquitanian") %>%
  filter(!is.na(CL)) %>%
  group_by(MeanBins, Genus) %>%
  summarise(meanCL = mean(CL), n=n()) %>%
#  ungroup() %>%
#  group_by(EpochBins) %>%
  summarise(mm = mean(meanCL), nn=n(), vv=var(meanCL)) %>%
 # merge(BINS) %>%
  select(mm, nn, vv, tt=MeanBins)
  
GenusMeanAll[is.na(GenusMeanAll)]<-0



GenusPaleoAll <- GenusMeanAll

GenusPaleoAll[is.na(GenusPaleoAll)] <- 0

kable(GenusPaleoAll, caption="paleoTs object, Europe, insular")


paleoGenAll <-as.paleoTS(GenusPaleoAll$mm, GenusPaleoAll$vv, GenusPaleoAll$nn, GenusPaleoAll$tt, MM = NULL, genpars = NULL, label = "Testudinidae body size evolution mode", reset.time=TRUE)

plot(paleoGenAll)


```

```{r "Model-fitting, genera, all, no bins, Europe, insular" , echo=FALSE, message=FALSE, include=FALSE}

PaleoGenAllFit <- (fit3models(paleoGenAll, silent=FALSE, method="AD", pool=FALSE))

#PaleoGenAllFit2 <- (fit4models(paleoGenAll, silent=FALSE, method="AD", pool=FALSE))

```



```{r "Model-fitting, genera, all, no bins, Europe, insular, table", echo=FALSE}

kable(PaleoGenAllFit, caption="Model-fitting results for testudinidae, genera, Europe, insular")

```



\newpage 
### Eurasia, smaller original bins (See Table 2), genera

```{r "paleoTSEurasia", echo=FALSE, fig.cap="paleoTS, genera, Eurasia"}

#paleoTS with different time bins, no bins, genera, Eurasia

GenusMeanAll <- PleiPlioCL %>%
#  merge(BINS) %>%
#  filter(EpochBins != "Modern") %>%  # & EpochBins != "Upper Miocene"
  merge(Continents) %>%
  filter(Con == "Asia" | Con == "Europe") %>%
#  filter(EpochBins != "Aquitanian") %>%
  filter(!is.na(CL)) %>%
  group_by(MeanBins, Genus) %>%
  summarise(meanCL = mean(CL), n=n()) %>%
#  ungroup() %>%
#  group_by(EpochBins) %>%
  summarise(mm = mean(meanCL), nn=n(), vv=var(meanCL)) %>%
 # merge(BINS) %>%
  select(mm, nn, vv, tt=MeanBins)
  
GenusMeanAll[is.na(GenusMeanAll)]<-0



sumTort <- read.csv("tortoises_summary.csv", sep=";", header=TRUE)
colnames(sumTort)[7] <- "meanCL"
colnames(sumTort)[8] <- "sdCL"


sumTortoisesAll <- sumTort %>%
#  dplyr::filter(Island == "y") %>%
  merge(Continents) %>%
  filter(Con== "Asia" | Con == "Europe") %>%
  mutate(Genus= as.character(Genus)) %>%
  mutate(MeanBins=(Mamin+Mamax)/2) %>%
  select(Genus, MeanBins,  meanCL, sdCL, n) #%>% #n,
 # bind_rows(GenusMeanAll)


SumTortAll <- sumTortoisesAll %>%
  group_by(Genus) %>%
  mutate(tt=MeanBins, vv=sdCL^2, nn=n, mm=meanCL) %>%
  dplyr::select(mm, nn, vv, tt, Genus) %>%
  mutate(nx = nn*mm) %>%
  mutate(mmall=sum(nx)/sum(nn)) %>%
  mutate(SD=sqrt(nx), d=mm-mmall) %>%
  mutate(nsd=((nx^2+d^2)*nn)) %>%
  mutate(varall=sum(nsd)/sum(nn), n=sum(nn)) %>%
  dplyr::select(mm=mmall, vv=varall, nn=n, tt, Genus) %>%
  unique() %>%
  dplyr::select(CL=mm, n=nn, var=vv, tt, Genus)


modernMeanGenusAll <- SumTortAll %>%
  ungroup() %>%
  select(CL, n, tt) %>%
  filter( !is.na(CL)) %>%
  group_by(tt) %>%
  summarise(mm = mean(CL), vv=var(CL), nn=n())

#bis hier alle modernen taxa zusammengefasst (summarised and MFN_testudinidae)


GenusPaleoAll <- modernMeanGenusAll %>%
  bind_rows(GenusMeanAll)%>%
  arrange(tt)

GenusPaleoAll[is.na(GenusPaleoAll)] <- 0

kable(GenusPaleoAll, caption="paleoTS object, Eurasia")


paleoGenAll <-as.paleoTS(GenusPaleoAll$mm, GenusPaleoAll$vv, GenusPaleoAll$nn, GenusPaleoAll$tt, MM = NULL, genpars = NULL, label = "Testudinidae body size evolution mode", reset.time=TRUE)

plot(paleoGenAll)


```

```{r "Model-fitting, genera, all, no bins, Eurasia" , echo=FALSE, message=FALSE, include=FALSE}

PaleoGenAllFit <- (fit3models(paleoGenAll, silent=FALSE, method="AD", pool=FALSE))

#PaleoGenAllFit2 <- (fit9models(paleoGenAll, silent=FALSE, method="AD", pool=FALSE))

```



```{r "Model-fitting, genera, all, no bins, Eurasia, table", echo=FALSE}

kable(PaleoGenAllFit, caption="Model-fitting results for testudinidae, genera, Eurasia")

```




\newpage 
### Eurasia, smaller original bins (See Table 2), genera, continental

```{r "pTSEsC", echo=FALSE, fig.cap="paleoTS, genera, Eurasia, continental"}

# paleoTS, genera, Eurasia, continental


GenusMeanAll <- PleiPlioCL %>%
#  merge(BINS) %>%
#  filter(EpochBins != "Modern") %>%  # & EpochBins != "Upper Miocene"
  merge(Continents) %>%
  filter(Con == "Asia" | Con == "Europe" & Island == "n") %>%
 # filter(EpochBins != "Aquitanian") %>%
  filter(!is.na(CL)) %>%
  group_by(MeanBins, Genus) %>%
  summarise(meanCL = mean(CL), n=n()) %>%
#  ungroup() %>%
#  group_by(EpochBins) %>%
  summarise(mm = mean(meanCL), nn=n(), vv=var(meanCL)) %>%
 # merge(BINS) %>%
  select(mm, nn, vv, tt=MeanBins)
  
GenusMeanAll[is.na(GenusMeanAll)]<-0



sumTort <- read.csv("tortoises_summary.csv", sep=";", header=TRUE)
colnames(sumTort)[7] <- "meanCL"
colnames(sumTort)[8] <- "sdCL"


sumTortoisesAll <- sumTort %>%
#  dplyr::filter(Island == "y") %>%
  merge(Continents) %>%
  filter(Con== "Asia" | Con == "Europe") %>%
  mutate(Genus= as.character(Genus)) %>%
  mutate(MeanBins=(Mamin+Mamax)/2) %>%
  select(Genus, MeanBins,  meanCL, sdCL, n) #%>% #n,
 # bind_rows(GenusMeanAll)


SumTortAll <- sumTortoisesAll %>%
  group_by(Genus) %>%
  mutate(tt=MeanBins, vv=sdCL^2, nn=n, mm=meanCL) %>%
  dplyr::select(mm, nn, vv, tt, Genus) %>%
  mutate(nx = nn*mm) %>%
  mutate(mmall=sum(nx)/sum(nn)) %>%
  mutate(SD=sqrt(nx), d=mm-mmall) %>%
  mutate(nsd=((nx^2+d^2)*nn)) %>%
  mutate(varall=sum(nsd)/sum(nn), n=sum(nn)) %>%
  dplyr::select(mm=mmall, vv=varall, nn=n, tt, Genus) %>%
  unique() %>%
  dplyr::select(CL=mm, n=nn, var=vv, tt, Genus)


modernMeanGenusAll <- SumTortAll %>%
  ungroup() %>%
  select(CL, n, tt) %>%
  filter( !is.na(CL)) %>%
  group_by(tt) %>%
  summarise(mm = mean(CL), vv=var(CL), nn=n())

#bis hier alle modernen taxa zusammengefasst (summarised and MFN_testudinidae)


GenusPaleoAll <- modernMeanGenusAll %>%
  bind_rows(GenusMeanAll)%>%
  arrange(tt)

GenusPaleoAll[is.na(GenusPaleoAll)] <- 0

kable(GenusPaleoAll, caption="paleoTS object, Eurasia, continental")


paleoGenAll <-as.paleoTS(GenusPaleoAll$mm, GenusPaleoAll$vv, GenusPaleoAll$nn, GenusPaleoAll$tt, MM = NULL, genpars = NULL, label = "Testudinidae body size evolution mode", reset.time=TRUE)

plot(paleoGenAll)


```

```{r "Model-fitting, genera, all, no bins, continental, Eurasia" , echo=FALSE, message=FALSE, include=FALSE}

PaleoGenAllFit <- (fit3models(paleoGenAll, silent=FALSE, method="AD", pool=FALSE))

#PaleoGenAllFit2 <- (fit9models(paleoGenAll, silent=FALSE, method="AD", pool=FALSE))

```

```{r "Model-fitting, genera, all, no bins, Eurasia, continental,  table", echo=FALSE}

kable(PaleoGenAllFit, caption="Model-fitting results for testudinidae, genera, Eurasia, continental")

```



\newpage 
### Eurasia, smaller original bins (See Table 2), genera, insular

```{r "pTSEsI", echo=FALSE, fig.cap="paleoTS, genera, Eurasia, insular"}

#paleoTS with different time bins, no bins, genera, Eurasia, insular


GenusMeanAll <- PleiPlioCL %>%
#  merge(BINS) %>%
#  filter(EpochBins != "Modern") %>%  # & EpochBins != "Upper Miocene"
  merge(Continents) %>%
  filter(Con == "Asia" | Con == "Europe" & Island == "y") %>%
 # filter(EpochBins != "Aquitanian") %>%
  filter(!is.na(CL)) %>%
  group_by(MeanBins, Genus) %>%
  summarise(meanCL = mean(CL), n=n()) %>%
#  ungroup() %>%
#  group_by(EpochBins) %>%
  summarise(mm = mean(meanCL), nn=n(), vv=var(meanCL)) %>%
 # merge(BINS) %>%
  select(mm, nn, vv, tt=MeanBins)
  
GenusMeanAll[is.na(GenusMeanAll)]<-0



sumTort <- read.csv("tortoises_summary.csv", sep=";", header=TRUE)
colnames(sumTort)[7] <- "meanCL"
colnames(sumTort)[8] <- "sdCL"


sumTortoisesAll <- sumTort %>%
#  dplyr::filter(Island == "y") %>%
  merge(Continents) %>%
  filter(Con== "Asia" | Con == "Europe") %>%
  mutate(Genus= as.character(Genus)) %>%
  mutate(MeanBins=(Mamin+Mamax)/2) %>%
  select(Genus, MeanBins,  meanCL, sdCL, n) #%>% #n,
 # bind_rows(GenusMeanAll)


SumTortAll <- sumTortoisesAll %>%
  group_by(Genus) %>%
  mutate(tt=MeanBins, vv=sdCL^2, nn=n, mm=meanCL) %>%
  dplyr::select(mm, nn, vv, tt, Genus) %>%
  mutate(nx = nn*mm) %>%
  mutate(mmall=sum(nx)/sum(nn)) %>%
  mutate(SD=sqrt(nx), d=mm-mmall) %>%
  mutate(nsd=((nx^2+d^2)*nn)) %>%
  mutate(varall=sum(nsd)/sum(nn), n=sum(nn)) %>%
  dplyr::select(mm=mmall, vv=varall, nn=n, tt, Genus) %>%
  unique() %>%
  dplyr::select(CL=mm, n=nn, var=vv, tt, Genus)


modernMeanGenusAll <- SumTortAll %>%
  ungroup() %>%
  select(CL, n, tt) %>%
  filter( !is.na(CL)) %>%
  group_by(tt) %>%
  summarise(mm = mean(CL), vv=var(CL), nn=n())

#bis hier alle modernen taxa zusammengefasst (summarised and MFN_testudinidae)


GenusPaleoAll <- modernMeanGenusAll %>%
  bind_rows(GenusMeanAll)%>%
  arrange(tt)

GenusPaleoAll[is.na(GenusPaleoAll)] <- 0

kable(GenusPaleoAll, caption="paleoTS object, Eurasia, insular")


paleoGenAll <-as.paleoTS(GenusPaleoAll$mm, GenusPaleoAll$vv, GenusPaleoAll$nn, GenusPaleoAll$tt, MM = NULL, genpars = NULL, label = "Testudinidae body size evolution mode", reset.time=TRUE)

plot(paleoGenAll)


```

```{r "Model-fitting, genera, all, no bins, Eurasia, insular" , echo=FALSE, message=FALSE, include=FALSE}

PaleoGenAllFit <- (fit3models(paleoGenAll, silent=FALSE, method="AD", pool=FALSE))

#PaleoGenAllFit2 <- (fit9models(paleoGenAll, silent=FALSE, method="AD", pool=FALSE))

```


```{r "Model-fitting, genera, all, no bins, Eurasia, insular, table", echo=FALSE}

kable(PaleoGenAllFit, caption="Model-fitting results for testudinidae, genera, Eurasia, insular")

```



```{r "Data set: fossil", echo=FALSE}

TabFossil <- PleiPlioCL %>%
  merge(Continents) %>%
  select(Genus, Taxon, CL, estimated, EpochBins, Age, Island, Con)

kable(TabFossil, caption="Data set, fossil.")


colnames(Extant)[1] <- "CollNr"
colnames(Extant)[5] <- "CCL"
colnames(Extant)[6] <- "SCW"
colnames(Extant)[7] <- "CCW"
colnames(Extant)[8] <- "CH"
colnames(Extant)[13] <- "PW"

TabExtant <- Extant %>%
  merge(Continents) %>%
  select(Genus, Taxon=Species, CollNr, SCL=CL, CCL, SCW, CCW, CH, PL, PW, estimated, Island, Con, Reference)
  
kable(TabExtant, caption="Data set, extant")



```




```{r "citations", echo=FALSE, include=FALSE}
citation(package = "paleoTS", lib.loc = NULL)

```

